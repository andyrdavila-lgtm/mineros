{% extends "inicio.html" %}

{% block content %}
<!-- Barra de Navegación Contextual -->
<div class="context-nav-container">
    <!-- Pestaña de Ejes - Lateral Izquierda -->
    <div class="context-tab left-tab" id="ejes-tab">
        <div class="tab-handle" onclick="toggleEjesTab()">
            <i class="fas fa-layer-group"></i>
            <span class="tab-label">EJES</span>
        </div>
        <div class="tab-content" id="ejes-content">
            <div class="tab-header">
                <h3><i class="fas fa-bullseye"></i> EJES ESTRATÉGICOS</h3>
                <button class="tab-close" onclick="toggleEjesTab()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="ejes-grid">
                <div class="eje-card" data-eje="educacion" onclick="seleccionarEjeFormulario('educacion', 'EDUCACIÓN')">
                    <div class="eje-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="eje-info">
                        <h4>EDUCACIÓN</h4>
                        <p>Desarrollo educativo y capacitación</p>
                    </div>
                </div>
                <div class="eje-card" data-eje="salud" onclick="seleccionarEjeFormulario('salud', 'SALUD')">
                    <div class="eje-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="eje-info">
                        <h4>SALUD</h4>
                        <p>Bienestar y servicios de salud</p>
                    </div>
                </div>
                <div class="eje-card" data-eje="empleabilidad" onclick="seleccionarEjeFormulario('empleabilidad', 'EMPLEABILIDAD')">
                    <div class="eje-icon">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div class="eje-info">
                        <h4>EMPLEABILIDAD</h4>
                        <p>Oportunidades laborales</p>
                    </div>
                </div>
                <div class="eje-card" data-eje="desarrollo" onclick="seleccionarEjeFormulario('desarrollo_economico', 'DESARROLLO ECONÓMICO')">
                    <div class="eje-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="eje-info">
                        <h4>DESARROLLO ECONÓMICO</h4>
                        <p>Crecimiento económico local</p>
                    </div>
                </div>
                <div class="eje-card" data-eje="agua" onclick="seleccionarEjeFormulario('sostenibilidad_ambiental', 'SOSTENIBILIDAD AMBIENTAL (AGUA)')">
                    <div class="eje-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="eje-info">
                        <h4>SOSTENIBILIDAD AMBIENTAL</h4>
                        <p>Gestión del recurso hídrico</p>
                    </div>
                </div>
                <div class="eje-card" data-eje="comunicacion" onclick="seleccionarEjeFormulario('comunicacion', 'COMUNICACIÓN')">
                    <div class="eje-icon">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div class="eje-info">
                        <h4>COMUNICACIÓN</h4>
                        <p>Transparencia y diálogo</p>
                    </div>
                </div>
                <div class="eje-card" data-eje="institucional" onclick="seleccionarEjeFormulario('institucional', 'INSTITUCIONAL')">
                    <div class="eje-icon">
                        <i class="fas fa-landmark"></i>
                    </div>
                    <div class="eje-info">
                        <h4>INSTITUCIONAL</h4>
                        <p>Fortalecimiento institucional</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pestaña de Objetivo - Lateral Derecha -->
    <div class="context-tab right-tab" id="objetivo-tab">
        <div class="tab-handle" onclick="toggleObjetivoTab()">
            <i class="fas fa-bullseye"></i>
            <span class="tab-label">OBJETIVO</span>
        </div>
        <div class="tab-content" id="objetivo-content">
            <div class="tab-header">
                <h3><i class="fas fa-flag-checkered"></i> OBJETIVO ESTRATÉGICO</h3>
                <button class="tab-close" onclick="toggleObjetivoTab()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="objetivo-compacto">
                <div class="objetivo-resumen">
                    <h4>Proyecto El Domo</h4>
                    <p>Viabilidad y respaldo social mediante gestión integral del recurso hídrico</p>
                </div>
                <div class="objetivo-detalle">
                    <p>Consolidar la viabilidad y el respaldo social del Proyecto El Domo mediante un modelo de gestión integral que garantice la integridad y disponibilidad del recurso hídrico local, asegurando su no afectación por las actividades mineras...</p>
                    <a href="#" class="ver-mas" onclick="mostrarObjetivoCompleto()">Ver objetivo completo</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para objetivo completo -->
    <div class="modal-objetivo" id="modal-objetivo">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-flag-checkered"></i> OBJETIVO ESTRATÉGICO COMPLETO</h3>
                <button class="modal-close" onclick="cerrarModalObjetivo()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Consolidar la viabilidad y el respaldo social del Proyecto El Domo mediante un modelo de gestión integral que garantice la integridad y disponibilidad del recurso hídrico local, asegurando su no afectación por las actividades mineras, a través de la repotenciación de sistemas comunitarios y el monitoreo estricto de su calidad; este compromiso se complementa con la mejora de equipamiento en salud, la intervención en infraestructura sanitaria y lúdica de 4 unidades educativas, la reubicación estratégica de al menos el 60% del personal local hacia nuevos departamentos, y una cooperación técnica con los GADs y niveles distritales, todo dinamizado por un sistema de comunicación comunitaria que transparente la propuesta de valor y los beneficios del proyecto en el AID y AII.</p>
            </div>
        </div>
    </div>
</div>

<!-- Contenido principal -->
<div class="foda-cruzado-main-container">
    <h1 class="content-title">
        <i class="fas fa-crosshairs"></i> Análisis FODA Cruzado - Modo Combinación Múltiple
    </h1>
    
    <!-- Matriz FODA -->
    <div class="matriz-foda-section">
        <h2><i class="fas fa-th"></i> Matriz FODA</h2>
        
        <div class="matriz-container">
            <table class="matriz-foda">
                <thead>
                    <tr>
                        <th></th>
                        <th class="interno-header">
                            <i class="fas fa-home"></i> INTERNO
                        </th>
                        <th class="externo-header">
                            <i class="fas fa-external-link-alt"></i> EXTERNO
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Fila Positivo -->
                    <tr>
                        <td class="positivo-header">
                            <i class="fas fa-thumbs-up"></i> POSITIVO
                        </td>
                        <td class="fortalezas-cell">
                            <div class="celda-titulo">FORTALEZAS</div>
                            <div class="seleccion-multiple">
                                <button class="btn-seleccionar-todos" onclick="seleccionarTodos('fortalezas')">
                                    <i class="fas fa-check-double"></i> Seleccionar todos
                                </button>
                                <button class="btn-deseleccionar-todos" onclick="deseleccionarTodos('fortalezas')">
                                    <i class="fas fa-times-circle"></i> Limpiar
                                </button>
                            </div>
                            <div class="celda-lista" id="lista-fortalezas">
                                {% for aspecto in aspectos_foda_int if aspecto.tipo == 'Positivo' %}
                                <div class="actividad-item" data-id="{{ aspecto.id }}" data-tipo="fortaleza">
                                    <div class="actividad-checkbox">
                                        <input type="checkbox" id="fortaleza-{{ aspecto.id }}" 
                                               onchange="toggleElementoSeleccionado('fortaleza', {{ aspecto.id }}, `{{ aspecto.actividad }}`)">
                                    </div>
                                    <div class="actividad-texto" onclick="toggleCheckbox('fortaleza-{{ aspecto.id }}')">
                                        • {{ aspecto.actividad }}
                                    </div>
                                    <div class="actividad-acciones">
                                        <button class="btn-usar" onclick="seleccionarParaCruce('fortaleza', {{ aspecto.id }}, `{{ aspecto.actividad }}`)">
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="oportunidades-cell">
                            <div class="celda-titulo">OPORTUNIDADES</div>
                            <div class="seleccion-multiple">
                                <button class="btn-seleccionar-todos" onclick="seleccionarTodos('oportunidades')">
                                    <i class="fas fa-check-double"></i> Seleccionar todos
                                </button>
                                <button class="btn-deseleccionar-todos" onclick="deseleccionarTodos('oportunidades')">
                                    <i class="fas fa-times-circle"></i> Limpiar
                                </button>
                            </div>
                            <div class="celda-lista" id="lista-oportunidades">
                                {% for aspecto in aspectos_foda_ext if aspecto.tipo == 'Positivo' %}
                                <div class="actividad-item" data-id="{{ aspecto.id }}" data-tipo="oportunidad">
                                    <div class="actividad-checkbox">
                                        <input type="checkbox" id="oportunidad-{{ aspecto.id }}" 
                                               onchange="toggleElementoSeleccionado('oportunidad', {{ aspecto.id }}, `{{ aspecto.actividad }}`)">
                                    </div>
                                    <div class="actividad-texto" onclick="toggleCheckbox('oportunidad-{{ aspecto.id }}')">
                                        • {{ aspecto.actividad }}
                                    </div>
                                    <div class="actividad-acciones">
                                        <button class="btn-usar" onclick="seleccionarParaCruce('oportunidad', {{ aspecto.id }}, `{{ aspecto.actividad }}`)">
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                    </tr>
                    
                    <!-- Fila Negativo -->
                    <tr>
                        <td class="negativo-header">
                            <i class="fas fa-thumbs-down"></i> NEGATIVO
                        </td>
                        <td class="debilidades-cell">
                            <div class="celda-titulo">DEBILIDADES</div>
                            <div class="seleccion-multiple">
                                <button class="btn-seleccionar-todos" onclick="seleccionarTodos('debilidades')">
                                    <i class="fas fa-check-double"></i> Seleccionar todos
                                </button>
                                <button class="btn-deseleccionar-todos" onclick="deseleccionarTodos('debilidades')">
                                    <i class="fas fa-times-circle"></i> Limpiar
                                </button>
                            </div>
                            <div class="celda-lista" id="lista-debilidades">
                                {% for aspecto in aspectos_foda_int if aspecto.tipo == 'Negativo' %}
                                <div class="actividad-item" data-id="{{ aspecto.id }}" data-tipo="debilidad">
                                    <div class="actividad-checkbox">
                                        <input type="checkbox" id="debilidad-{{ aspecto.id }}" 
                                               onchange="toggleElementoSeleccionado('debilidad', {{ aspecto.id }}, `{{ aspecto.actividad }}`)">
                                    </div>
                                    <div class="actividad-texto" onclick="toggleCheckbox('debilidad-{{ aspecto.id }}')">
                                        • {{ aspecto.actividad }}
                                    </div>
                                    <div class="actividad-acciones">
                                        <button class="btn-usar" onclick="seleccionarParaCruce('debilidad', {{ aspecto.id }}, `{{ aspecto.actividad }}`)">
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="amenazas-cell">
                            <div class="celda-titulo">AMENAZAS</div>
                            <div class="seleccion-multiple">
                                <button class="btn-seleccionar-todos" onclick="seleccionarTodos('amenazas')">
                                    <i class="fas fa-check-double"></i> Seleccionar todos
                                </button>
                                <button class="btn-deseleccionar-todos" onclick="deseleccionarTodos('amenazas')">
                                    <i class="fas fa-times-circle"></i> Limpiar
                                </button>
                            </div>
                            <div class="celda-lista" id="lista-amenazas">
                                {% for aspecto in aspectos_foda_ext if aspecto.tipo == 'Negativo' %}
                                <div class="actividad-item" data-id="{{ aspecto.id }}" data-tipo="amenaza">
                                    <div class="actividad-checkbox">
                                        <input type="checkbox" id="amenaza-{{ aspecto.id }}" 
                                               onchange="toggleElementoSeleccionado('amenaza', {{ aspecto.id }}, `{{ aspecto.actividad }}`)">
                                    </div>
                                    <div class="actividad-texto" onclick="toggleCheckbox('amenaza-{{ aspecto.id }}')">
                                        • {{ aspecto.actividad }}
                                    </div>
                                    <div class="actividad-acciones">
                                        <button class="btn-usar" onclick="seleccionarParaCruce('amenaza', {{ aspecto.id }}, `{{ aspecto.actividad }}`)">
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Formulario de Cruce FODA -->
    <div class="cruce-foda-section">
        <h2><i class="fas fa-cogs"></i> Generar Estrategias FODA Cruzado - Combinación Múltiple</h2>
        
        <div class="cruce-container">
            <div class="cruce-opciones">
                <!-- Selección de Tipo de Cruce -->
                <div class="cruce-tipo-selector">
                    <h3><i class="fas fa-random"></i> Tipo de Cruce</h3>
                    <div class="tipo-cruce-options">
                        <button class="cruce-option selected" data-tipo="fo" onclick="seleccionarTipoCruce('fo')">
                            <span class="cruce-label">FO</span>
                            <span class="cruce-desc">Fortaleza + Oportunidad</span>
                        </button>
                        <button class="cruce-option" data-tipo="do" onclick="seleccionarTipoCruce('do')">
                            <span class="cruce-label">DO</span>
                            <span class="cruce-desc">Debilidad + Oportunidad</span>
                        </button>
                        <button class="cruce-option" data-tipo="fa" onclick="seleccionarTipoCruce('fa')">
                            <span class="cruce-label">FA</span>
                            <span class="cruce-desc">Fortaleza + Amenaza</span>
                        </button>
                        <button class="cruce-option" data-tipo="da" onclick="seleccionarTipoCruce('da')">
                            <span class="cruce-label">DA</span>
                            <span class="cruce-desc">Debilidad + Amenaza</span>
                        </button>
                    </div>
                </div>
                
                <!-- Formulario de Cruce -->
                <div class="cruce-form">
                    <h3><i class="fas fa-exchange-alt"></i> Combinar Elementos Múltiples</h3>
                    
                    <!-- Panel de Elementos Seleccionados -->
                    <div class="panel-elementos">
                        <div class="elementos-columna">
                            <h4><i class="fas fa-home"></i> Elementos Internos Seleccionados</h4>
                            <div class="elementos-lista" id="panel-internos">
                                <div class="elemento-vacio">
                                    <i class="fas fa-info-circle"></i>
                                    <p>No hay elementos internos seleccionados</p>
                                </div>
                            </div>
                            <div class="elementos-estadistica">
                                <span id="contador-internos">0</span> elementos seleccionados
                            </div>
                        </div>
                        
                        <div class="elementos-columna">
                            <h4><i class="fas fa-external-link-alt"></i> Elementos Externos Seleccionados</h4>
                            <div class="elementos-lista" id="panel-externos">
                                <div class="elemento-vacio">
                                    <i class="fas fa-info-circle"></i>
                                    <p>No hay elementos externos seleccionados</p>
                                </div>
                            </div>
                            <div class="elementos-estadistica">
                                <span id="contador-externos">0</span> elementos seleccionados
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estadísticas de combinación -->
                    <div class="combinacion-estadisticas">
                        <div class="estadistica-combinacion">
                            <i class="fas fa-project-diagram"></i>
                            <div class="estadistica-info">
                                <span class="estadistica-valor" id="combinaciones-posibles">0</span>
                                <span class="estadistica-label">Combinaciones posibles</span>
                            </div>
                        </div>
                        <div class="estadistica-combinacion">
                            <i class="fas fa-sitemap"></i>
                            <div class="estadistica-info">
                                <span class="estadistica-valor" id="tipo-cruce-actual">FO</span>
                                <span class="estadistica-label">Tipo de cruce</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Nuevo campo: Selección de Eje Estratégico -->
                    <div class="form-group">
                        <label for="eje-estrategico">
                            <i class="fas fa-bullseye"></i> Eje Estratégico
                        </label>
                        <div class="eje-selector-container">
                            <select id="eje-estrategico" class="form-select" onchange="actualizarEjeSeleccionado()">
                                <option value="">Seleccione un eje</option>
                                <option value="educacion">EDUCACIÓN</option>
                                <option value="salud">SALUD</option>
                                <option value="empleabilidad">EMPLEABILIDAD</option>
                                <option value="desarrollo_economico">DESARROLLO ECONÓMICO</option>
                                <option value="sostenibilidad_ambiental">SOSTENIBILIDAD AMBIENTAL (AGUA)</option>
                                <option value="comunicacion">COMUNICACIÓN</option>
                                <option value="institucional">INSTITUCIONAL</option>
                            </select>
                            <div class="eje-actions">
                                <button type="button" class="btn-eje-rapido" onclick="seleccionarEjeActual()" title="Seleccionar eje activo">
                                    <i class="fas fa-bolt"></i>
                                </button>
                                <button type="button" class="btn-eje-limpiar" onclick="limpiarEjeSeleccionado()" title="Limpiar selección">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="eje-seleccionado" id="eje-seleccionado-info">
                            <div class="eje-badge" id="badge-eje">
                                <i class="fas fa-layer-group"></i>
                                <span id="eje-texto">Ningún eje seleccionado</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Opciones de combinación múltiple -->
                    <div class="combinacion-opciones">
                        <h4><i class="fas fa-sliders-h"></i> Opciones de Combinación</h4>
                        <div class="opciones-grid">
                            <div class="opcion-checkbox">
                                <input type="checkbox" id="generar-todas-combinaciones" checked>
                                <label for="generar-todas-combinaciones">
                                    Generar todas las combinaciones posibles
                                </label>
                            </div>
                            <div class="opcion-checkbox">
                                <input type="checkbox" id="estrategia-global" checked>
                                <label for="estrategia-global">
                                    Crear estrategia global única
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="estrategia">
                            <i class="fas fa-lightbulb"></i> Estrategia Resultante
                        </label>
                        <textarea id="estrategia" class="form-textarea" 
                                  placeholder="Describa la estrategia resultante de la combinación múltiple..." 
                                  rows="6"></textarea>
                        <div class="estrategia-guia" id="guia-estrategia">
                            <strong>Guía:</strong> <span id="texto-guia">¿Cómo usar las fortalezas para aprovechar las oportunidades? (Combinación múltiple)</span>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn-guardar" onclick="guardarEstrategiaMultiple()">
                            <i class="fas fa-save"></i> Guardar Estrategia Múltiple
                        </button>
                        <button class="btn-limpiar" onclick="limpiarSelecciones()">
                            <i class="fas fa-eraser"></i> Limpiar Selecciones
                        </button>
                        <button class="btn-generar" onclick="generarEstrategiaAutomatica()">
                            <i class="fas fa-robot"></i> Generar Automáticamente
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Estrategias Guardadas -->
            <div class="estrategias-guardadas">
                <h3><i class="fas fa-list-check"></i> Estrategias Generadas</h3>
                
                <div class="filtros-estrategias">
                    <div class="filtros-row">
                        <select id="filtro-tipo-estrategia" class="filtro-select" onchange="filtrarEstrategias()">
                            <option value="all">Todas las estrategias</option>
                            <option value="FO">FO - Fortaleza + Oportunidad</option>
                            <option value="DO">DO - Debilidad + Oportunidad</option>
                            <option value="FA">FA - Fortaleza + Amenaza</option>
                            <option value="DA">DA - Debilidad + Amenaza</option>
                        </select>
                        <select id="filtro-eje-estrategia" class="filtro-select" onchange="filtrarEstrategias()">
                            <option value="all">Todos los ejes</option>
                            <option value="educacion">EDUCACIÓN</option>
                            <option value="salud">SALUD</option>
                            <option value="empleabilidad">EMPLEABILIDAD</option>
                            <option value="desarrollo_economico">DESARROLLO ECONÓMICO</option>
                            <option value="sostenibilidad_ambiental">SOSTENIBILIDAD AMBIENTAL (AGUA)</option>
                            <option value="comunicacion">COMUNICACIÓN</option>
                            <option value="institucional">INSTITUCIONAL</option>
                        </select>
                        <select id="filtro-combinacion" class="filtro-select" onchange="filtrarEstrategias()">
                            <option value="all">Todas las combinaciones</option>
                            <option value="simple">Combinaciones simples</option>
                            <option value="multiple">Combinaciones múltiples</option>
                        </select>
                    </div>
                </div>
                
                <div class="lista-estrategias" id="lista-estrategias">
                    <div class="estrategia-empty">
                        <i class="fas fa-inbox"></i>
                        <p>No hay estrategias guardadas todavía.</p>
                        <p>Comience a crear estrategias usando el formulario.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estadísticas -->
    <div class="estadisticas-section">
        <h2><i class="fas fa-chart-pie"></i> Estadísticas FODA - Modo Combinación Múltiple</h2>
        <div class="estadisticas-grid">
            <div class="estadistica-card fortalezas">
                <div class="estadistica-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="estadistica-content">
                    <h3>Fortalezas</h3>
                    <div class="estadistica-valor" id="contador-fortalezas">
                        {{ aspectos_foda_int|selectattr('tipo', 'equalto', 'Positivo')|list|length }}
                    </div>
                    <div class="estadistica-seleccionadas">
                        <span id="fortalezas-seleccionadas">0</span> seleccionadas
                    </div>
                </div>
            </div>
            
            <div class="estadistica-card debilidades">
                <div class="estadistica-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="estadistica-content">
                    <h3>Debilidades</h3>
                    <div class="estadistica-valor" id="contador-debilidades">
                        {{ aspectos_foda_int|selectattr('tipo', 'equalto', 'Negativo')|list|length }}
                    </div>
                    <div class="estadistica-seleccionadas">
                        <span id="debilidades-seleccionadas">0</span> seleccionadas
                    </div>
                </div>
            </div>
            
            <div class="estadistica-card oportunidades">
                <div class="estadistica-icon">
                    <i class="fas fa-bullseye"></i>
                </div>
                <div class="estadistica-content">
                    <h3>Oportunidades</h3>
                    <div class="estadistica-valor" id="contador-oportunidades">
                        {{ aspectos_foda_ext|selectattr('tipo', 'equalto', 'Positivo')|list|length }}
                    </div>
                    <div class="estadistica-seleccionadas">
                        <span id="oportunidades-seleccionadas">0</span> seleccionadas
                    </div>
                </div>
            </div>
            
            <div class="estadistica-card amenazas">
                <div class="estadistica-icon">
                    <i class="fas fa-skull-crossbones"></i>
                </div>
                <div class="estadistica-content">
                    <h3>Amenazas</h3>
                    <div class="estadistica-valor" id="contador-amenazas">
                        {{ aspectos_foda_ext|selectattr('tipo', 'equalto', 'Negativo')|list|length }}
                    </div>
                    <div class="estadistica-seleccionadas">
                        <span id="amenazas-seleccionadas">0</span> seleccionadas
                    </div>
                </div>
            </div>
            
            <div class="estadistica-card estrategias">
                <div class="estadistica-icon">
                    <i class="fas fa-chess-board"></i>
                </div>
                <div class="estadistica-content">
                    <h3>Estrategias</h3>
                    <div class="estadistica-valor" id="contador-estrategias">0</div>
                    <div class="estadistica-subinfo">
                        <span id="estrategias-multiples">0</span> múltiples
                    </div>
                </div>
            </div>
            
            <div class="estadistica-card cruces">
                <div class="estadistica-icon">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <div class="estadistica-content">
                    <h3>Combinaciones Activas</h3>
                    <div class="estadistica-valor" id="combinaciones-activas">0</div>
                    <div class="estadistica-subinfo" id="relacion-activa">0x0</div>
                </div>
            </div>
            
            <div class="estadistica-card eje-actual">
                <div class="estadistica-icon">
                    <i class="fas fa-bullseye"></i>
                </div>
                <div class="estadistica-content">
                    <h3>Eje Actual</h3>
                    <div class="estadistica-valor" id="eje-actual-nombre">-</div>
                    <div class="estadistica-subinfo">
                        <span id="estrategias-eje">0</span> estrategias
                    </div>
                </div>
            </div>
            
            <div class="estadistica-card productividad">
                <div class="estadistica-icon">
                    <i class="fas fa-rocket"></i>
                </div>
                <div class="estadistica-content">
                    <h3>Productividad</h3>
                    <div class="estadistica-valor" id="eficiencia-cruce">0%</div>
                    <div class="estadistica-subinfo">
                        <span id="ratio-cruce">0.0x</span> más eficiente
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos para la selección múltiple */
    .seleccion-multiple {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
    }
    
    .btn-seleccionar-todos, .btn-deseleccionar-todos {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
        flex: 1;
        justify-content: center;
    }
    
    .btn-seleccionar-todos {
        background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%);
        color: white;
    }
    
    .btn-seleccionar-todos:hover {
        background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        transform: translateY(-2px);
    }
    
    .btn-deseleccionar-todos {
        background: linear-gradient(135deg, #ff6b6b 0%, #c62828 100%);
        color: white;
    }
    
    .btn-deseleccionar-todos:hover {
        background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
        transform: translateY(-2px);
    }
    
    .actividad-checkbox {
        margin-right: 10px;
    }
    
    .actividad-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #4a69bd;
    }
    
    .actividad-texto {
        flex: 1;
        font-size: 13px;
        color: #333;
        cursor: pointer;
        padding: 5px 0;
    }
    
    .actividad-texto:hover {
        color: #0c2461;
    }
    
    /* Panel de elementos seleccionados */
    .panel-elementos {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
        .panel-elementos {
            grid-template-columns: 1fr;
        }
    }
    
    .elementos-columna {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        border: 1px solid #e9ecef;
    }
    
    .elementos-columna h4 {
        color: #0c2461;
        margin: 0 0 15px 0;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        padding-bottom: 10px;
        border-bottom: 2px solid rgba(12, 36, 97, 0.1);
    }
    
    .elementos-lista {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 10px;
        padding-right: 5px;
    }
    
    .elemento-seleccionado {
        background: white;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        border-left: 4px solid #4a69bd;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .elemento-seleccionado.interno {
        border-left-color: #4CAF50;
    }
    
    .elemento-seleccionado.externo {
        border-left-color: #0c2461;
    }
    
    .elemento-texto {
        flex: 1;
        font-size: 12px;
        color: #333;
        line-height: 1.4;
    }
    
    .elemento-remover {
        background: #ff6b6b;
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        transition: all 0.3s;
        margin-left: 10px;
        flex-shrink: 0;
    }
    
    .elemento-remover:hover {
        background: #c62828;
        transform: rotate(90deg);
    }
    
    .elemento-vacio {
        text-align: center;
        padding: 20px;
        color: #666;
    }
    
    .elemento-vacio i {
        font-size: 24px;
        margin-bottom: 10px;
        color: #dee2e6;
    }
    
    .elemento-vacio p {
        margin: 0;
        font-size: 12px;
    }
    
    .elementos-estadistica {
        text-align: center;
        padding: 8px;
        background: rgba(12, 36, 97, 0.05);
        border-radius: 4px;
        font-size: 12px;
        color: #0c2461;
        font-weight: 600;
    }
    
    /* Estadísticas de combinación */
    .combinacion-estadisticas {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .estadistica-combinacion {
        display: flex;
        align-items: center;
        padding: 15px;
        background: linear-gradient(135deg, rgba(12, 36, 97, 0.05) 0%, rgba(30, 55, 153, 0.05) 100%);
        border-radius: 8px;
        border: 1px solid rgba(12, 36, 97, 0.1);
    }
    
    .estadistica-combinacion i {
        font-size: 24px;
        color: #0c2461;
        margin-right: 15px;
        width: 40px;
        text-align: center;
    }
    
    .estadistica-info {
        flex: 1;
    }
    
    .estadistica-valor {
        display: block;
        font-size: 24px;
        font-weight: bold;
        color: #0c2461;
        line-height: 1;
    }
    
    .estadistica-label {
        font-size: 11px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Opciones de combinación */
    .combinacion-opciones {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }
    
    .combinacion-opciones h4 {
        color: #0c2461;
        margin: 0 0 15px 0;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .opciones-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    @media (max-width: 768px) {
        .opciones-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .opcion-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .opcion-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #4a69bd;
    }
    
    .opcion-checkbox label {
        font-size: 13px;
        color: #333;
        cursor: pointer;
        flex: 1;
    }
    
    /* Botones adicionales */
    .btn-generar {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        font-size: 14px;
        flex: 1;
        justify-content: center;
        background: linear-gradient(135deg, #9C27B0 0%, #7b1fa2 100%);
        color: white;
        box-shadow: 0 2px 6px rgba(156, 39, 176, 0.2);
    }
    
    .btn-generar:hover {
        background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
    }
    
    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 25px;
    }
    
    @media (max-width: 768px) {
        .form-actions {
            flex-direction: column;
        }
    }
    
    /* Estadísticas mejoradas */
    .estadistica-seleccionadas, .estadistica-subinfo {
        font-size: 11px;
        color: #666;
        margin-top: 5px;
    }
    
    .estadistica-card .estadistica-content {
        position: relative;
    }
    
    /* Filtro adicional */
    .filtros-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    @media (max-width: 992px) {
        .filtros-row {
            grid-template-columns: 1fr 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .filtros-row {
            grid-template-columns: 1fr;
        }
    }
    
    /* Estrategias con múltiples elementos */
    .estrategia-multiples {
        position: relative;
        border-left: 6px solid #9C27B0 !important;
    }
    
    .badge-multiple {
        background: linear-gradient(135deg, #9C27B0 0%, #7b1fa2 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        margin-left: 8px;
    }
    
    /* Notificaciones mejoradas */
    .notificacion-combinacion {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        max-width: 300px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }
    
    .notificacion-combinacion.show {
        transform: translateX(0);
    }
    
    .notificacion-titulo {
        font-weight: 600;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .notificacion-desc {
        font-size: 12px;
        opacity: 0.9;
    }
    
    /* Animaciones para elementos seleccionados */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .elemento-seleccionado.pulse {
        animation: pulse 0.3s ease;
    }
    
    /* Scrollbar mejorada para paneles */
    .elementos-lista::-webkit-scrollbar {
        width: 6px;
    }
    
    .elementos-lista::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .elementos-lista::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    
    .elementos-lista::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .panel-elementos {
            grid-template-columns: 1fr;
        }
        
        .combinacion-estadisticas {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .content-title {
            font-size: 20px;
        }
        
        .seleccion-multiple {
            flex-direction: column;
        }
        
        .btn-seleccionar-todos,
        .btn-deseleccionar-todos {
            width: 100%;
        }
    }

        /* Estilos para los nuevos elementos de selección múltiple */

    .elementos-columna {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        border: 1px solid #e9ecef;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .elementos-lista {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 10px;
        padding-right: 5px;
        flex-grow: 1;
    }

    .elemento-seleccionado {
        background: white;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        border-left: 4px solid #4a69bd;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .elemento-seleccionado.interno {
        border-left-color: #4CAF50;
    }

    .elemento-seleccionado.externo {
        border-left-color: #0c2461;
    }

    .elemento-texto {
        flex: 1;
        font-size: 12px;
        color: #333;
        line-height: 1.4;
        margin-right: 10px;
    }

    .elemento-remover {
        background: #ff6b6b;
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        transition: all 0.3s;
        flex-shrink: 0;
    }

    .elemento-remover:hover {
        background: #c62828;
        transform: rotate(90deg);
    }

    .elemento-vacio {
        text-align: center;
        padding: 20px;
        color: #666;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .elemento-vacio i {
        font-size: 24px;
        margin-bottom: 10px;
        color: #dee2e6;
    }

    .elemento-vacio p {
        margin: 0;
        font-size: 12px;
        line-height: 1.4;
    }

    .elementos-estadistica {
        text-align: center;
        padding: 8px;
        background: rgba(12, 36, 97, 0.05);
        border-radius: 4px;
        font-size: 12px;
        color: #0c2461;
        font-weight: 600;
        margin-top: auto;
    }

    /* Estadísticas de combinación */
    .combinacion-estadisticas {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .estadistica-combinacion {
        display: flex;
        align-items: center;
        padding: 15px;
        background: linear-gradient(135deg, rgba(12, 36, 97, 0.05) 0%, rgba(30, 55, 153, 0.05) 100%);
        border-radius: 8px;
        border: 1px solid rgba(12, 36, 97, 0.1);
    }

    .estadistica-combinacion i {
        font-size: 24px;
        color: #0c2461;
        margin-right: 15px;
        width: 40px;
        text-align: center;
    }

    .estadistica-info {
        flex: 1;
    }

    .estadistica-valor {
        display: block;
        font-size: 24px;
        font-weight: bold;
        color: #0c2461;
        line-height: 1;
    }

    .estadistica-label {
        font-size: 11px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 4px;
    }

    /* Opciones de combinación */
    .combinacion-opciones {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }

    .combinacion-opciones h4 {
        color: #0c2461;
        margin: 0 0 15px 0;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .opciones-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    @media (max-width: 768px) {
        .opciones-grid {
            grid-template-columns: 1fr;
        }
    }

    .opcion-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .opcion-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #4a69bd;
    }

    .opcion-checkbox label {
        font-size: 13px;
        color: #333;
        cursor: pointer;
        flex: 1;
    }

    /* Estilos para elementos dinámicos en estrategias */
    .estrategia-tipo-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .badge-combinacion {
        background: linear-gradient(135deg, #9C27B0 0%, #7b1fa2 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        margin-left: 8px;
    }

    .elementos-grupo {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 8px;
    }

    .elementos-titulo {
        font-size: 11px;
        color: #666;
        font-weight: 600;
        width: 100%;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Notificaciones */
    .notificacion-combinacion {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        max-width: 300px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .notificacion-combinacion.show {
        transform: translateX(0);
    }

    .notificacion-titulo {
        font-weight: 600;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .notificacion-desc {
        font-size: 12px;
        opacity: 0.9;
        line-height: 1.4;
    }

    /* Ajustes para los botones de acción */
    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 25px;
    }

    @media (max-width: 768px) {
        .form-actions {
            flex-direction: column;
        }
    }

    .btn-generar {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        font-size: 14px;
        flex: 1;
        justify-content: center;
        background: linear-gradient(135deg, #9C27B0 0%, #7b1fa2 100%);
        color: white;
        box-shadow: 0 2px 6px rgba(156, 39, 176, 0.2);
    }

    .btn-generar:hover {
        background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
    }

    /* Ajustes para los filtros */
    .filtros-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    @media (max-width: 992px) {
        .filtros-row {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .filtros-row {
            grid-template-columns: 1fr;
        }
    }

    /* Ajustes para las estadísticas */
    .estadistica-seleccionadas, .estadistica-subinfo {
        font-size: 11px;
        color: #666;
        margin-top: 5px;
    }

    .estadistica-card .estadistica-content {
        position: relative;
    }

    /* Ajustes para el panel de elementos */
    .panel-elementos {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .panel-elementos {
            grid-template-columns: 1fr;
        }
    }

    /* Ajustes para los checkboxes en la matriz */
    .actividad-checkbox {
        margin-right: 10px;
        display: flex;
        align-items: center;
    }

    .actividad-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #4a69bd;
    }

    .actividad-texto {
        flex: 1;
        font-size: 13px;
        color: #333;
        cursor: pointer;
        padding: 5px 0;
    }

    .actividad-item.selected {
        background: linear-gradient(135deg, rgba(12, 36, 97, 0.1) 0%, rgba(30, 55, 153, 0.1) 100%);
        border-left-width: 6px;
    }

    .fortalezas-cell .actividad-item.selected {
        border-left-color: #4CAF50;
    }

    .debilidades-cell .actividad-item.selected {
        border-left-color: #ff6b6b;
    }

    .oportunidades-cell .actividad-item.selected {
        border-left-color: #0c2461;
    }

    .amenazas-cell .actividad-item.selected {
        border-left-color: #4a69bd;
    }

    /* Ajustes para los botones de selección múltiple en la matriz */
    .seleccion-multiple {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
    }

    .btn-seleccionar-todos, .btn-deseleccionar-todos {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
        flex: 1;
        justify-content: center;
    }

    .btn-seleccionar-todos {
        background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%);
        color: white;
    }

    .btn-seleccionar-todos:hover {
        background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        transform: translateY(-2px);
    }

    .btn-deseleccionar-todos {
        background: linear-gradient(135deg, #ff6b6b 0%, #c62828 100%);
        color: white;
    }

    .btn-deseleccionar-todos:hover {
        background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
        transform: translateY(-2px);
    }

    /* Animación para elementos seleccionados */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .elemento-seleccionado.pulse {
        animation: pulse 0.3s ease;
    }

    /* Scrollbar para los paneles */
    .elementos-lista::-webkit-scrollbar {
        width: 6px;
    }

    .elementos-lista::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .elementos-lista::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .elementos-lista::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
    }
    
    /* Estados de selección */
    .actividad-item.selected {
        background: linear-gradient(135deg, rgba(12, 36, 97, 0.1) 0%, rgba(30, 55, 153, 0.1) 100%);
        border-left-width: 6px !important;
    }
    
    .fortalezas-cell .actividad-item.selected {
        border-left-color: #4CAF50 !important;
    }
    
    .debilidades-cell .actividad-item.selected {
        border-left-color: #ff6b6b !important;
    }
    
    .oportunidades-cell .actividad-item.selected {
        border-left-color: #0c2461 !important;
    }
    
    .amenazas-cell .actividad-item.selected {
        border-left-color: #4a69bd !important;
    }
</style>

<script>
    // Variables globales
    let tipoCruceActual = 'fo';
    let elementosInternos = [];
    let elementosExternos = [];
    let estrategiasGuardadas = [];
    let ejesTabAbierta = false;
    let objetivoTabAbierta = false;
    let ejeSeleccionado = null;
    let ejeSeleccionadoTexto = '';
    let ejeActivo = null;
    
    // Inicializar al cargar
    document.addEventListener('DOMContentLoaded', function() {
        cargarEstrategias();
        actualizarEstadisticas();
        actualizarEjeSeleccionado();
        
        // Agregar interactividad a los ejes en la pestaña
        document.querySelectorAll('.eje-card').forEach(card => {
            card.addEventListener('click', function(e) {
                if (!e.target.closest('.eje-card')?.hasAttribute('onclick')) {
                    document.querySelectorAll('.eje-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    
                    const eje = this.getAttribute('data-eje');
                    const nombre = this.querySelector('h4').textContent;
                    ejeActivo = { id: eje, nombre: nombre };
                    
                    document.getElementById('eje-actual-nombre').textContent = nombre;
                    localStorage.setItem('ejeActivo', JSON.stringify(ejeActivo));
                    
                    mostrarNotificacion(`✅ Eje activo: ${nombre}`, 'info');
                }
            });
        });
        
        // Cerrar pestañas al hacer clic fuera
        document.addEventListener('click', function(e) {
            const ejesTab = document.getElementById('ejes-tab');
            const objetivoTab = document.getElementById('objetivo-tab');
            
            if (!ejesTab.contains(e.target) && !e.target.closest('.tab-handle')) {
                cerrarEjesTab();
            }
            
            if (!objetivoTab.contains(e.target) && !e.target.closest('.tab-handle')) {
                cerrarObjetivoTab();
            }
        });
        
        // Atajos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cerrarEjesTab();
                cerrarObjetivoTab();
                cerrarModalObjetivo();
            }
            
            if (e.altKey && e.key === 'e') {
                e.preventDefault();
                toggleEjesTab();
            }
            
            if (e.altKey && e.key === 'o') {
                e.preventDefault();
                toggleObjetivoTab();
            }
            
            // Ctrl+Enter para guardar
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                guardarEstrategiaMultiple();
            }
        });
        
        // Cargar eje activo desde localStorage si existe
        const ejeGuardado = localStorage.getItem('ejeActivo');
        if (ejeGuardado) {
            try {
                ejeActivo = JSON.parse(ejeGuardado);
                document.getElementById('eje-actual-nombre').textContent = ejeActivo.nombre;
            } catch (e) {
                console.error('Error al cargar eje activo:', e);
            }
        }
    });
    
    // Funciones para manejar selección múltiple
    function toggleCheckbox(id) {
        const checkbox = document.getElementById(id);
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change'));
    }
    
    function toggleElementoSeleccionado(tipo, id, texto) {
        const checkbox = document.getElementById(`${tipo}-${id}`);
        const item = checkbox.closest('.actividad-item');
        
        if (checkbox.checked) {
            // Agregar elemento
            const elemento = { id, tipo, texto };
            
            if (tipo === 'fortaleza' || tipo === 'debilidad') {
                if (!elementosInternos.some(e => e.id === id)) {
                    elementosInternos.push(elemento);
                    item.classList.add('selected');
                }
            } else {
                if (!elementosExternos.some(e => e.id === id)) {
                    elementosExternos.push(elemento);
                    item.classList.add('selected');
                }
            }
        } else {
            // Remover elemento
            if (tipo === 'fortaleza' || tipo === 'debilidad') {
                elementosInternos = elementosInternos.filter(e => e.id !== id);
                item.classList.remove('selected');
            } else {
                elementosExternos = elementosExternos.filter(e => e.id !== id);
                item.classList.remove('selected');
            }
        }
        
        actualizarPanelesSeleccion();
        actualizarEstadisticas();
        validarSelecciones();
        
        if (checkbox.checked) {
            mostrarNotificacionCombinacion(`✅ ${texto.substring(0, 50)}... agregado`);
        }
    }
    
    function seleccionarParaCruce(tipo, id, texto) {
        const checkbox = document.getElementById(`${tipo}-${id}`);
        if (!checkbox.checked) {
            checkbox.checked = true;
            toggleElementoSeleccionado(tipo, id, texto);
        }
    }
    
    function seleccionarTodos(tipo) {
        let checkboxes;
        let elementosTipo;
        
        switch(tipo) {
            case 'fortalezas':
                checkboxes = document.querySelectorAll('#lista-fortalezas input[type="checkbox"]');
                elementosTipo = 'fortaleza';
                break;
            case 'debilidades':
                checkboxes = document.querySelectorAll('#lista-debilidades input[type="checkbox"]');
                elementosTipo = 'debilidad';
                break;
            case 'oportunidades':
                checkboxes = document.querySelectorAll('#lista-oportunidades input[type="checkbox"]');
                elementosTipo = 'oportunidad';
                break;
            case 'amenazas':
                checkboxes = document.querySelectorAll('#lista-amenazas input[type="checkbox"]');
                elementosTipo = 'amenaza';
                break;
        }
        
        checkboxes.forEach(checkbox => {
            if (!checkbox.checked) {
                checkbox.checked = true;
                const id = checkbox.id.split('-')[1];
                const item = checkbox.closest('.actividad-item');
                const texto = item.querySelector('.actividad-texto').textContent.replace('• ', '');
                
                const elemento = { 
                    id: parseInt(id), 
                    tipo: elementosTipo, 
                    texto: texto 
                };
                
                if (elementosTipo === 'fortaleza' || elementosTipo === 'debilidad') {
                    if (!elementosInternos.some(e => e.id === parseInt(id))) {
                        elementosInternos.push(elemento);
                        item.classList.add('selected');
                    }
                } else {
                    if (!elementosExternos.some(e => e.id === parseInt(id))) {
                        elementosExternos.push(elemento);
                        item.classList.add('selected');
                    }
                }
            }
        });
        
        actualizarPanelesSeleccion();
        actualizarEstadisticas();
        mostrarNotificacionCombinacion(`✅ Todos los elementos de ${tipo} seleccionados`);
    }
    
    function deseleccionarTodos(tipo) {
        let checkboxes;
        let elementosTipo;
        
        switch(tipo) {
            case 'fortalezas':
                checkboxes = document.querySelectorAll('#lista-fortalezas input[type="checkbox"]');
                elementosTipo = 'fortaleza';
                break;
            case 'debilidades':
                checkboxes = document.querySelectorAll('#lista-debilidades input[type="checkbox"]');
                elementosTipo = 'debilidad';
                break;
            case 'oportunidades':
                checkboxes = document.querySelectorAll('#lista-oportunidades input[type="checkbox"]');
                elementosTipo = 'oportunidad';
                break;
            case 'amenazas':
                checkboxes = document.querySelectorAll('#lista-amenazas input[type="checkbox"]');
                elementosTipo = 'amenaza';
                break;
        }
        
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                checkbox.checked = false;
                const id = checkbox.id.split('-')[1];
                const item = checkbox.closest('.actividad-item');
                
                if (elementosTipo === 'fortaleza' || elementosTipo === 'debilidad') {
                    elementosInternos = elementosInternos.filter(e => e.id !== parseInt(id));
                    item.classList.remove('selected');
                } else {
                    elementosExternos = elementosExternos.filter(e => e.id !== parseInt(id));
                    item.classList.remove('selected');
                }
            }
        });
        
        actualizarPanelesSeleccion();
        actualizarEstadisticas();
        mostrarNotificacionCombinacion(`❌ Selección de ${tipo} limpiada`);
    }
    
    function actualizarPanelesSeleccion() {
        const panelInternos = document.getElementById('panel-internos');
        const panelExternos = document.getElementById('panel-externos');
        const contadorInternos = document.getElementById('contador-internos');
        const contadorExternos = document.getElementById('contador-externos');
        
        // Actualizar contadores
        contadorInternos.textContent = elementosInternos.length;
        contadorExternos.textContent = elementosExternos.length;
        
        // Actualizar panel internos
        if (elementosInternos.length === 0) {
            panelInternos.innerHTML = `
                <div class="elemento-vacio">
                    <i class="fas fa-info-circle"></i>
                    <p>No hay elementos internos seleccionados</p>
                </div>
            `;
        } else {
            panelInternos.innerHTML = '';
            elementosInternos.forEach(elemento => {
                const div = document.createElement('div');
                div.className = 'elemento-seleccionado interno pulse';
                div.innerHTML = `
                    <div class="elemento-texto">• ${elemento.texto.substring(0, 80)}${elemento.texto.length > 80 ? '...' : ''}</div>
                    <button class="elemento-remover" onclick="removerElementoSeleccionado('interno', ${elemento.id})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                panelInternos.appendChild(div);
                
                // Remover animación después de completarla
                setTimeout(() => div.classList.remove('pulse'), 300);
            });
        }
        
        // Actualizar panel externos
        if (elementosExternos.length === 0) {
            panelExternos.innerHTML = `
                <div class="elemento-vacio">
                    <i class="fas fa-info-circle"></i>
                    <p>No hay elementos externos seleccionados</p>
                </div>
            `;
        } else {
            panelExternos.innerHTML = '';
            elementosExternos.forEach(elemento => {
                const div = document.createElement('div');
                div.className = 'elemento-seleccionado externo pulse';
                div.innerHTML = `
                    <div class="elemento-texto">• ${elemento.texto.substring(0, 80)}${elemento.texto.length > 80 ? '...' : ''}</div>
                    <button class="elemento-remover" onclick="removerElementoSeleccionado('externo', ${elemento.id})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                panelExternos.appendChild(div);
                
                // Remover animación después de completarla
                setTimeout(() => div.classList.remove('pulse'), 300);
            });
        }
    }
    
    function removerElementoSeleccionado(tipo, id) {
        if (tipo === 'interno') {
            elementosInternos = elementosInternos.filter(e => e.id !== id);
            const checkbox = document.getElementById(`fortaleza-${id}`) || document.getElementById(`debilidad-${id}`);
            if (checkbox) {
                checkbox.checked = false;
                checkbox.closest('.actividad-item').classList.remove('selected');
            }
        } else {
            elementosExternos = elementosExternos.filter(e => e.id !== id);
            const checkbox = document.getElementById(`oportunidad-${id}`) || document.getElementById(`amenaza-${id}`);
            if (checkbox) {
                checkbox.checked = false;
                checkbox.closest('.actividad-item').classList.remove('selected');
            }
        }
        
        actualizarPanelesSeleccion();
        actualizarEstadisticas();
    }
    
    function actualizarEstadisticas() {
        // Actualizar contadores de selección
        document.getElementById('fortalezas-seleccionadas').textContent = 
            elementosInternos.filter(e => e.tipo === 'fortaleza').length;
        document.getElementById('debilidades-seleccionadas').textContent = 
            elementosInternos.filter(e => e.tipo === 'debilidad').length;
        document.getElementById('oportunidades-seleccionadas').textContent = 
            elementosExternos.filter(e => e.tipo === 'oportunidad').length;
        document.getElementById('amenazas-seleccionadas').textContent = 
            elementosExternos.filter(e => e.tipo === 'amenaza').length;
        
        // Calcular combinaciones posibles
        const combPosibles = elementosInternos.length * elementosExternos.length;
        document.getElementById('combinaciones-posibles').textContent = combPosibles;
        document.getElementById('combinaciones-activas').textContent = combPosibles;
        document.getElementById('relacion-activa').textContent = 
            `${elementosInternos.length}x${elementosExternos.length}`;
        
        // Actualizar tipo de cruce actual
        document.getElementById('tipo-cruce-actual').textContent = tipoCruceActual.toUpperCase();
        
        // Calcular eficiencia
        const fortalezasTotales = {{ aspectos_foda_int|selectattr('tipo', 'equalto', 'Positivo')|list|length }};
        const debilidadesTotales = {{ aspectos_foda_int|selectattr('tipo', 'equalto', 'Negativo')|list|length }};
        const oportunidadesTotales = {{ aspectos_foda_ext|selectattr('tipo', 'equalto', 'Positivo')|list|length }};
        const amenazasTotales = {{ aspectos_foda_ext|selectattr('tipo', 'equalto', 'Negativo')|list|length }};
        
        let elementosInternosTotales = 0;
        let elementosExternosTotales = 0;
        
        if (tipoCruceActual === 'fo' || tipoCruceActual === 'fa') {
            elementosInternosTotales = fortalezasTotales;
        } else {
            elementosInternosTotales = debilidadesTotales;
        }
        
        if (tipoCruceActual === 'fo' || tipoCruceActual === 'do') {
            elementosExternosTotales = oportunidadesTotales;
        } else {
            elementosExternosTotales = amenazasTotales;
        }
        
        const eficiencia = elementosInternosTotales > 0 ? 
            Math.round((elementosInternos.length / elementosInternosTotales) * 100) : 0;
        document.getElementById('eficiencia-cruce').textContent = `${eficiencia}%`;
        
        const ratio = elementosInternosTotales > 0 ? 
            (elementosInternos.length / elementosInternosTotales).toFixed(1) : 0;
        document.getElementById('ratio-cruce').textContent = `${ratio}x`;
    }
    
    // Funciones para manejar ejes
    function seleccionarEjeFormulario(ejeId, ejeNombre) {
        document.getElementById('eje-estrategico').value = ejeId;
        actualizarEjeSeleccionado();
        mostrarNotificacionCombinacion(`✅ Eje seleccionado: ${ejeNombre}`);
        cerrarEjesTab();
    }
    
    function actualizarEjeSeleccionado() {
        const select = document.getElementById('eje-estrategico');
        const badge = document.getElementById('eje-seleccionado-info');
        const textoEje = document.getElementById('eje-texto');
        
        if (select.value) {
            ejeSeleccionado = select.value;
            ejeSeleccionadoTexto = select.options[select.selectedIndex].text;
            textoEje.textContent = ejeSeleccionadoTexto;
            badge.classList.add('active');
        } else {
            ejeSeleccionado = null;
            ejeSeleccionadoTexto = '';
            textoEje.textContent = 'Ningún eje seleccionado';
            badge.classList.remove('active');
        }
    }
    
    function seleccionarEjeActual() {
        if (ejeActivo) {
            document.getElementById('eje-estrategico').value = ejeActivo.id;
            actualizarEjeSeleccionado();
            mostrarNotificacionCombinacion(`✅ Eje activo seleccionado: ${ejeActivo.nombre}`);
        } else {
            mostrarNotificacionCombinacion('❌ No hay ningún eje activo seleccionado', 'warning');
        }
    }
    
    function limpiarEjeSeleccionado() {
        document.getElementById('eje-estrategico').value = '';
        actualizarEjeSeleccionado();
        mostrarNotificacionCombinacion('✅ Eje limpiado', 'info');
    }
    
    // Funciones de las pestañas
    function toggleEjesTab() {
        const tab = document.getElementById('ejes-tab');
        const content = document.getElementById('ejes-content');
        
        ejesTabAbierta = !ejesTabAbierta;
        
        if (ejesTabAbierta) {
            tab.classList.add('active');
            content.classList.add('active');
            cerrarObjetivoTab();
        } else {
            cerrarEjesTab();
        }
    }
    
    function cerrarEjesTab() {
        const tab = document.getElementById('ejes-tab');
        const content = document.getElementById('ejes-content');
        
        tab.classList.remove('active');
        content.classList.remove('active');
        ejesTabAbierta = false;
    }
    
    function toggleObjetivoTab() {
        const tab = document.getElementById('objetivo-tab');
        const content = document.getElementById('objetivo-content');
        
        objetivoTabAbierta = !objetivoTabAbierta;
        
        if (objetivoTabAbierta) {
            tab.classList.add('active');
            content.classList.add('active');
            cerrarEjesTab();
        } else {
            cerrarObjetivoTab();
        }
    }
    
    function cerrarObjetivoTab() {
        const tab = document.getElementById('objetivo-tab');
        const content = document.getElementById('objetivo-content');
        
        tab.classList.remove('active');
        content.classList.remove('active');
        objetivoTabAbierta = false;
    }
    
    function mostrarObjetivoCompleto() {
        const modal = document.getElementById('modal-objetivo');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function cerrarModalObjetivo() {
        const modal = document.getElementById('modal-objetivo');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    // Funciones del FODA con combinación múltiple
    function guardarEstrategiaMultiple() {
        const estrategiaTexto = document.getElementById('estrategia').value.trim();
        const generarTodas = document.getElementById('generar-todas-combinaciones').checked;
        const estrategiaGlobal = document.getElementById('estrategia-global').checked;
        
        // Validaciones
        if (elementosInternos.length === 0 || elementosExternos.length === 0) {
            mostrarNotificacionCombinacion('❌ Debe seleccionar al menos un elemento interno y uno externo', 'error');
            return;
        }
        
        if (!ejeSeleccionado) {
            mostrarNotificacionCombinacion('❌ Debe seleccionar un eje estratégico', 'error');
            return;
        }
        
        if (!estrategiaTexto) {
            mostrarNotificacionCombinacion('❌ Debe escribir una estrategia', 'error');
            document.getElementById('estrategia').focus();
            return;
        }
        
        const btnGuardar = document.querySelector('.btn-guardar');
        const originalText = btnGuardar.innerHTML;
        btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btnGuardar.disabled = true;
        
        // Preparar datos para enviar
        const estrategia = {
            tipo_cruce: tipoCruceActual.toUpperCase(),
            elementos_internos: elementosInternos,
            elementos_externos: elementosExternos,
            eje_id: ejeSeleccionado,
            eje_texto: ejeSeleccionadoTexto,
            estrategia: estrategiaTexto,
            es_multiple: true,
            generar_todas: generarTodas,
            estrategia_global: estrategiaGlobal,
            fecha: new Date().toISOString()
        };
        
        // Enviar al servidor con combinación múltiple
        fetch('/guardar_estrategia_foda_multiple', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(estrategia)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarNotificacionCombinacion('✅ Estrategia múltiple guardada correctamente', 'success');
                
                if (data.estrategias) {
                    data.estrategias.forEach(estrategia => {
                        estrategiasGuardadas.push(estrategia);
                        agregarEstrategiaALista(estrategia);
                    });
                } else {
                    estrategiasGuardadas.push(estrategia);
                    agregarEstrategiaALista(estrategia);
                }
                
                actualizarContadores();
                limpiarSelecciones();
            } else {
                mostrarNotificacionCombinacion('❌ Error: ' + data.message, 'error');
            }
            
            btnGuardar.innerHTML = originalText;
            btnGuardar.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacionCombinacion('❌ Error de conexión al servidor', 'error');
            btnGuardar.innerHTML = originalText;
            btnGuardar.disabled = false;
        });
    }
    
    function agregarEstrategiaALista(estrategia) {
        const lista = document.getElementById('lista-estrategias');
        
        const emptyMsg = lista.querySelector('.estrategia-empty');
        if (emptyMsg) {
            emptyMsg.remove();
        }
        
        const estrategiaDiv = document.createElement('div');
        estrategiaDiv.className = `estrategia-item ${estrategia.es_multiple ? 'estrategia-multiples' : ''}`;
        estrategiaDiv.dataset.eje = estrategia.eje_id;
        estrategiaDiv.dataset.combinacion = estrategia.es_multiple ? 'multiple' : 'simple';
        
        const fecha = new Date(estrategia.fecha);
        const fechaFormateada = fecha.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        let iconoInterno = estrategia.elementos_internos?.[0]?.tipo === 'fortaleza' ? 
            '<i class="fas fa-shield-alt"></i>' : 
            '<i class="fas fa-exclamation-triangle"></i>';
        
        let iconoExterno = estrategia.elementos_externos?.[0]?.tipo === 'oportunidad' ?
            '<i class="fas fa-bullseye"></i>' :
            '<i class="fas fa-skull-crossbones"></i>';
        
        const esMultiple = estrategia.es_multiple || 
                          (estrategia.elementos_internos && estrategia.elementos_internos.length > 1) ||
                          (estrategia.elementos_externos && estrategia.elementos_externos.length > 1);
        
        estrategiaDiv.innerHTML = `
            <div class="estrategia-header">
                <div class="estrategia-tipo-container">
                    <span class="estrategia-tipo ${estrategia.tipo_cruce.toLowerCase()}">
                        ${estrategia.tipo_cruce}
                    </span>
                    ${esMultiple ? '<span class="badge-multiple">Múltiple</span>' : ''}
                </div>
                <span class="estrategia-fecha">${fechaFormateada}</span>
            </div>
            <div class="estrategia-content">
                ${estrategia.estrategia}
            </div>
            <div class="estrategia-elementos">
                <div class="elementos-grupo">
                    <div class="elementos-titulo">Elementos Internos (${estrategia.elementos_internos ? estrategia.elementos_internos.length : 1}):</div>
                    ${estrategia.elementos_internos ? 
                        estrategia.elementos_internos.map(e => 
                            `<span class="elemento-badge badge-${e.tipo}">
                                ${e.tipo === 'fortaleza' ? '<i class="fas fa-shield-alt"></i>' : '<i class="fas fa-exclamation-triangle"></i>'}
                                ${e.texto.substring(0, 30)}${e.texto.length > 30 ? '...' : ''}
                            </span>`
                        ).join('') : 
                        `<span class="elemento-badge badge-${estrategia.elemento_interno_tipo}">
                            ${iconoInterno} ${estrategia.elemento_interno_tipo}: ${estrategia.elemento_interno_texto ? estrategia.elemento_interno_texto.substring(0, 30) + '...' : ''}
                        </span>`
                    }
                </div>
                <div class="elementos-grupo">
                    <div class="elementos-titulo">Elementos Externos (${estrategia.elementos_externos ? estrategia.elementos_externos.length : 1}):</div>
                    ${estrategia.elementos_externos ? 
                        estrategia.elementos_externos.map(e => 
                            `<span class="elemento-badge badge-${e.tipo}">
                                ${e.tipo === 'oportunidad' ? '<i class="fas fa-bullseye"></i>' : '<i class="fas fa-skull-crossbones"></i>'}
                                ${e.texto.substring(0, 30)}${e.texto.length > 30 ? '...' : ''}
                            </span>`
                        ).join('') : 
                        `<span class="elemento-badge badge-${estrategia.elemento_externo_tipo}">
                            ${iconoExterno} ${estrategia.elemento_externo_tipo}: ${estrategia.elemento_externo_texto ? estrategia.elemento_externo_texto.substring(0, 30) + '...' : ''}
                        </span>`
                    }
                </div>
                <div class="elementos-grupo">
                    <span class="elemento-badge badge-eje">
                        <i class="fas fa-bullseye"></i> ${estrategia.eje_texto}
                    </span>
                    ${esMultiple ? 
                        `<span class="elemento-badge badge-combinacion">
                            <i class="fas fa-project-diagram"></i> 
                            ${estrategia.elementos_internos ? estrategia.elementos_internos.length : 1}x${estrategia.elementos_externos ? estrategia.elementos_externos.length : 1}
                        </span>` : ''
                    }
                </div>
            </div>
        `;
        
        lista.insertBefore(estrategiaDiv, lista.firstChild);
    }
    
    function cargarEstrategias() {
        fetch('/api/estrategias_foda_multiple')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    estrategiasGuardadas = data.estrategias;
                    
                    const lista = document.getElementById('lista-estrategias');
                    lista.innerHTML = '';
                    
                    if (estrategiasGuardadas.length === 0) {
                        lista.innerHTML = `
                            <div class="estrategia-empty">
                                <i class="fas fa-inbox"></i>
                                <p>No hay estrategias guardadas todavía.</p>
                                <p>Comience a crear estrategias usando el formulario.</p>
                            </div>
                        `;
                    } else {
                        estrategiasGuardadas.forEach(estrategia => {
                            agregarEstrategiaALista(estrategia);
                        });
                    }
                    
                    actualizarContadores();
                }
            })
            .catch(error => {
                console.error('Error al cargar estrategias:', error);
                cargarEstrategiasCompatibilidad();
            });
    }
    
    function cargarEstrategiasCompatibilidad() {
        fetch('/api/estrategias_foda')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    estrategiasGuardadas = data.estrategias.map(e => ({
                        ...e,
                        eje_id: e.eje_id || 'no_asignado',
                        eje_texto: e.eje_texto || 'Sin eje asignado',
                        es_multiple: false
                    }));
                    
                    const lista = document.getElementById('lista-estrategias');
                    lista.innerHTML = '';
                    
                    if (estrategiasGuardadas.length === 0) {
                        lista.innerHTML = `
                            <div class="estrategia-empty">
                                <i class="fas fa-inbox"></i>
                                <p>No hay estrategias guardadas todavía.</p>
                                <p>Comience a crear estrategias usando el formulario.</p>
                            </div>
                        `;
                    } else {
                        estrategiasGuardadas.forEach(estrategia => {
                            agregarEstrategiaALista(estrategia);
                        });
                    }
                    
                    actualizarContadores();
                }
            })
            .catch(error => {
                console.error('Error al cargar estrategias de compatibilidad:', error);
            });
    }
    
    function filtrarEstrategias() {
        const filtroTipo = document.getElementById('filtro-tipo-estrategia').value;
        const filtroEje = document.getElementById('filtro-eje-estrategia').value;
        const filtroCombinacion = document.getElementById('filtro-combinacion').value;
        const estrategiasItems = document.querySelectorAll('.estrategia-item');
        
        let estrategiasMostradas = 0;
        
        estrategiasItems.forEach(item => {
            const tipo = item.querySelector('.estrategia-tipo').textContent.trim();
            const eje = item.dataset.eje;
            const combinacion = item.dataset.combinacion;
            
            const pasaTipo = filtroTipo === 'all' || tipo === filtroTipo;
            const pasaEje = filtroEje === 'all' || eje === filtroEje;
            const pasaCombinacion = filtroCombinacion === 'all' || 
                                  (filtroCombinacion === 'multiple' && combinacion === 'multiple') ||
                                  (filtroCombinacion === 'simple' && combinacion === 'simple');
            
            if (pasaTipo && pasaEje && pasaCombinacion) {
                item.style.display = 'block';
                estrategiasMostradas++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Mostrar mensaje si no hay resultados
        const lista = document.getElementById('lista-estrategias');
        const emptyMsg = lista.querySelector('.estrategia-empty');
        
        if (estrategiasMostradas === 0) {
            if (!emptyMsg) {
                const msg = document.createElement('div');
                msg.className = 'estrategia-empty';
                msg.innerHTML = `
                    <i class="fas fa-search"></i>
                    <p>No se encontraron estrategias con los filtros seleccionados.</p>
                    <p>Intente con otros criterios de búsqueda.</p>
                `;
                lista.appendChild(msg);
            }
        } else if (emptyMsg) {
            emptyMsg.remove();
        }
    }
    
    function limpiarSelecciones() {
        // Limpiar todos los checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Limpiar clases selected
        document.querySelectorAll('.actividad-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Limpiar arrays
        elementosInternos = [];
        elementosExternos = [];
        
        // Limpiar textarea
        document.getElementById('estrategia').value = '';
        
        // Actualizar paneles
        actualizarPanelesSeleccion();
        actualizarEstadisticas();
        
        mostrarNotificacionCombinacion('✅ Todas las selecciones han sido limpiadas', 'success');
    }
    
    function actualizarContadores() {
        const totalEstrategias = estrategiasGuardadas.length;
        const estrategiasMultiples = estrategiasGuardadas.filter(e => e.es_multiple).length;
        
        document.getElementById('contador-estrategias').textContent = totalEstrategias;
        document.getElementById('estrategias-multiples').textContent = estrategiasMultiples;
        
        // Actualizar estadísticas por eje
        if (ejeActivo) {
            const estrategiasEje = estrategiasGuardadas.filter(e => e.eje_id === ejeActivo.id).length;
            document.getElementById('estrategias-eje').textContent = estrategiasEje;
        }
    }
    
    // Funciones del FODA existentes
    function seleccionarTipoCruce(tipo) {
        tipoCruceActual = tipo;
        
        document.querySelectorAll('.cruce-option').forEach(btn => {
            btn.classList.remove('selected');
        });
        document.querySelector(`.cruce-option[data-tipo="${tipo}"]`).classList.add('selected');
        
        actualizarGuiaEstrategia();
        validarSelecciones();
    }
    
    function actualizarGuiaEstrategia() {
        const guia = document.getElementById('texto-guia');
        switch(tipoCruceActual) {
            case 'fo':
                guia.textContent = '¿Cómo usar las fortalezas para aprovechar las oportunidades? (Combinación múltiple)';
                break;
            case 'do':
                guia.textContent = '¿Cómo superar las debilidades para aprovechar las oportunidades? (Combinación múltiple)';
                break;
            case 'fa':
                guia.textContent = '¿Cómo usar las fortalezas para minimizar las amenazas? (Combinación múltiple)';
                break;
            case 'da':
                guia.textContent = '¿Cómo superar las debilidades para evitar las amenazas? (Combinación múltiple)';
                break;
        }
    }
    
    function validarSelecciones() {
        // Validar que los elementos seleccionados sean del tipo correcto según el cruce
        const tiposPermitidosInterno = tipoCruceActual === 'fo' || tipoCruceActual === 'fa' ? 
            ['fortaleza'] : ['debilidad'];
        
        const tiposPermitidosExterno = tipoCruceActual === 'fo' || tipoCruceActual === 'do' ? 
            ['oportunidad'] : ['amenaza'];
        
        // Filtrar elementos que no corresponden
        elementosInternos = elementosInternos.filter(e => tiposPermitidosInterno.includes(e.tipo));
        elementosExternos = elementosExternos.filter(e => tiposPermitidosExterno.includes(e.tipo));
        
        // Actualizar checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            const id = checkbox.id;
            const tipo = id.split('-')[0];
            const item = checkbox.closest('.actividad-item');
            
            if ((tiposPermitidosInterno.includes(tipo) || tiposPermitidosExterno.includes(tipo))) {
                checkbox.disabled = false;
                item.style.opacity = '1';
            } else {
                checkbox.disabled = true;
                checkbox.checked = false;
                item.style.opacity = '0.5';
            }
        });
        
        actualizarPanelesSeleccion();
        actualizarEstadisticas();
    }
    
    function generarEstrategiaAutomatica() {
        if (elementosInternos.length === 0 || elementosExternos.length === 0) {
            mostrarNotificacionCombinacion('❌ Debe seleccionar elementos primero', 'error');
            return;
        }
        
        const btnGenerar = document.querySelector('.btn-generar');
        const originalText = btnGenerar.innerHTML;
        btnGenerar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
        btnGenerar.disabled = true;
        
        // Simular generación de estrategia
        setTimeout(() => {
            const estrategiasBase = {
                'fo': [
                    'Aprovechar las fortalezas seleccionadas para maximizar las oportunidades identificadas, creando sinergias entre los diferentes elementos.',
                    'Combinar estratégicamente las capacidades internas con las oportunidades externas para generar ventajas competitivas sostenibles.',
                    'Utilizar las fortalezas como palanca para capitalizar las oportunidades, generando un efecto multiplicador en los resultados.'
                ],
                'do': [
                    'Transformar las debilidades identificadas mediante el aprovechamiento de las oportunidades, superando limitaciones mediante alianzas estratégicas.',
                    'Utilizar las oportunidades externas como catalizadores para mejorar las áreas de debilidad, fortaleciendo las capacidades internas.',
                    'Alinear los esfuerzos de mejora con las oportunidades del entorno, convirtiendo debilidades en fortalezas progresivas.'
                ],
                'fa': [
                    'Utilizar las fortalezas como barrera protectora frente a las amenazas, creando capacidades de resiliencia y adaptación.',
                    'Convertir las amenazas en desafíos manejables mediante el despliegue estratégico de las fortalezas disponibles.',
                    'Establecer mecanismos de prevención basados en las fortalezas para neutralizar o minimizar el impacto de las amenazas.'
                ],
                'da': [
                    'Implementar acciones defensivas coordinadas para proteger las áreas vulnerables frente a las amenazas identificadas.',
                    'Desarrollar planes de contingencia que aborden simultáneamente debilidades internas y amenazas externas.',
                    'Establecer alianzas y colaboraciones para compensar debilidades y distribuir riesgos frente a amenazas comunes.'
                ]
            };
            
            const estrategias = estrategiasBase[tipoCruceActual] || estrategiasBase['fo'];
            const estrategiaAleatoria = estrategias[Math.floor(Math.random() * estrategias.length)];
            
            // Personalizar con información específica
            const numInternos = elementosInternos.length;
            const numExternos = elementosExternos.length;
            const ejeNombre = ejeSeleccionadoTexto || 'el eje estratégico seleccionado';
            
            const estrategiaPersonalizada = `Considerando los ${numInternos} elementos internos y ${numExternos} elementos externos seleccionados, ${estrategiaAleatoria} Esta estrategia se enmarca en ${ejeNombre} y busca crear valor a través de la combinación múltiple de factores.`;
            
            document.getElementById('estrategia').value = estrategiaPersonalizada;
            
            btnGenerar.innerHTML = originalText;
            btnGenerar.disabled = false;
            
            mostrarNotificacionCombinacion('✅ Estrategia generada automáticamente', 'success');
        }, 1000);
    }
    
    function mostrarNotificacionCombinacion(mensaje, tipo = 'info') {
        let notificacion = document.getElementById('notificacion-combinacion');
        
        if (!notificacion) {
            notificacion = document.createElement('div');
            notificacion.id = 'notificacion-combinacion';
            notificacion.className = 'notificacion-combinacion';
            document.body.appendChild(notificacion);
        }
        
        let icono = '';
        switch(tipo) {
            case 'success':
                icono = '<i class="fas fa-check-circle"></i>';
                break;
            case 'error':
                icono = '<i class="fas fa-exclamation-circle"></i>';
                break;
            case 'warning':
                icono = '<i class="fas fa-exclamation-triangle"></i>';
                break;
            default:
                icono = '<i class="fas fa-info-circle"></i>';
        }
        
        notificacion.innerHTML = `
            <div class="notificacion-titulo">${icono} ${mensaje.split(':')[0]}</div>
            <div class="notificacion-desc">${mensaje.split(':').slice(1).join(':').trim() || 'Operación completada'}</div>
        `;
        
        notificacion.classList.add('show');
        
        setTimeout(() => {
            notificacion.classList.remove('show');
        }, 4000);
    }
</script>
{% endblock %}

