{% extends "inicio.html" %}

{% block content %}
<div class="canvas-main-container">
    <h1 class="content-title">Modelo CANVA - An√°lisis Estrat√©gico</h1>
    
    <div class="canvas-layout">
        <!-- Columna Izquierda - Los 9 bloques del CANVA -->
        <div class="canvas-left-column">
            <div class="canvas-container" id="canvas-blocks-container">
                {% for bloque in bloques_canva %}
                <div class="canvas-block block{{ loop.index }}" 
                     data-aspecto="{{ bloque.nombre }}"
                     id="bloque-{{ loop.index }}">
                    <div class="block-title">
                        <i class="{{ bloque.icono }}"></i> 
                        <span class="block-title-text">{{ loop.index }}. {{ bloque.nombre }}</span>
                    </div>
                    <div class="block-content" id="contenido-{{ loop.index }}">
                        <!-- Contenido se carga din√°micamente -->
                    </div>
                    <div class="block-counter" id="counter-{{ loop.index }}">
                        0 actividades
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="canvas-actions">
                <button class="action-button save" onclick="guardarCanvaCompleto()">
                    <i class="fas fa-save"></i> Guardar CANVA
                </button>
                <button class="action-button export" onclick="exportarCanva()">
                    <i class="fas fa-download"></i> Exportar
                </button>
                {% if session.rol == 'admin' %}
                <button class="action-button clean" onclick="limpiarCanva()">
                    <i class="fas fa-broom"></i> Limpiar
                </button>
                {% endif %}
                <button class="action-button refresh" onclick="forzarActualizacion()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>
            
            <div class="canvas-stats" id="canvas-stats">
                <div class="stat-item">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value" id="total-actividades">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Positivas:</span>
                    <span class="stat-value positive" id="total-positivas">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Negativas:</span>
                    <span class="stat-value negative" id="total-negativas">0</span>
                </div>
            </div>
            
            <div class="last-update">
                <i class="fas fa-clock"></i>
                <span id="last-update-time">Actualizando...</span>
            </div>
        </div>
        
        <!-- Columna Derecha - Formulario para ingresar actividades -->
        <div class="canvas-right-column">
            <div class="quick-input-section">
                <div class="section-header">
                    <h2><i class="fas fa-edit"></i> Ingresar Actividades</h2>
                    <span class="connection-status" id="connection-status">
                        <i class="fas fa-circle"></i> Conectado
                    </span>
                </div>
                
                <div class="input-box">
                    <h3><i class="fas fa-tasks"></i> ACTIVIDAD</h3>
                    <textarea id="quick-actividad" 
                              placeholder="Describa la actividad aqu√≠..."
                              rows="3"
                              class="quick-textarea"
                              maxlength="500"></textarea>
                    <div class="char-counter">
                        <span id="char-count">0</span>/500 caracteres
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-box half">
                        <h3><i class="fas fa-balance-scale"></i> TIPO</h3>
                        <div class="tipo-options">
                            <button class="tipo-option positivo-option selected" 
                                    id="btn-positivo"
                                    onclick="seleccionarTipo('Positivo')">
                                <i class="fas fa-thumbs-up"></i> Positivo
                            </button>
                            <button class="tipo-option negativo-option" 
                                    id="btn-negativo"
                                    onclick="seleccionarTipo('Negativo')">
                                <i class="fas fa-thumbs-down"></i> Negativo
                            </button>
                        </div>
                        <input type="hidden" id="quick-tipo" value="Positivo">
                    </div>
                    
                    <div class="input-box half">
                        <h3><i class="fas fa-hashtag"></i> BLOQUE</h3>
                        <div class="bloque-selector">
                            <select id="bloque-select" class="form-select">
                                {% for bloque in bloques_canva %}
                                <option value="{{ loop.index }}">{{ loop.index }}. {{ bloque.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="input-box">
                    <h3><i class="fas fa-font"></i> DESCRIPCI√ìN</h3>
                    <input type="text" id="tipo-descripcion" 
                           class="form-input"
                           placeholder="Ej: Generaci√≥n de empleo local..."
                           value="Generaci√≥n de empleo local">
                </div>
                
                <div class="quick-actions">
                    <button class="quick-action-btn save" onclick="guardarActividad()">
                        <i class="fas fa-save"></i> Guardar Actividad
                    </button>
                    <button class="quick-action-btn secondary" onclick="limpiarEntradaRapida()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
                
                <div class="form-status" id="form-status">
                    <!-- Estado del formulario se muestra aqu√≠ -->
                </div>
            </div>
            
            <div class="info-box">
                <h3><i class="fas fa-info-circle"></i> Instrucciones</h3>
                <ul class="instructions-list">
                    <li>Escriba la actividad (m√°x. 500 caracteres)</li>
                    <li>Seleccione Positivo (verde) o Negativo (rojo oscuro)</li>
                    <li>Elija el bloque CANVA correspondiente (1-9)</li>
                    <li>Complete la descripci√≥n del aspecto</li>
                    <li>Haga clic en <strong>Guardar Actividad</strong></li>
                    <li>Los datos se actualizan autom√°ticamente cada 10 segundos</li>
                </ul>
            </div>
            
            <div class="stats-section">
                <div class="section-header">
                    <h3><i class="fas fa-chart-bar"></i> Actividades por Bloque</h3>
                    <span class="stats-update" id="stats-update">
                        <i class="fas fa-history"></i>
                    </span>
                </div>
                <div class="bloque-stats" id="bloque-stats">
                    <!-- Estad√≠sticas se cargan din√°micamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* ===== VARIABLES Y RESET ===== */
    :root {
        --color1: #1B4079; /* Azul oscuro */
        --color2: #4D7C8A; /* Azul gris√°ceo */
        --color3: #7F9C96; /* Verde azulado claro */
        --color4: #8FAD88; /* Verde claro */
        --color5: #CBDF90; /* Verde amarillento */
        --positive-color: #4CAF50;
        --negative-color: #8B0000;
        --text-light: #FFFFFF;
        --text-dark: #333333;
        --bg-light: #F8F9FA;
        --border-color: #DEE2E6;
        --shadow-light: rgba(0, 0, 0, 0.1);
        --shadow-medium: rgba(0, 0, 0, 0.15);
        --transition-speed: 0.3s;
    }
    
    .canvas-main-container {
        padding: 20px;
        min-height: 100vh;
        background-color: #f5f7fa;
    }
    
    /* ===== LAYOUT PRINCIPAL ===== */
    .canvas-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-top: 20px;
        min-height: calc(100vh - 120px);
    }
    
    /* ===== COLUMNA IZQUIERDA (CANVA) ===== */
    .canvas-left-column {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 6px 20px var(--shadow-light);
        display: flex;
        flex-direction: column;
    }
    
    .canvas-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, minmax(180px, auto));
        gap: 20px;
        margin: 20px 0;
        flex: 1;
    }
    
    .canvas-block {
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 12px var(--shadow-light);
        transition: all var(--transition-speed) ease;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        border: 2px solid transparent;
    }
    
    .canvas-block:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px var(--shadow-medium);
        border-color: rgba(255, 255, 255, 0.3);
    }
    
    .block-title {
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        color: var(--text-light);
        min-height: 45px;
    }
    
    .block-title i {
        margin-right: 12px;
        font-size: 18px;
        flex-shrink: 0;
    }
    
    .block-title-text {
        flex: 1;
        line-height: 1.3;
    }
    
    .block-content {
        flex: 1;
        background-color: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 15px;
        font-size: 13px;
        line-height: 1.5;
        color: var(--text-light);
        overflow-y: auto;
        max-height: 150px;
        margin-bottom: 10px;
        transition: all 0.5s ease;
    }
    
    .block-content::-webkit-scrollbar {
        width: 6px;
    }
    
    .block-content::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
    }
    
    .block-content::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
    }
    
    .actividad-item {
        margin-bottom: 8px;
        padding: 8px 10px;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        font-size: 12px;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: fadeIn 0.5s ease;
        border-left: 3px solid transparent;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    .actividad-item.new {
        border-left-color: var(--color5);
        background-color: rgba(203, 223, 144, 0.2);
    }
    
    .actividad-item:hover {
        background-color: rgba(0, 0, 0, 0.3);
        transform: translateX(5px);
    }
    
    .actividad-tipo {
        font-size: 11px;
        opacity: 0.9;
        margin-left: 8px;
    }
    
    .block-counter {
        font-size: 11px;
        text-align: right;
        color: rgba(255, 255, 255, 0.8);
        padding-top: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 5px;
    }
    
    /* Colores espec√≠ficos para cada bloque */
    .block1 { background: linear-gradient(145deg, var(--color1), #2a5298); }
    .block2 { background: linear-gradient(145deg, var(--color2), #5a8f9c); }
    .block3 { background: linear-gradient(145deg, var(--color3), #90b2aa); }
    .block4 { background: linear-gradient(145deg, var(--color4), #a0c098); }
    .block5 { background: linear-gradient(145deg, var(--color5), #d5e99b); }
    .block6 { background: linear-gradient(145deg, var(--color1), #3a62a9); }
    .block7 { background: linear-gradient(145deg, var(--color2), #6a9faf); }
    .block8 { background: linear-gradient(145deg, var(--color3), #98c2ba); }
    .block9 { background: linear-gradient(145deg, var(--color4), #b0d0a8); }
    
    /* ===== ACCIONES Y ESTAD√çSTICAS ===== */
    .canvas-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 25px 0 20px;
        flex-wrap: wrap;
    }
    
    .action-button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 140px;
        justify-content: center;
    }
    
    .action-button.save { background-color: var(--color1); color: white; }
    .action-button.export { background-color: var(--color2); color: white; }
    .action-button.clean { background-color: var(--color4); color: white; }
    .action-button.refresh { background-color: var(--color3); color: white; }
    
    .action-button:hover {
        opacity: 0.9;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px var(--shadow-medium);
    }
    
    .action-button:active {
        transform: translateY(-1px);
    }
    
    .action-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .canvas-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 15px 0;
        padding: 20px;
        background: linear-gradient(145deg, var(--bg-light), #e9ecef);
        border-radius: 10px;
        border: 1px solid var(--border-color);
    }
    
    .stat-item {
        text-align: center;
        padding: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px var(--shadow-light);
    }
    
    .stat-label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        display: block;
        font-size: 24px;
        font-weight: bold;
        color: var(--color1);
    }
    
    .stat-value.positive { color: var(--positive-color); }
    .stat-value.negative { color: var(--negative-color); }
    
    .last-update {
        text-align: center;
        font-size: 13px;
        color: #666;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 6px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    /* ===== COLUMNA DERECHA (FORMULARIO) ===== */
    .canvas-right-column {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 6px 20px var(--shadow-light);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .quick-input-section h2 {
        color: var(--color1);
        margin: 0;
        font-size: 22px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .connection-status {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 12px;
        background: rgba(76, 175, 80, 0.1);
        color: var(--positive-color);
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .connection-status .fa-circle {
        font-size: 8px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .input-box {
        background: var(--bg-light);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }
    
    .input-box:focus-within {
        border-color: var(--color2);
        box-shadow: 0 0 0 3px rgba(77, 124, 138, 0.1);
    }
    
    .input-box h3 {
        color: var(--color3);
        margin-bottom: 15px;
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .input-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .input-box.half {
        flex: 1;
        margin-bottom: 0;
    }
    
    .quick-textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.5;
        transition: all 0.3s ease;
    }
    
    .quick-textarea:focus {
        border-color: var(--color2);
        outline: none;
        box-shadow: 0 0 0 3px rgba(77, 124, 138, 0.1);
    }
    
    .char-counter {
        text-align: right;
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
    
    .tipo-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 10px;
    }
    
    .tipo-option {
        padding: 15px;
        border: 2px solid;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background-color: white;
        font-size: 14px;
    }
    
    .positivo-option {
        border-color: var(--positive-color);
        color: var(--positive-color);
        background-color: rgba(76, 175, 80, 0.05);
    }
    
    .negativo-option {
        border-color: var(--negative-color);
        color: var(--negative-color);
        background-color: rgba(139, 0, 0, 0.05);
    }
    
    .tipo-option.selected {
        transform: scale(0.98);
        box-shadow: inset 0 3px 6px rgba(0,0,0,0.1);
    }
    
    .tipo-option:not(.selected) {
        opacity: 0.6;
        background-color: #f8f9fa;
    }
    
    .tipo-option:not(.selected):hover {
        opacity: 0.8;
    }
    
    .bloque-selector {
        margin-top: 10px;
    }
    
    .form-select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        font-size: 14px;
        background-color: white;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%231B4079' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 16px;
    }
    
    .form-select:focus {
        border-color: var(--color2);
        outline: none;
        box-shadow: 0 0 0 3px rgba(77, 124, 138, 0.1);
    }
    
    .form-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        border-color: var(--color2);
        outline: none;
        box-shadow: 0 0 0 3px rgba(77, 124, 138, 0.1);
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
    }
    
    .quick-action-btn {
        padding: 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s ease;
        font-size: 15px;
    }
    
    .quick-action-btn.save {
        background-color: var(--color1);
        color: white;
    }
    
    .quick-action-btn.secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .quick-action-btn:hover {
        opacity: 0.9;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px var(--shadow-medium);
    }
    
    .quick-action-btn:active {
        transform: translateY(-1px);
    }
    
    .form-status {
        margin-top: 15px;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        text-align: center;
        display: none;
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .form-status.success {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--positive-color);
        border: 1px solid rgba(76, 175, 80, 0.3);
        display: block;
    }
    
    .form-status.error {
        background-color: rgba(244, 67, 54, 0.1);
        color: #f44336;
        border: 1px solid rgba(244, 67, 54, 0.3);
        display: block;
    }
    
    /* ===== INFO BOX Y ESTAD√çSTICAS ===== */
    .info-box {
        background: linear-gradient(145deg, #f0f7ff, #e3f2fd);
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid var(--color1);
    }
    
    .info-box h3 {
        color: var(--color1);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 18px;
    }
    
    .instructions-list {
        margin: 0;
        padding-left: 20px;
    }
    
    .instructions-list li {
        margin-bottom: 10px;
        color: #495057;
        font-size: 14px;
        line-height: 1.5;
    }
    
    .stats-section {
        background: linear-gradient(145deg, var(--bg-light), #e9ecef);
        padding: 20px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
    }
    
    .stats-section h3 {
        color: var(--color1);
        margin: 0;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .stats-update {
        font-size: 14px;
        color: #666;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    
    .stats-update:hover {
        transform: rotate(180deg);
    }
    
    .bloque-stats {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin-top: 15px;
    }
    
    .bloque-stat-item {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 13px;
        padding: 8px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 4px var(--shadow-light);
    }
    
    .bloque-stat-name {
        width: 40%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #666;
        font-weight: 500;
    }
    
    .bloque-stat-bar {
        flex: 1;
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .bloque-stat-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--color3), var(--color2));
        border-radius: 4px;
        transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
    }
    
    .bloque-stat-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.4),
            transparent
        );
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .bloque-stat-count {
        width: 35px;
        text-align: right;
        font-weight: bold;
        color: var(--color1);
        font-size: 14px;
    }
    
    /* ===== RESPONSIVE DESIGN COMPLETO ===== */
    
    /* Pantallas grandes (Desktop) */
    @media screen and (min-width: 1201px) {
        .canvas-layout {
            grid-template-columns: 2.5fr 1.5fr;
        }
        
        .canvas-container {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, minmax(200px, auto));
        }
    }
    
    /* Tablets (Horizontal) */
    @media screen and (max-width: 1200px) and (min-width: 769px) {
        .canvas-layout {
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .canvas-container {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, minmax(160px, auto));
            gap: 15px;
        }
        
        .block-title {
            font-size: 14px;
        }
        
        .block-content {
            font-size: 12px;
            padding: 12px;
        }
        
        .action-button {
            min-width: 120px;
            padding: 10px 20px;
        }
    }
    
    /* Tablets (Vertical) y m√≥viles grandes */
    @media screen and (max-width: 768px) {
        .canvas-layout {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .canvas-container {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, minmax(150px, auto));
        }
        
        .block1 { order: 1; }
        .block2 { order: 2; }
        .block3 { order: 3; }
        .block4 { order: 4; }
        .block5 { order: 5; }
        .block6 { order: 6; }
        .block7 { order: 7; }
        .block8 { order: 8; }
        .block9 { order: 9; }
        
        .canvas-actions {
            flex-wrap: wrap;
        }
        
        .action-button {
            flex: 1;
            min-width: 140px;
        }
        
        .quick-actions {
            grid-template-columns: 1fr;
        }
        
        .input-row {
            flex-direction: column;
            gap: 10px;
        }
        
        .input-box.half {
            width: 100%;
        }
    }
    
    /* M√≥viles medianos */
    @media screen and (max-width: 576px) {
        .canvas-main-container {
            padding: 15px;
        }
        
        .canvas-left-column,
        .canvas-right-column {
            padding: 20px;
        }
        
        .canvas-container {
            grid-template-columns: 1fr;
            grid-template-rows: repeat(9, minmax(140px, auto));
            gap: 12px;
        }
        
        .block-title {
            font-size: 13px;
            min-height: 40px;
        }
        
        .block-content {
            font-size: 11px;
            padding: 10px;
            max-height: 100px;
        }
        
        .actividad-item {
            font-size: 11px;
            padding: 6px 8px;
        }
        
        .canvas-actions {
            flex-direction: column;
        }
        
        .action-button {
            width: 100%;
            justify-content: center;
        }
        
        .canvas-stats {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .stat-item {
            padding: 15px;
        }
        
        .quick-input-section h2 {
            font-size: 18px;
        }
        
        .input-box h3 {
            font-size: 14px;
        }
        
        .quick-textarea {
            min-height: 100px;
            font-size: 13px;
            padding: 12px;
        }
        
        .tipo-option {
            padding: 12px;
            font-size: 13px;
        }
        
        .form-select,
        .form-input {
            padding: 10px 12px;
            font-size: 13px;
        }
        
        .quick-action-btn {
            padding: 12px;
            font-size: 14px;
        }
        
        .info-box h3,
        .stats-section h3 {
            font-size: 16px;
        }
        
        .instructions-list li {
            font-size: 13px;
        }
        
        .bloque-stat-item {
            font-size: 12px;
        }
        
        .bloque-stat-name {
            width: 35%;
        }
    }
    
    /* M√≥viles peque√±os */
    @media screen and (max-width: 375px) {
        .canvas-main-container {
            padding: 10px;
        }
        
        .canvas-left-column,
        .canvas-right-column {
            padding: 15px;
        }
        
        .content-title {
            font-size: 20px;
        }
        
        .canvas-container {
            gap: 10px;
        }
        
        .canvas-block {
            padding: 15px;
        }
        
        .block-title {
            font-size: 12px;
        }
        
        .block-title i {
            font-size: 16px;
            margin-right: 8px;
        }
        
        .block-content {
            font-size: 10px;
            padding: 8px;
        }
        
        .actividad-item {
            font-size: 10px;
            padding: 4px 6px;
        }
        
        .action-button {
            padding: 10px 15px;
            font-size: 13px;
        }
        
        .quick-input-section h2 {
            font-size: 16px;
        }
    }
    
    /* Orientaci√≥n horizontal en m√≥viles */
    @media screen and (max-height: 500px) and (orientation: landscape) {
        .canvas-layout {
            grid-template-columns: 2fr 1fr;
            gap: 15px;
        }
        
        .canvas-container {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, minmax(120px, auto));
            gap: 10px;
        }
        
        .canvas-block {
            min-height: 120px;
        }
        
        .block-title {
            min-height: 30px;
            font-size: 11px;
        }
        
        .block-content {
            max-height: 70px;
            font-size: 10px;
            padding: 8px;
        }
        
        .actividad-item {
            font-size: 9px;
            padding: 3px 5px;
            margin-bottom: 4px;
        }
        
        .quick-textarea {
            min-height: 80px;
        }
        
        .input-row {
            flex-direction: row;
        }
        
        .input-box.half {
            flex: 1;
        }
    }
    
    /* Pantallas muy altas (monitores verticales) */
    @media screen and (min-height: 1000px) {
        .canvas-container {
            grid-template-rows: repeat(3, minmax(250px, auto));
        }
        
        .block-content {
            max-height: 200px;
        }
        
        .quick-textarea {
            min-height: 150px;
        }
    }
    
    /* Modo oscuro autom√°tico */
    @media (prefers-color-scheme: dark) {
        .canvas-main-container {
            background-color: #1a1a2e;
        }
        
        .canvas-left-column,
        .canvas-right-column,
        .stat-item,
        .input-box,
        .stats-section,
        .bloque-stat-item {
            background-color: #16213e;
            color: #e6e6e6;
        }
        
        .info-box {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
        }
        
        .stat-label,
        .instructions-list li,
        .bloque-stat-name {
            color: #b0b0b0;
        }
        
        .form-input,
        .form-select,
        .quick-textarea {
            background-color: #0f3460;
            border-color: #1a1a2e;
            color: #e6e6e6;
        }
        
        .tipo-option:not(.selected) {
            background-color: #0f3460;
        }
    }
</style>

<script>
    // ===== VARIABLES GLOBALES Y CONFIGURACI√ìN =====
    let tipoSeleccionado = 'Positivo';
    let ultimaActualizacion = null;
    let intervalId = null;
    let isOnline = true;
    let actividadesCache = new Map();
    
    // Configuraci√≥n de actualizaci√≥n autom√°tica
    const CONFIG = {
        updateInterval: 10000, // 10 segundos
        maxRetries: 3,
        retryDelay: 2000,
        connectionCheckInterval: 5000
    };
    
    // ===== INICIALIZACI√ìN =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîÑ Inicializando CANVA...');
        
        // Inicializar controles
        inicializarControles();
        
        // Cargar datos iniciales
        cargarDatosIniciales();
        
        // Configurar actualizaci√≥n autom√°tica
        configurarAutoActualizacion();
        
        // Configurar monitoreo de conexi√≥n
        configurarMonitoreoConexion();
        
        // Configurar contador de caracteres
        configurarContadorCaracteres();
        
        // Configurar atajos de teclado
        configurarAtajosTeclado();
        
        console.log('‚úÖ CANVA inicializado');
    });
    
    // ===== FUNCIONES DE INICIALIZACI√ìN =====
    function inicializarControles() {
        // Seleccionar primer bloque por defecto
        seleccionarTipo('Positivo');
        
        // Configurar evento para actualizar estad√≠sticas
        document.querySelector('.stats-update').addEventListener('click', forzarActualizacion);
        
        // Configurar validaci√≥n en tiempo real
        document.getElementById('quick-actividad').addEventListener('input', validarFormulario);
    }
    
    function configurarContadorCaracteres() {
        const textarea = document.getElementById('quick-actividad');
        const counter = document.getElementById('char-count');
        
        textarea.addEventListener('input', function() {
            const length = this.value.length;
            counter.textContent = length;
            
            if (length > 450) {
                counter.style.color = '#f44336';
            } else if (length > 400) {
                counter.style.color = '#ff9800';
            } else {
                counter.style.color = '#666';
            }
        });
    }
    
    function configurarAtajosTeclado() {
        document.addEventListener('keydown', function(event) {
            // Ctrl+Enter para guardar
            if (event.ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                guardarActividad();
            }
            
            // Esc para limpiar
            if (event.key === 'Escape') {
                limpiarEntradaRapida();
            }
        });
    }
    
    // ===== FUNCIONES DE ACTUALIZACI√ìN AUTOM√ÅTICA =====
    function configurarAutoActualizacion() {
        // Iniciar intervalo para actualizaci√≥n autom√°tica
        intervalId = setInterval(actualizarDatosDesdeBD, CONFIG.updateInterval);
        
        console.log(`üîÑ Actualizaci√≥n autom√°tica configurada cada ${CONFIG.updateInterval/1000}s`);
    }
    
    function configurarMonitoreoConexion() {
        // Verificar conexi√≥n peri√≥dicamente
        setInterval(() => {
            const wasOnline = isOnline;
            isOnline = navigator.onLine;
            
            if (wasOnline !== isOnline) {
                actualizarEstadoConexion();
                
                if (isOnline) {
                    // Reconectado - actualizar datos
                    forzarActualizacion();
                }
            }
        }, CONFIG.connectionCheckInterval);
        
        // Escuchar eventos de conexi√≥n
        window.addEventListener('online', () => {
            isOnline = true;
            actualizarEstadoConexion();
            forzarActualizacion();
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            actualizarEstadoConexion();
        });
    }
    
    function actualizarEstadoConexion() {
        const statusElement = document.getElementById('connection-status');
        
        if (isOnline) {
            statusElement.innerHTML = '<i class="fas fa-circle"></i> Conectado';
            statusElement.style.color = 'var(--positive-color)';
            statusElement.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
        } else {
            statusElement.innerHTML = '<i class="fas fa-circle"></i> Sin conexi√≥n';
            statusElement.style.color = '#ff9800';
            statusElement.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
        }
    }
    
    // ===== FUNCIONES DE CARGA DE DATOS =====
    async function cargarDatosIniciales() {
        mostrarEstadoCarga('Cargando datos iniciales...');
        
        try {
            const response = await fetch('/api/aspectos/canva');
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                procesarDatos(data.actividades);
                actualizarEstadisticas(data.actividades);
                mostrarEstadoCarga('‚úÖ Datos cargados correctamente', 'success');
                
                // Actualizar timestamp
                actualizarTimestamp();
                
                // Guardar en cach√©
                guardarEnCache(data.actividades);
            } else {
                throw new Error(data.message || 'Error en la respuesta del servidor');
            }
        } catch (error) {
            console.error('Error cargando datos iniciales:', error);
            mostrarEstadoCarga('‚ö†Ô∏è Usando datos en cach√©', 'warning');
            
            // Intentar cargar desde cach√©
            cargarDesdeCache();
        }
    }
    
    async function actualizarDatosDesdeBD() {
        if (!isOnline) {
            mostrarEstadoCarga('‚ö†Ô∏è Sin conexi√≥n - Reintentando...', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/aspectos/canva?_=' + Date.now());
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                const cambios = detectarCambios(data.actividades);
                
                if (cambios.hayCambios) {
                    procesarDatos(data.actividades);
                    actualizarEstadisticas(data.actividades);
                    mostrarCambiosRecientes(cambios);
                    actualizarTimestamp();
                    guardarEnCache(data.actividades);
                }
                
                // Actualizar indicador de actualizaci√≥n
                const updateIndicator = document.getElementById('stats-update');
                updateIndicator.style.color = 'var(--positive-color)';
                updateIndicator.title = 'Actualizado recientemente';
                
                setTimeout(() => {
                    updateIndicator.style.color = '';
                    updateIndicator.title = '';
                }, 3000);
            }
        } catch (error) {
            console.warn('Error en actualizaci√≥n autom√°tica:', error);
            
            if (isOnline) {
                mostrarEstadoCarga('‚ö†Ô∏è Error de conexi√≥n con el servidor', 'error');
            }
        }
    }
    
    function forzarActualizacion() {
        // Mostrar animaci√≥n de actualizaci√≥n
        const refreshBtn = document.querySelector('.action-button.refresh');
        const originalHTML = refreshBtn.innerHTML;
        
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
        refreshBtn.disabled = true;
        
        // Forzar actualizaci√≥n
        actualizarDatosDesdeBD().finally(() => {
            setTimeout(() => {
                refreshBtn.innerHTML = originalHTML;
                refreshBtn.disabled = false;
            }, 1000);
        });
    }
    
    // ===== FUNCIONES DE PROCESAMIENTO DE DATOS =====
    function procesarDatos(actividades) {
        // Limpiar todos los bloques
        for (let i = 1; i <= 9; i++) {
            const contenido = document.getElementById(`contenido-${i}`);
            if (contenido) {
                contenido.innerHTML = '';
            }
        }
        
        // Ordenar actividades por fecha (m√°s recientes primero)
        actividades.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        // Agrupar actividades por bloque
        const actividadesPorBloque = {};
        
        actividades.forEach(actividad => {
            if (!actividadesPorBloque[actividad.tipo]) {
                actividadesPorBloque[actividad.tipo] = [];
            }
            actividadesPorBloque[actividad.tipo].push(actividad);
        });
        
        // Procesar cada bloque
        {% for bloque in bloques_canva %}
        const actividadesBloque{{ loop.index }} = actividadesPorBloque["{{ bloque.nombre }}"] || [];
        const contenido{{ loop.index }} = document.getElementById('contenido-{{ loop.index }}');
        const counter{{ loop.index }} = document.getElementById('counter-{{ loop.index }}');
        
        if (contenido{{ loop.index }} && counter{{ loop.index }}) {
            // Actualizar contador
            counter{{ loop.index }}.textContent = `${actividadesBloque{{ loop.index }}.length} actividades`;
            
            // Agregar actividades
            actividadesBloque{{ loop.index }}.forEach(actividad => {
                agregarActividadAlBloqueUI(actividad, {{ loop.index }});
            });
        }
        {% endfor %}
    }
    
    function agregarActividadAlBloqueUI(actividad, bloqueIndex) {
        const contenido = document.getElementById(`contenido-${bloqueIndex}`);
        
        if (!contenido) return;
        
        const colorTexto = actividad.aspecto.startsWith('Positivo:') ? 'green' : '#8B0000';
        const iconoTipo = actividad.aspecto.startsWith('Positivo:') ? 
            '<i class="fas fa-thumbs-up"></i>' : 
            '<i class="fas fa-thumbs-down"></i>';
        
        const divActividad = document.createElement('div');
        divActividad.className = 'actividad-item';
        divActividad.style.color = colorTexto;
        divActividad.innerHTML = `
            <span class="actividad-texto">‚Ä¢ ${actividad.actividad}</span>
            <span class="actividad-tipo">${iconoTipo}</span>
        `;
        
        // Agregar tooltip con m√°s informaci√≥n
        divActividad.title = `Creado: ${new Date(actividad.created_at).toLocaleDateString()}\n${actividad.aspecto}`;
        
        // Agregar al inicio
        contenido.insertBefore(divActividad, contenido.firstChild);
        
        // Limitar a 10 actividades por bloque
        if (contenido.children.length > 10) {
            contenido.removeChild(contenido.lastChild);
        }
    }
    
    function actualizarEstadisticas(actividades) {
        // Calcular estad√≠sticas
        const total = actividades.length;
        const positivas = actividades.filter(a => a.aspecto.startsWith('Positivo:')).length;
        const negativas = total - positivas;
        
        // Actualizar estad√≠sticas principales
        document.getElementById('total-actividades').textContent = total;
        document.getElementById('total-positivas').textContent = positivas;
        document.getElementById('total-negativas').textContent = negativas;
        
        // Calcular actividades por bloque
        const actividadesPorBloque = {};
        
        {% for bloque in bloques_canva %}
        actividadesPorBloque[{{ loop.index }}] = actividades.filter(a => a.tipo === "{{ bloque.nombre }}").length;
        {% endfor %}
        
        // Actualizar estad√≠sticas de bloques
        actualizarEstadisticasBloques(actividadesPorBloque, total);
    }
    
    function actualizarEstadisticasBloques(actividadesPorBloque, total) {
        const container = document.getElementById('bloque-stats');
        
        if (!container) return;
        
        let html = '';
        
        {% for bloque in bloques_canva %}
        const count{{ loop.index }} = actividadesPorBloque[{{ loop.index }}] || 0;
        const porcentaje{{ loop.index }} = total > 0 ? (count{{ loop.index }} / total * 100) : 0;
        
        html += `
            <div class="bloque-stat-item">
                <span class="bloque-stat-name">{{ loop.index }}. {{ bloque.nombre[:25] }}...</span>
                <div class="bloque-stat-bar">
                    <div class="bloque-stat-fill" 
                         style="width: ${porcentaje{{ loop.index }} > 0 ? Math.max(porcentaje{{ loop.index }}, 5) : 0}%"
                         data-count="${count{{ loop.index }}}">
                    </div>
                </div>
                <span class="bloque-stat-count">${count{{ loop.index }}}</span>
            </div>
        `;
        {% endfor %}
        
        container.innerHTML = html;
    }
    
    // ===== FUNCIONES DE DETECCI√ìN DE CAMBIOS =====
    function detectarCambios(nuevasActividades) {
        const cambios = {
            hayCambios: false,
            nuevas: [],
            eliminadas: [],
            total: 0
        };
        
        const cacheArray = Array.from(actividadesCache.values());
        
        // Buscar nuevas actividades
        nuevasActividades.forEach(actividad => {
            if (!actividadesCache.has(actividad.id)) {
                cambios.nuevas.push(actividad);
                cambios.hayCambios = true;
            }
        });
        
        // Buscar actividades eliminadas
        cacheArray.forEach(actividadCache => {
            const existe = nuevasActividades.find(a => a.id === actividadCache.id);
            if (!existe) {
                cambios.eliminadas.push(actividadCache);
                cambios.hayCambios = true;
            }
        });
        
        cambios.total = nuevasActividades.length;
        
        return cambios;
    }
    
    function mostrarCambiosRecientes(cambios) {
        if (cambios.nuevas.length > 0) {
            // Mostrar notificaci√≥n de nuevas actividades
            mostrarNotificacion(`üÜï ${cambios.nuevas.length} nueva(s) actividad(es) detectada(s)`);
            
            // Resaltar bloques con cambios
            cambios.nuevas.forEach(actividad => {
                {% for bloque in bloques_canva %}
                if (actividad.tipo === "{{ bloque.nombre }}") {
                    const bloqueElement = document.getElementById(`bloque-{{ loop.index }}`);
                    if (bloqueElement) {
                        bloqueElement.classList.add('highlight');
                        setTimeout(() => {
                            bloqueElement.classList.remove('highlight');
                        }, 3000);
                    }
                }
                {% endfor %}
            });
        }
    }
    
    // ===== FUNCIONES DE CACH√â =====
    function guardarEnCache(actividades) {
        actividadesCache.clear();
        actividades.forEach(actividad => {
            actividadesCache.set(actividad.id, actividad);
        });
        
        localStorage.setItem('canva_cache', JSON.stringify({
            actividades: actividades,
            timestamp: Date.now()
        }));
    }
    
    function cargarDesdeCache() {
        const cacheData = localStorage.getItem('canva_cache');
        
        if (cacheData) {
            try {
                const parsed = JSON.parse(cacheData);
                const ahora = Date.now();
                const unaHora = 60 * 60 * 1000;
                
                if (ahora - parsed.timestamp < unaHora) {
                    procesarDatos(parsed.actividades);
                    actualizarEstadisticas(parsed.actividades);
                    mostrarEstadoCarga('‚úÖ Datos cargados desde cach√©', 'success');
                    return true;
                }
            } catch (error) {
                console.error('Error cargando cach√©:', error);
            }
        }
        
        return false;
    }
    
    // ===== FUNCIONES DEL FORMULARIO =====
    function seleccionarTipo(tipo) {
        tipoSeleccionado = tipo;
        
        // Actualizar UI
        const btnPositivo = document.getElementById('btn-positivo');
        const btnNegativo = document.getElementById('btn-negativo');
        
        if (tipo === 'Positivo') {
            btnPositivo.classList.add('selected');
            btnNegativo.classList.remove('selected');
            btnPositivo.style.opacity = '1';
            btnNegativo.style.opacity = '0.6';
        } else {
            btnNegativo.classList.add('selected');
            btnPositivo.classList.remove('selected');
            btnNegativo.style.opacity = '1';
            btnPositivo.style.opacity = '0.6';
        }
    }
    
    async function guardarActividad() {
        if (!validarFormulario()) {
            return;
        }
        
        const actividad = document.getElementById('quick-actividad').value.trim();
        const tipoPositivoNegativo = tipoSeleccionado;
        const bloqueSelect = document.getElementById('bloque-select');
        const bloqueIndex = parseInt(bloqueSelect.value);
        const bloqueNombre = bloqueSelect.options[bloqueSelect.selectedIndex].text.replace(/^\d+\.\s/, '');
        const descripcion = document.getElementById('tipo-descripcion').value.trim();
        
        // Mostrar indicador de carga
        const guardarBtn = document.querySelector('.quick-action-btn.save');
        const originalHTML = guardarBtn.innerHTML;
        guardarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        guardarBtn.disabled = true;
        
        // Preparar datos
        const datos = {
            actividad: actividad,
            tipo: bloqueNombre,
            aspecto: `${tipoPositivoNegativo}: ${descripcion}`,
            fuente: 'canva'
        };
        
        try {
            const response = await fetch('/guardar_actividad_canva', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(datos)
            });
            
            const data = await response.json();
            
            if (data.success) {
                mostrarEstadoFormulario('‚úÖ Actividad guardada correctamente', 'success');
                
                // Forzar actualizaci√≥n inmediata
                setTimeout(forzarActualizacion, 500);
                
                // Limpiar formulario
                limpiarEntradaRapida();
                
                // Agregar visualmente al bloque correspondiente
                datos.id = data.id;
                datos.created_at = new Date().toISOString();
                agregarActividadAlBloqueUI(datos, bloqueIndex);
                
                // Actualizar contador del bloque
                const counter = document.getElementById(`counter-${bloqueIndex}`);
                if (counter) {
                    const currentCount = parseInt(counter.textContent) || 0;
                    counter.textContent = `${currentCount + 1} actividades`;
                }
            } else {
                throw new Error(data.message || 'Error al guardar');
            }
        } catch (error) {
            console.error('Error guardando actividad:', error);
            mostrarEstadoFormulario(`‚ùå Error: ${error.message}`, 'error');
        } finally {
            // Restaurar bot√≥n
            guardarBtn.innerHTML = originalHTML;
            guardarBtn.disabled = false;
        }
    }
    
    function validarFormulario() {
        const actividad = document.getElementById('quick-actividad').value.trim();
        const descripcion = document.getElementById('tipo-descripcion').value.trim();
        const statusElement = document.getElementById('form-status');
        
        if (!actividad || actividad.length < 3) {
            mostrarEstadoFormulario('‚ö†Ô∏è La actividad debe tener al menos 3 caracteres', 'error');
            return false;
        }
        
        if (actividad.length > 500) {
            mostrarEstadoFormulario('‚ö†Ô∏è La actividad no puede exceder 500 caracteres', 'error');
            return false;
        }
        
        if (!descripcion || descripcion.length < 3) {
            mostrarEstadoFormulario('‚ö†Ô∏è La descripci√≥n debe tener al menos 3 caracteres', 'error');
            return false;
        }
        
        statusElement.style.display = 'none';
        return true;
    }
    
    function limpiarEntradaRapida() {
        document.getElementById('quick-actividad').value = '';
        document.getElementById('tipo-descripcion').value = 'Generaci√≥n de empleo local';
        document.getElementById('char-count').textContent = '0';
        document.getElementById('form-status').style.display = 'none';
        
        seleccionarTipo('Positivo');
        document.getElementById('bloque-select').selectedIndex = 0;
        
        document.getElementById('quick-actividad').focus();
    }
    
    // ===== FUNCIONES DE UTILIDAD =====
    function mostrarEstadoFormulario(mensaje, tipo) {
        const statusElement = document.getElementById('form-status');
        
        statusElement.textContent = mensaje;
        statusElement.className = `form-status ${tipo}`;
        statusElement.style.display = 'block';
        
        if (tipo !== 'error') {
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }
    }
    
    function mostrarEstadoCarga(mensaje, tipo = 'info') {
        const timeElement = document.getElementById('last-update-time');
        
        if (tipo === 'success') {
            timeElement.innerHTML = `<i class="fas fa-check-circle" style="color: var(--positive-color)"></i> ${mensaje}`;
        } else if (tipo === 'error') {
            timeElement.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #f44336"></i> ${mensaje}`;
        } else if (tipo === 'warning') {
            timeElement.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #ff9800"></i> ${mensaje}`;
        } else {
            timeElement.innerHTML = `<i class="fas fa-info-circle"></i> ${mensaje}`;
        }
    }
    
    function actualizarTimestamp() {
        const now = new Date();
        const timeElement = document.getElementById('last-update-time');
        
        const timeString = now.toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
        });
        
        timeElement.innerHTML = `<i class="fas fa-clock"></i> √öltima actualizaci√≥n: ${timeString}`;
        ultimaActualizacion = now;
    }
    
    function mostrarNotificacion(mensaje) {
        // Crear elemento de notificaci√≥n
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-bell"></i>
                <span>${mensaje}</span>
            </div>
        `;
        
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--color1);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideInRight 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    // ===== FUNCIONES DE ACCI√ìN =====
    function guardarCanvaCompleto() {
        mostrarNotificacion('üíæ Guardando estado completo del CANVA...');
        // Aqu√≠ se implementar√≠a la l√≥gica para guardar el estado completo
    }
    
    function exportarCanva() {
        mostrarNotificacion('üìÑ Generando exportaci√≥n en PDF...');
        // Aqu√≠ se implementar√≠a la l√≥gica para exportar
    }
    
    async function limpiarCanva() {
        if (!confirm('‚ö†Ô∏è ¬øEst√° seguro de eliminar TODAS las actividades del CANVA?\n\nEsta acci√≥n es irreversible.')) {
            return;
        }
        
        try {
            const response = await fetch('/limpiar_canva', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                mostrarNotificacion('‚úÖ CANVA limpiado correctamente');
                forzarActualizacion();
            } else {
                mostrarNotificacion(`‚ùå Error: ${data.message}`);
            }
        } catch (error) {
            mostrarNotificacion('‚ùå Error de conexi√≥n');
        }
    }
    
    // ===== MANEJO DE ERRORES Y RECONEXI√ìN =====
    window.addEventListener('error', function(event) {
        console.error('Error global:', event.error);
        mostrarEstadoCarga('‚ö†Ô∏è Error en la aplicaci√≥n', 'error');
    });
    
    // Limpiar intervalos al salir de la p√°gina
    window.addEventListener('beforeunload', function() {
        if (intervalId) {
            clearInterval(intervalId);
        }
    });
</script>

{% endblock %}
