{% extends "inicio.html" %}

{% block content %}
<div class="canvas-main-container">
    <h1 class="content-title">Modelo CANVA - Análisis Estratégico</h1>
    
    <div class="canvas-layout">
        <!-- Columna Izquierda - Los 9 bloques del CANVA -->
        <div class="canvas-left-column">
            <div class="canvas-container">
                {% for bloque in bloques_canva %}
                <div class="canvas-block block{{ loop.index }}" 
                     data-aspecto="{{ bloque.nombre }}">
                    <div class="block-title">
                        <i class="{{ bloque.icono }}"></i> {{ loop.index }}. {{ bloque.nombre }}
                    </div>
                    <div class="block-content" id="contenido-{{ loop.index }}">
                        <!-- Las actividades se cargarán dinámicamente aquí -->
                        {% for aspecto in aspectos_canva if aspecto.tipo == bloque.nombre %}
                        <div class="actividad-item" style="color: {{ 'green' if aspecto.aspecto == 'Positivo' else '#8B0000' }};">
                            • {{ aspecto.actividad }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="canvas-actions">
                <button class="action-button" onclick="guardarCanvaCompleto()">
                    <i class="fas fa-save"></i> Guardar CANVA
                </button>
                <button class="action-button" onclick="exportarCanva()">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <button class="action-button" onclick="limpiarCanva()">
                    <i class="fas fa-broom"></i> Limpiar
                </button>
            </div>
        </div>
        
        <!-- Columna Derecha - Formulario para ingresar actividades -->
        <div class="canvas-right-column">
            <div class="quick-input-section">
                <h2><i class="fas fa-edit"></i> Ingresar Actividades</h2>
                
                <div class="input-box">
                    <h3><i class="fas fa-tasks"></i> ACTIVIDAD</h3>
                    <textarea id="quick-actividad" 
                              placeholder="Describa la actividad aquí..."
                              rows="4"
                              class="quick-textarea"></textarea>
                </div>
                
                <div class="input-box">
                    <h3><i class="fas fa-balance-scale"></i> TIPO CANVA</h3>
                    <div class="tipo-options">
                        <button class="tipo-option positivo-option selected" 
                                id="btn-positivo"
                                onclick="seleccionarTipo('Positivo')">
                            <i class="fas fa-thumbs-up"></i> Positivo
                        </button>
                        <button class="tipo-option negativo-option" 
                                id="btn-negativo"
                                onclick="seleccionarTipo('Negativo')">
                            <i class="fas fa-thumbs-down"></i> Negativo
                        </button>
                    </div>
                    <input type="hidden" id="quick-tipo" value="Positivo">
                </div>
                
                <div class="input-box">
                    <h3><i class="fas fa-layer-group"></i> BLOQUE CANVA (se guarda como TIPO)</h3>
                    <div class="aspecto-options">
                        {% for bloque in bloques_canva %}
                        <button class="aspecto-option" 
                                onclick="seleccionarAspecto('{{ bloque.nombre }}')"
                                data-aspecto="{{ bloque.nombre }}">
                            {{ loop.index }}. {{ bloque.nombre }}
                        </button>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="quick-aspecto" value="{{ bloques_canva[0].nombre }}">
                </div>
                
                <div class="input-box">
                    <h3><i class="fas fa-font"></i> TIPO DE ASPECTO (se guarda como ASPECTO)</h3>
                    <select id="tipo-aspecto" class="form-select">
                        <option value="Generación de polvo en suspensión">Generación de polvo en suspensión</option>
                        <option value="Consumo de combustible diesel">Consumo de combustible diesel</option>
                        <option value="Producción de relaves">Producción de relaves</option>
                        <option value="Derrames de reactivos químicos">Derrames de reactivos químicos</option>
                        <option value="Generación de empleo local">Generación de empleo local</option>
                        <option value="Desarrollo de infraestructura">Desarrollo de infraestructura</option>
                        <option value="Transferencia de conocimientos">Transferencia de conocimientos</option>
                        <option value="Otro">Otro...</option>
                    </select>
                </div>
                
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="guardarActividad()">
                        <i class="fas fa-save"></i> Guardar Actividad
                    </button>
                    <button class="quick-action-btn secondary" onclick="limpiarEntradaRapida()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>
            
            <div class="info-box">
                <h3><i class="fas fa-info-circle"></i> Instrucciones</h3>
                <ul class="instructions-list">
                    <li><strong>ACTIVIDAD:</strong> Describa la actividad específica</li>
                    <li><strong>TIPO CANVA:</strong> Positivo (verde) o Negativo (rojo oscuro)</li>
                    <li><strong>BLOQUE CANVA:</strong> Se guarda como campo TIPO en la BD</li>
                    <li><strong>TIPO DE ASPECTO:</strong> Se guarda como campo ASPECTO en la BD</li>
                    <li>La FUENTE será automáticamente "canva"</li>
                    <li>CREATED_BY será el usuario actual</li>
                </ul>
            </div>
            
            <div class="stats-section">
                <h3><i class="fas fa-chart-bar"></i> Estadísticas CANVA</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number">{{ total_actividades }}</span>
                        <span class="stat-label">Total Actividades</span>
                    </div>
                    <div class="stat-card positive">
                        <span class="stat-number">{{ positivas }}</span>
                        <span class="stat-label">Positivas</span>
                    </div>
                    <div class="stat-card negative">
                        <span class="stat-number">{{ negativas }}</span>
                        <span class="stat-label">Negativas</span>
                    </div>
                </div>
                <div class="stats-source">
                    <small><i class="fas fa-database"></i> Fuente: Tabla aspectos_ambientales donde fuente='canva'</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estilos CSS (los mismos que antes, pero agregamos) -->
<style>
    /* ... (todos los estilos anteriores se mantienen igual) ... */
    
    /* Estilos adicionales */
    .form-select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
        background-color: white;
    }
    
    .form-select:focus {
        border-color: var(--color2);
        outline: none;
        box-shadow: 0 0 0 3px rgba(77, 124, 138, 0.1);
    }
    
    .stats-source {
        margin-top: 10px;
        padding: 8px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 4px;
        font-size: 12px;
        color: #666;
        text-align: center;
    }
    
    .stats-source i {
        margin-right: 5px;
    }
</style>

<script>
    // Variables globales
    let tipoSeleccionado = 'Positivo';
    let bloqueCanvaSeleccionado = document.getElementById('quick-aspecto').value;
    
    // Inicializar selecciones al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Seleccionar el primer bloque CANVA por defecto
        const primerBloque = document.querySelector('.aspecto-option');
        if (primerBloque) {
            bloqueCanvaSeleccionado = primerBloque.getAttribute('data-aspecto');
            document.getElementById('quick-aspecto').value = bloqueCanvaSeleccionado;
            primerBloque.classList.add('selected');
        }
        
        // Seleccionar tipo positivo por defecto
        seleccionarTipo('Positivo');
    });
    
    // Función para seleccionar tipo (Positivo/Negativo)
    function seleccionarTipo(tipo) {
        tipoSeleccionado = tipo;
        
        // Actualizar UI de botones
        const btnPositivo = document.getElementById('btn-positivo');
        const btnNegativo = document.getElementById('btn-negativo');
        
        if (tipo === 'Positivo') {
            btnPositivo.classList.add('selected');
            btnNegativo.classList.remove('selected');
            btnPositivo.style.opacity = '1';
            btnNegativo.style.opacity = '0.5';
            btnPositivo.style.backgroundColor = '#e8f5e9';
            btnNegativo.style.backgroundColor = '#f8f9fa';
        } else {
            btnNegativo.classList.add('selected');
            btnPositivo.classList.remove('selected');
            btnNegativo.style.opacity = '1';
            btnPositivo.style.opacity = '0.5';
            btnNegativo.style.backgroundColor = '#ffebee';
            btnPositivo.style.backgroundColor = '#f8f9fa';
        }
        
        // Actualizar campo oculto
        document.getElementById('quick-tipo').value = tipo;
    }
    
    // Función para seleccionar bloque CANVA
    function seleccionarAspecto(bloque) {
        bloqueCanvaSeleccionado = bloque;
        
        // Actualizar UI
        document.querySelectorAll('.aspecto-option').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        document.querySelector(`.aspecto-option[data-aspecto="${bloque}"]`).classList.add('selected');
        
        // Actualizar campo oculto
        document.getElementById('quick-aspecto').value = bloque;
    }
    
    // Función para guardar actividad en la base de datos
    function guardarActividad() {
        const actividad = document.getElementById('quick-actividad').value.trim();
        const tipoPositivoNegativo = tipoSeleccionado; // "Positivo" o "Negativo"
        const tipoBloqueCanva = bloqueCanvaSeleccionado; // Ej: "Mapeo de Actores..."
        const tipoAspecto = document.getElementById('tipo-aspecto').value; // Ej: "Generación de polvo..."
        
        if (!actividad) {
            mostrarAlerta('Por favor, ingrese una actividad.', 'error');
            return;
        }
        
        if (!tipoBloqueCanva) {
            mostrarAlerta('Por favor, seleccione un bloque CANVA.', 'error');
            return;
        }
        
        // Mapear "Positivo"/"Negativo" al valor que se guardará en el campo "aspecto"
        // En tu BD, "aspecto" guarda cosas como "Generación de polvo en suspensión"
        // Vamos a combinar: "Positivo: Generación de empleo local" o similar
        const aspectoParaBD = tipoPositivoNegativo === 'Positivo' ? 
            `Positivo: ${tipoAspecto}` : 
            `Negativo: ${tipoAspecto}`;
        
        // Crear objeto con los datos a enviar
        const datos = {
            actividad: actividad,
            tipo: tipoBloqueCanva, // Esto va al campo "tipo" en la BD
            aspecto: aspectoParaBD, // Esto va al campo "aspecto" en la BD
            fuente: 'canva'
        };
        
        // Enviar datos al servidor
        fetch('/guardar_actividad_canva', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(datos)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('Actividad guardada correctamente en la BD.', 'success');
                limpiarEntradaRapida();
                
                // Actualizar el bloque correspondiente en el CANVA
                agregarActividadAlBloque(actividad, tipoPositivoNegativo, tipoBloqueCanva);
                
                // Recargar la página para actualizar estadísticas
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                mostrarAlerta('Error al guardar la actividad: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta('Error de conexión al servidor.', 'error');
        });
    }
    
    // Función para agregar actividad al bloque correspondiente (solo visual)
    function agregarActividadAlBloque(actividad, tipoPositivoNegativo, tipoBloqueCanva) {
        // Encontrar el bloque correspondiente
        const bloques = document.querySelectorAll('.canvas-block');
        let bloqueEncontrado = null;
        
        bloques.forEach(bloque => {
            if (bloque.getAttribute('data-aspecto') === tipoBloqueCanva) {
                bloqueEncontrado = bloque;
            }
        });
        
        if (bloqueEncontrado) {
            const contenido = bloqueEncontrado.querySelector('.block-content');
            const colorTexto = tipoPositivoNegativo === 'Positivo' ? 'green' : '#8B0000';
            
            // Crear elemento para la nueva actividad
            const divActividad = document.createElement('div');
            divActividad.className = 'actividad-item';
            divActividad.style.color = colorTexto;
            divActividad.textContent = '• ' + actividad;
            
            // Agregar al inicio del contenido
            contenido.insertBefore(divActividad, contenido.firstChild);
        }
    }
    
    // Función para limpiar el formulario de entrada rápida
    function limpiarEntradaRapida() {
        document.getElementById('quick-actividad').value = '';
        seleccionarTipo('Positivo');
        
        // Seleccionar el primer bloque
        const primerBloque = document.querySelector('.aspecto-option');
        if (primerBloque) {
            seleccionarAspecto(primerBloque.getAttribute('data-aspecto'));
        }
        
        // Restablecer el select de tipo de aspecto
        document.getElementById('tipo-aspecto').value = 'Generación de polvo en suspensión';
    }
    
    // Función para mostrar alertas
    function mostrarAlerta(mensaje, tipo) {
        // Crear elemento de alerta
        let alerta = document.getElementById('alerta-flotante');
        
        if (!alerta) {
            alerta = document.createElement('div');
            alerta.id = 'alerta-flotante';
            alerta.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
                transform: translateX(100%);
                opacity: 0;
            `;
            document.body.appendChild(alerta);
        }
        
        // Configurar estilo según tipo
        if (tipo === 'success') {
            alerta.style.backgroundColor = '#4CAF50';
        } else {
            alerta.style.backgroundColor = '#f44336';
        }
        
        alerta.textContent = mensaje;
        
        // Mostrar alerta
        setTimeout(() => {
            alerta.style.transform = 'translateX(0)';
            alerta.style.opacity = '1';
        }, 10);
        
        // Ocultar después de 3 segundos
        setTimeout(() => {
            alerta.style.transform = 'translateX(100%)';
            alerta.style.opacity = '0';
        }, 3000);
    }
    
    // Función para guardar el CANVA completo
    function guardarCanvaCompleto() {
        mostrarAlerta('CANVA guardado correctamente.', 'success');
    }
    
    // Función para exportar el CANVA
    function exportarCanva() {
        mostrarAlerta('Preparando exportación del CANVA...', 'success');
    }
    
    // Función para limpiar el CANVA (solo actividades con fuente='canva')
    function limpiarCanva() {
        if (confirm('¿Está seguro de que desea eliminar todas las actividades del CANVA? Esta acción no se puede deshacer.')) {
            fetch('/limpiar_canva', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarAlerta('Todas las actividades del CANVA han sido eliminadas.', 'success');
                    // Limpiar visualmente todos los bloques
                    document.querySelectorAll('.block-content').forEach(contenido => {
                        contenido.innerHTML = '';
                    });
                    // Recargar la página para actualizar estadísticas
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    mostrarAlerta('Error: ' + data.message, 'error');
                }
            });
        }
    }
</script>
{% endblock %}
