{% extends "inicio.html" %}

{% block content %}
<div class="canvas-main-container">
    <h1 class="content-title">Modelo CANVA - Análisis Estratégico</h1>
    
    <div class="canvas-layout">
        <!-- Columna Izquierda - Los 9 bloques del CANVA -->
        <div class="canvas-left-column">
            <div class="canvas-container">
                {% for bloque in bloques_canva %}
                <div class="canvas-block block{{ loop.index }}" 
                     data-aspecto="{{ bloque.nombre }}">
                    <div class="block-title">
                        <i class="{{ bloque.icono }}"></i> {{ loop.index }}. {{ bloque.nombre }}
                    </div>
                    <div class="block-content" id="contenido-{{ loop.index }}">
                        <!-- Las actividades se cargarán dinámicamente aquí -->
                        {% for aspecto in aspectos_canva if aspecto.aspecto == bloque.nombre and aspecto.created_by == 'canva' %}
                        <div class="actividad-item" style="color: {{ 'green' if aspecto.tipo == 'Positivo' else '#8B0000' }};">
                            • {{ aspecto.actividad }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="canvas-actions">
                <button class="action-button" onclick="guardarCanvaCompleto()">
                    <i class="fas fa-save"></i> Guardar CANVA
                </button>
                <button class="action-button" onclick="exportarCanva()">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <button class="action-button" onclick="limpiarCanva()">
                    <i class="fas fa-broom"></i> Limpiar
                </button>
            </div>
        </div>
        
        <!-- Columna Derecha - Formulario para ingresar actividades -->
        <div class="canvas-right-column">
            <div class="quick-input-section">
                <h2><i class="fas fa-edit"></i> Ingresar Actividades</h2>
                
                <div class="input-box">
                    <h3><i class="fas fa-tasks"></i> ACTIVIDAD</h3>
                    <textarea id="quick-actividad" 
                              placeholder="Describa la actividad aquí..."
                              rows="4"
                              class="quick-textarea"></textarea>
                </div>
                
                <div class="input-box">
                    <h3><i class="fas fa-balance-scale"></i> TIPO</h3>
                    <div class="tipo-options">
                        <button class="tipo-option positivo-option selected" 
                                id="btn-positivo"
                                onclick="seleccionarTipo('Positivo')">
                            <i class="fas fa-thumbs-up"></i> Positivo
                        </button>
                        <button class="tipo-option negativo-option" 
                                id="btn-negativo"
                                onclick="seleccionarTipo('Negativo')">
                            <i class="fas fa-thumbs-down"></i> Negativo
                        </button>
                    </div>
                    <input type="hidden" id="quick-tipo" value="Positivo">
                </div>
                
                <div class="input-box">
                    <h3><i class="fas fa-layer-group"></i> BLOQUE CANVA</h3>
                    <div class="aspecto-options">
                        {% for bloque in bloques_canva %}
                        <button class="aspecto-option" 
                                onclick="seleccionarAspecto('{{ bloque.nombre }}')"
                                data-aspecto="{{ bloque.nombre }}">
                            {{ loop.index }}. {{ bloque.nombre }}
                        </button>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="quick-aspecto" value="{{ bloques_canva[0].nombre }}">
                </div>
                
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="guardarActividad()">
                        <i class="fas fa-save"></i> Guardar Actividad
                    </button>
                    <button class="quick-action-btn secondary" onclick="limpiarEntradaRapida()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>
            
            <div class="info-box">
                <h3><i class="fas fa-info-circle"></i> Instrucciones</h3>
                <ul class="instructions-list">
                    <li>Escriba la actividad en el cuadro de texto</li>
                    <li>Seleccione si es Positivo o Negativo</li>
                    <li>Elija el bloque CANVA correspondiente</li>
                    <li>Haga clic en "Guardar Actividad" para almacenar en la BD</li>
                    <li>Las actividades aparecerán automáticamente en los bloques</li>
                    <li><strong>Positivo:</strong> Texto verde | <strong>Negativo:</strong> Texto rojo oscuro</li>
                </ul>
            </div>
            
            <div class="stats-section">
                <h3><i class="fas fa-chart-bar"></i> Estadísticas</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number">{{ total_actividades }}</span>
                        <span class="stat-label">Total Actividades</span>
                    </div>
                    <div class="stat-card positive">
                        <span class="stat-number">{{ positivas }}</span>
                        <span class="stat-label">Positivas</span>
                    </div>
                    <div class="stat-card negative">
                        <span class="stat-number">{{ negativas }}</span>
                        <span class="stat-label">Negativas</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos para el layout del CANVA */
    .canvas-main-container {
        padding: 20px;
    }
    
    .canvas-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-top: 20px;
    }
    
    /* Estilos para la columna izquierda (CANVA) */
    .canvas-left-column {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .canvas-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 15px;
        margin: 20px 0;
    }
    
    .canvas-block {
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
        display: flex;
        flex-direction: column;
        min-height: 200px;
    }
    
    .canvas-block:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }
    
    .block-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        color: white;
    }
    
    .block-title i {
        margin-right: 10px;
        font-size: 20px;
    }
    
    .block-content {
        flex-grow: 1;
        background-color: rgba(255, 255, 255, 0.15);
        border-radius: 6px;
        padding: 12px;
        font-size: 14px;
        line-height: 1.5;
        color: white;
        overflow-y: auto;
        max-height: 150px;
    }
    
    .actividad-item {
        margin-bottom: 8px;
        padding: 4px 8px;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        font-size: 13px;
        transition: background-color 0.3s;
    }
    
    .actividad-item:hover {
        background-color: rgba(0, 0, 0, 0.2);
    }
    
    /* Colores específicos para cada bloque */
    .block1 { background: linear-gradient(135deg, var(--color1) 0%, #2a5298 100%); }
    .block2 { background: linear-gradient(135deg, var(--color2) 0%, #5a8f9c 100%); }
    .block3 { background: linear-gradient(135deg, var(--color3) 0%, #90b2aa 100%); }
    .block4 { background: linear-gradient(135deg, var(--color4) 0%, #a0c098 100%); }
    .block5 { background: linear-gradient(135deg, var(--color5) 0%, #d5e99b 100%); }
    .block6 { background: linear-gradient(135deg, var(--color1) 0%, #3a62a9 100%); }
    .block7 { background: linear-gradient(135deg, var(--color2) 0%, #6a9faf 100%); }
    .block8 { background: linear-gradient(135deg, var(--color3) 0%, #98c2ba 100%); }
    .block9 { background: linear-gradient(135deg, var(--color4) 0%, #b0d0a8 100%); }
    
    .canvas-actions {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
    }
    
    .action-button {
        background-color: var(--color1);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
    }
    
    .action-button:hover {
        background-color: var(--color2);
    }
    
    /* Estilos para la columna derecha (Formulario) */
    .canvas-right-column {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .quick-input-section {
        margin-bottom: 25px;
    }
    
    .quick-input-section h2 {
        color: var(--color1);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--color4);
        font-size: 22px;
    }
    
    .input-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
    }
    
    .input-box h3 {
        color: var(--color3);
        margin-bottom: 10px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quick-textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
    }
    
    .quick-textarea:focus {
        border-color: var(--color2);
        outline: none;
        box-shadow: 0 0 0 3px rgba(77, 124, 138, 0.1);
    }
    
    .tipo-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
    }
    
    .tipo-option {
        padding: 12px;
        border: 2px solid;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background-color: white;
    }
    
    .positivo-option {
        border-color: #4CAF50;
        color: #2e7d32;
    }
    
    .negativo-option {
        border-color: #f44336;
        color: #c62828;
    }
    
    .tipo-option.selected {
        transform: scale(0.98);
    }
    
    .tipo-option:not(.selected) {
        opacity: 0.5;
        background-color: #f8f9fa;
    }
    
    .aspecto-options {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
        padding-right: 5px;
    }
    
    .aspecto-option {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        text-align: left;
        transition: all 0.3s;
    }
    
    .aspecto-option:hover {
        background-color: #e9ecef;
        border-color: var(--color2);
    }
    
    .aspecto-option.selected {
        background-color: var(--color1);
        color: white;
        border-color: var(--color1);
        font-weight: bold;
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
    }
    
    .quick-action-btn {
        padding: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s;
    }
    
    .quick-action-btn:first-child {
        background-color: var(--color1);
        color: white;
    }
    
    .quick-action-btn.secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .quick-action-btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }
    
    /* Estadísticas */
    .stats-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 15px;
    }
    
    .stat-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    
    .stat-card.positive {
        border-left: 4px solid #4CAF50;
    }
    
    .stat-card.negative {
        border-left: 4px solid #f44336;
    }
    
    .stat-number {
        display: block;
        font-size: 24px;
        font-weight: bold;
        color: var(--color1);
    }
    
    .stat-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Info box */
    .info-box {
        background: linear-gradient(135deg, #f0f7ff 0%, #e3f2fd 100%);
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        border-left: 4px solid var(--color1);
    }
    
    .instructions-list {
        margin: 10px 0 0 20px;
    }
    
    .instructions-list li {
        margin-bottom: 8px;
        color: #495057;
        font-size: 14px;
        line-height: 1.4;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
        .canvas-layout {
            grid-template-columns: 1fr;
        }
        
        .canvas-container {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, auto);
        }
        
        .block1 { grid-column: 1 / 2; grid-row: 1 / 2; }
        .block2 { grid-column: 2 / 3; grid-row: 1 / 2; }
        .block3 { grid-column: 1 / 2; grid-row: 2 / 3; }
        .block4 { grid-column: 2 / 3; grid-row: 2 / 3; }
        .block5 { grid-column: 1 / 2; grid-row: 3 / 4; }
        .block6 { grid-column: 2 / 3; grid-row: 3 / 4; }
        .block7 { grid-column: 1 / 2; grid-row: 4 / 5; }
        .block8 { grid-column: 2 / 3; grid-row: 4 / 5; }
        .block9 { grid-column: 1 / 3; grid-row: 5 / 6; }
    }
    
    @media (max-width: 768px) {
        .canvas-container {
            grid-template-columns: 1fr;
            grid-template-rows: repeat(9, auto);
        }
        
        .block1, .block2, .block3, .block4, .block5, 
        .block6, .block7, .block8, .block9 {
            grid-column: 1 / 2;
        }
        
        .block1 { grid-row: 1 / 2; }
        .block2 { grid-row: 2 / 3; }
        .block3 { grid-row: 3 / 4; }
        .block4 { grid-row: 4 / 5; }
        .block5 { grid-row: 5 / 6; }
        .block6 { grid-row: 6 / 7; }
        .block7 { grid-row: 7 / 8; }
        .block8 { grid-row: 8 / 9; }
        .block9 { grid-row: 9 / 10; }
        
        .canvas-actions {
            flex-direction: column;
        }
        
        .action-button {
            width: 100%;
            justify-content: center;
        }
        
        .quick-actions {
            grid-template-columns: 1fr;
        }
        
        .tipo-options {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    // Variables globales
    let tipoSeleccionado = 'Positivo';
    let aspectoSSeleccionado = document.getElementById('quick-aspecto').value;
    
    // Inicializar selecciones al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Seleccionar el primer aspecto por defecto
        const primerAspecto = document.querySelector('.aspecto-option');
        if (primerAspecto) {
            aspectoSSeleccionado = primerAspecto.getAttribute('data-aspecto');
            document.getElementById('quick-aspecto').value = aspectoSSeleccionado;
            primerAspecto.classList.add('selected');
        }
        
        // Seleccionar tipo positivo por defecto
        seleccionarTipo('Positivo');
        
        // Cargar actividades existentes
        cargarActividadesCanva();
    });
    
    // Función para seleccionar tipo (Positivo/Negativo)
    function seleccionarTipo(tipo) {
        tipoSeleccionado = tipo;
        
        // Actualizar UI de botones
        const btnPositivo = document.getElementById('btn-positivo');
        const btnNegativo = document.getElementById('btn-negativo');
        
        if (tipo === 'Positivo') {
            btnPositivo.classList.add('selected');
            btnNegativo.classList.remove('selected');
            btnPositivo.style.opacity = '1';
            btnNegativo.style.opacity = '0.5';
        } else {
            btnNegativo.classList.add('selected');
            btnPositivo.classList.remove('selected');
            btnNegativo.style.opacity = '1';
            btnPositivo.style.opacity = '0.5';
        }
        
        // Actualizar campo oculto
        document.getElementById('quick-tipo').value = tipo;
    }
    
    // Función para seleccionar aspecto (bloque CANVA)
    function seleccionarAspecto(aspecto) {
        aspectoSSeleccionado = aspecto;
        
        // Actualizar UI
        document.querySelectorAll('.aspecto-option').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        document.querySelector(`.aspecto-option[data-aspecto="${aspecto}"]`).classList.add('selected');
        
        // Actualizar campo oculto
        document.getElementById('quick-aspecto').value = aspecto;
    }
    
    // Función para guardar actividad en la base de datos
    function guardarActividad() {
        const actividad = document.getElementById('quick-actividad').value.trim();
        const tipo = tipoSeleccionado;
        const aspecto = aspectoSSeleccionado;
        
        if (!actividad) {
            mostrarAlerta('Por favor, ingrese una actividad.', 'error');
            return;
        }
        
        if (!aspecto) {
            mostrarAlerta('Por favor, seleccione un bloque CANVA.', 'error');
            return;
        }
        
        // Crear objeto con los datos a enviar
        const datos = {
            actividad: actividad,
            tipo: tipo,
            aspecto: aspecto,
            fuente: 'canva',
            created_by: 'canva'
        };
        
        // Enviar datos al servidor
        fetch('/guardar_actividad_canva', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(datos)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('Actividad guardada correctamente.', 'success');
                limpiarEntradaRapida();
                
                // Actualizar el bloque correspondiente en el CANVA
                agregarActividadAlBloque(actividad, tipo, aspecto);
                
                // Actualizar estadísticas
                actualizarEstadisticas();
            } else {
                mostrarAlerta('Error al guardar la actividad: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta('Error de conexión al servidor.', 'error');
        });
    }
    
    // Función para agregar actividad al bloque correspondiente
    function agregarActividadAlBloque(actividad, tipo, aspecto) {
        // Encontrar el bloque correspondiente
        const bloques = document.querySelectorAll('.canvas-block');
        let bloqueEncontrado = null;
        
        bloques.forEach(bloque => {
            if (bloque.getAttribute('data-aspecto') === aspecto) {
                bloqueEncontrado = bloque;
            }
        });
        
        if (bloqueEncontrado) {
            const contenido = bloqueEncontrado.querySelector('.block-content');
            const colorTexto = tipo === 'Positivo' ? 'green' : '#8B0000';
            
            // Crear elemento para la nueva actividad
            const divActividad = document.createElement('div');
            divActividad.className = 'actividad-item';
            divActividad.style.color = colorTexto;
            divActividad.textContent = '• ' + actividad;
            
            // Agregar al inicio del contenido
            contenido.insertBefore(divActividad, contenido.firstChild);
            
            // Añadir animación
            divActividad.style.opacity = '0';
            divActividad.style.transform = 'translateY(-10px)';
            
            setTimeout(() => {
                divActividad.style.transition = 'opacity 0.3s, transform 0.3s';
                divActividad.style.opacity = '1';
                divActividad.style.transform = 'translateY(0)';
            }, 10);
        }
    }
    
    // Función para cargar actividades desde la base de datos
    function cargarActividadesCanva() {
        fetch('/obtener_actividades_canva')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Limpiar todos los bloques primero
                document.querySelectorAll('.block-content').forEach(contenido => {
                    contenido.innerHTML = '';
                });
                
                // Agregar actividades a cada bloque
                data.actividades.forEach(actividad => {
                    agregarActividadAlBloque(actividad.actividad, actividad.tipo, actividad.aspecto);
                });
                
                actualizarEstadisticas();
            }
        })
        .catch(error => {
            console.error('Error al cargar actividades:', error);
        });
    }
    
    // Función para actualizar estadísticas
    function actualizarEstadisticas() {
        fetch('/obtener_estadisticas_canva')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('.stat-card .stat-number').textContent = data.total;
                document.querySelector('.stat-card.positive .stat-number').textContent = data.positivas;
                document.querySelector('.stat-card.negative .stat-number').textContent = data.negativas;
            }
        });
    }
    
    // Función para limpiar el formulario de entrada rápida
    function limpiarEntradaRapida() {
        document.getElementById('quick-actividad').value = '';
        seleccionarTipo('Positivo');
        
        // Seleccionar el primer aspecto
        const primerAspecto = document.querySelector('.aspecto-option');
        if (primerAspecto) {
            seleccionarAspecto(primerAspecto.getAttribute('data-aspecto'));
        }
    }
    
    // Función para mostrar alertas
    function mostrarAlerta(mensaje, tipo) {
        // Crear elemento de alerta
        let alerta = document.getElementById('alerta-flotante');
        
        if (!alerta) {
            alerta = document.createElement('div');
            alerta.id = 'alerta-flotante';
            alerta.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
                transform: translateX(100%);
                opacity: 0;
            `;
            document.body.appendChild(alerta);
        }
        
        // Configurar estilo según tipo
        if (tipo === 'success') {
            alerta.style.backgroundColor = '#4CAF50';
        } else {
            alerta.style.backgroundColor = '#f44336';
        }
        
        alerta.textContent = mensaje;
        
        // Mostrar alerta
        setTimeout(() => {
            alerta.style.transform = 'translateX(0)';
            alerta.style.opacity = '1';
        }, 10);
        
        // Ocultar después de 3 segundos
        setTimeout(() => {
            alerta.style.transform = 'translateX(100%)';
            alerta.style.opacity = '0';
        }, 3000);
    }
    
    // Función para guardar el CANVA completo
    function guardarCanvaCompleto() {
        // Aquí iría la lógica para guardar el estado completo del CANVA
        mostrarAlerta('CANVA guardado correctamente.', 'success');
    }
    
    // Función para exportar el CANVA
    function exportarCanva() {
        // Aquí iría la lógica para exportar el CANVA
        mostrarAlerta('Preparando exportación del CANVA...', 'success');
    }
    
    // Función para limpiar el CANVA
    function limpiarCanva() {
        if (confirm('¿Está seguro de que desea limpiar todo el CANVA? Esta acción eliminará todas las actividades.')) {
            // Aquí iría la lógica para limpiar el CANVA de la base de datos
            fetch('/limpiar_canva', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarAlerta('CANVA limpiado correctamente.', 'success');
                    // Limpiar visualmente todos los bloques
                    document.querySelectorAll('.block-content').forEach(contenido => {
                        contenido.innerHTML = '';
                    });
                    actualizarEstadisticas();
                }
            });
        }
    }
</script>
{% endblock %}
