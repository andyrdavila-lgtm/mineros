{% extends "inicio.html" %}

{% block content %}
<!-- Mapa Neuronal Estratégico - Sistema Solar Completo -->
<div class="mapa-neuronal-container" id="mapaFullscreen">
    <!-- Cabecera principal -->
    <div class="mapa-header-glass">
        <div class="header-content">
            <h1 class="mapa-title-glow">
                <i class="fas fa-solar-system"></i>
                <span class="title-text">SISTEMA SOLAR ESTRATÉGICO</span>
                <span class="subtitle">Proyecto El Domo</span>
            </h1>
            <div class="header-stats">
                <div class="stat-badge">
                    <i class="fas fa-sun"></i>
                    <span>1 Sol</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-globe"></i>
                    <span id="total-ejes">0 Ejes</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-moon"></i>
                    <span id="total-estrategias">0 Lunas</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-satellite"></i>
                    <span id="total-actividades">0 Satélites</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-meteor"></i>
                    <span id="total-tareas">0 Asteroides</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de controles principal -->
    <div class="panel-controles">
        <div class="grupo-controles">
            <h4><i class="fas fa-cogs"></i> Controles</h4>
            <div class="controles-grid">
                <button class="control-btn tooltip" onclick="toggleFullscreen()" data-tooltip="Pantalla completa">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="control-btn tooltip" onclick="resetView()" data-tooltip="Reiniciar vista">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="control-btn tooltip" onclick="toggleAnimaciones()" data-tooltip="Animaciones">
                    <i class="fas fa-play" id="animacionIcon"></i>
                </button>
                <button class="control-btn tooltip" onclick="iniciarOrbitas()" data-tooltip="Iniciar órbitas">
                    <i class="fas fa-satellite"></i>
                </button>
                <button class="control-btn tooltip" onclick="mostrarFiltros()" data-tooltip="Mostrar filtros">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
        </div>
        
        <!-- Filtros (oculto inicialmente) -->
        <div class="grupo-filtros" id="panelFiltros" style="display: none;">
            <h4><i class="fas fa-filter"></i> Filtros</h4>
            <div class="filtros-grid">
                <div class="filtro-grupo">
                    <label>Filtrar por Eje:</label>
                    <select id="filtroEje" onchange="aplicarFiltros()" class="filtro-select">
                        <option value="todos">Todos los ejes</option>
                        <option value="educacion">Educación</option>
                        <option value="salud">Salud</option>
                        <option value="empleabilidad">Empleabilidad</option>
                        <option value="desarrollo_economico">Desarrollo Económico</option>
                        <option value="sostenibilidad_ambiental">Sostenibilidad Ambiental</option>
                        <option value="comunicacion">Comunicación</option>
                        <option value="institucional">Institucional</option>
                    </select>
                </div>
                
                <div class="filtro-grupo">
                    <label>Filtrar por Tipo:</label>
                    <select id="filtroTipo" onchange="aplicarFiltros()" class="filtro-select">
                        <option value="todos">Todos los tipos</option>
                        <option value="FO">FO - Fortalezas/Oportunidades</option>
                        <option value="DO">DO - Debilidades/Oportunidades</option>
                        <option value="FA">FA - Fortalezas/Amenazas</option>
                        <option value="DA">DA - Debilidades/Amenazas</option>
                    </select>
                </div>
                
                <div class="filtro-grupo">
                    <label>Estado de Tareas:</label>
                    <select id="filtroEstado" onchange="aplicarFiltros()" class="filtro-select">
                        <option value="todos">Todos los estados</option>
                        <option value="pendiente">Pendientes</option>
                        <option value="en_progreso">En progreso</option>
                        <option value="completada">Completadas</option>
                    </select>
                </div>
                
                <div class="filtro-grupo">
                    <label>Mostrar:</label>
                    <div class="filtro-checkboxes">
                        <label class="checkbox-label">
                            <input type="checkbox" id="mostrarEjes" checked onchange="aplicarFiltros()">
                            <span class="checkmark"></span>
                            Ejes (Planetas)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="mostrarEstrategias" checked onchange="aplicarFiltros()">
                            <span class="checkmark"></span>
                            Estrategias (Lunas)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="mostrarActividades" checked onchange="aplicarFiltros()">
                            <span class="checkmark"></span>
                            Actividades (Satélites)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="mostrarTareas" checked onchange="aplicarFiltros()">
                            <span class="checkmark"></span>
                            Tareas (Asteroides)
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Controles de navegación -->
    <div class="controles-navegacion">
        <button class="nav-btn tooltip" onclick="zoomIn()" data-tooltip="Acercar (Ctrl +)">
            <i class="fas fa-search-plus"></i>
        </button>
        <button class="nav-btn tooltip" onclick="zoomOut()" data-tooltip="Alejar (Ctrl -)">
            <i class="fas fa-search-minus"></i>
        </button>
        <button class="nav-btn tooltip" onclick="moverArriba()" data-tooltip="Mover arriba">
            <i class="fas fa-arrow-up"></i>
        </button>
        <button class="nav-btn tooltip" onclick="moverAbajo()" data-tooltip="Mover abajo">
            <i class="fas fa-arrow-down"></i>
        </button>
        <button class="nav-btn tooltip" onclick="moverIzquierda()" data-tooltip="Mover izquierda">
            <i class="fas fa-arrow-left"></i>
        </button>
        <button class="nav-btn tooltip" onclick="moverDerecha()" data-tooltip="Mover derecha">
            <i class="fas fa-arrow-right"></i>
        </button>
        <button class="nav-btn tooltip" onclick="centrarVista()" data-tooltip="Centrar vista">
            <i class="fas fa-crosshairs"></i>
        </button>
    </div>
    
    <!-- Canvas principal -->
    <div class="mapa-canvas-fullscreen" id="mapaCanvas">
        <!-- Fondo estrellado -->
        <div class="estrellas-container" id="estrellasContainer"></div>
        
        <!-- Anillos orbitales concéntricos -->
        <div class="anillos-orbitales" id="anillosOrbitales"></div>
        
        <!-- SVG para conexiones -->
        <svg class="conexiones-svg" id="conexionesSVG"></svg>
        
        <!-- Contenedor del sistema solar -->
        <div class="sistema-solar" id="sistemaSolar">
            <!-- Sol Central Fijo -->
            <div class="orbita-sol" id="orbitaSol">
                <div class="nodo-sol" id="nodo-objetivo">
                    <div class="nodo-glow-sol"></div>
                    <div class="nodo-content">
                        <div class="nodo-icon-pulse-sol">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="nodo-title-glow">OBJETIVO ESTRATÉGICO</div>
                        <button class="btn-ver-mas" onclick="mostrarDetalleObjetivo()">
                            <i class="fas fa-eye"></i> Ver completo
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Planetas (ejes) con órbitas concéntricas -->
            <div class="ejes-orbitales" id="ejesOrbitales"></div>
            
            <!-- Estrategias (lunas) -->
            <div class="estrategias-orbitales" id="estrategiasOrbitales"></div>
            
            <!-- Actividades (satélites) -->
            <div class="actividades-orbitales" id="actividadesOrbitales"></div>
            
            <!-- Tareas (asteroides) -->
            <div class="tareas-orbitales" id="tareasOrbitales"></div>
        </div>
    </div>
    
    <!-- Panel de detalles -->
    <div class="panel-detalles" id="panelDetalles">
        <div class="panel-header">
            <h3 id="detalleTitulo"><i class="fas fa-info-circle"></i> Detalles</h3>
            <button class="panel-close" onclick="cerrarPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-body" id="detalleContenido"></div>
    </div>
</div>

<style>
    /* ================================
       ESTILOS PRINCIPALES MEJORADOS
    ================================ */
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    .mapa-neuronal-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #000428 0%, #000e3b 50%, #001f5c 100%);
        overflow: hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* Cabecera */
    .mapa-header-glass {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0 20px;
        z-index: 1000;
        display: flex;
        align-items: center;
    }
    
    .header-content {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .mapa-title-glow {
        color: white;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .title-text {
        font-size: 22px;
        font-weight: 700;
        letter-spacing: 1px;
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
    }
    
    .subtitle {
        font-size: 14px;
        opacity: 0.8;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .header-stats {
        display: flex;
        gap: 15px;
    }
    
    .stat-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 15px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
        font-size: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Panel de controles principal */
    .panel-controles {
        position: absolute;
        top: 90px;
        right: 20px;
        width: 350px;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(20px);
        border-radius: 15px;
        padding: 20px;
        z-index: 1000;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .grupo-controles h4 {
        color: white;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .controles-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        margin-bottom: 20px;
    }
    
    .control-btn {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(255, 215, 0, 0.2);
        border: 1px solid rgba(255, 215, 0, 0.3);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    .control-btn:hover {
        background: rgba(255, 215, 0, 0.4);
        transform: translateY(-2px);
    }
    
    /* Panel de filtros */
    .grupo-filtros {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .filtros-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .filtro-grupo {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .filtro-grupo label {
        color: white;
        font-size: 12px;
        font-weight: 600;
    }
    
    .filtro-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        padding: 8px 12px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filtro-select:hover {
        background: rgba(255, 255, 255, 0.15);
    }
    
    .filtro-select option {
        background: #1a1a2e;
        color: white;
    }
    
    .filtro-checkboxes {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
        font-size: 13px;
        cursor: pointer;
    }
    
    .checkbox-label input {
        display: none;
    }
    
    .checkmark {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .checkbox-label input:checked + .checkmark {
        background: #4CAF50;
        border-color: #4CAF50;
    }
    
    .checkbox-label input:checked + .checkmark::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
    }
    
    /* Controles de navegación */
    .controles-navegacion {
        position: absolute;
        bottom: 20px;
        left: 20px;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(20px);
        border-radius: 15px;
        padding: 15px;
        z-index: 1000;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-btn {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(0, 100, 255, 0.2);
        border: 1px solid rgba(0, 100, 255, 0.3);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    .nav-btn:hover {
        background: rgba(0, 100, 255, 0.4);
        transform: translateY(-2px);
    }
    
    /* Tooltip general */
    .tooltip {
        position: relative;
    }
    
    .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
        z-index: 1001;
    }
    
    .tooltip:hover::after {
        opacity: 1;
        visibility: visible;
        bottom: 120%;
    }
    
    /* Canvas principal */
    .mapa-canvas-fullscreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        cursor: grab;
        z-index: 1;
    }
    
    .mapa-canvas-fullscreen.grabbing {
        cursor: grabbing;
    }
    
    /* Estrellas de fondo */
    .estrellas-container {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }
    
    .estrella {
        position: absolute;
        background: white;
        border-radius: 50%;
        animation: twinkle 3s infinite;
    }
    
    @keyframes twinkle {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
    }
    
    /* Anillos orbitales concéntricos */
    .anillos-orbitales {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
    }
    
    .anillo-orbital {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.02);
        z-index: 2;
    }
    
    /* SVG para conexiones */
    .conexiones-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 3;
    }
    
    .conexion {
        stroke: rgba(255, 255, 255, 0.2);
        stroke-width: 1;
        stroke-dasharray: 5, 5;
        transition: all 0.3s ease;
    }
    
    .conexion-planeta-luna {
        stroke: rgba(255, 255, 255, 0.3);
    }
    
    .conexion-luna-satelite {
        stroke: rgba(255, 255, 255, 0.2);
    }
    
    .conexion-satelite-asteroide {
        stroke: rgba(255, 255, 255, 0.1);
    }
    
    /* Sistema solar */
    .sistema-solar {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        transition: transform 0.1s linear;
        z-index: 10;
    }
    
    /* Sol Fijo */
    .orbita-sol {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        height: 300px;
        z-index: 100;
    }
    
    .nodo-sol {
        width: 100%;
        height: 100%;
        position: relative;
    }
    
    .nodo-glow-sol {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: radial-gradient(circle, 
            rgba(255, 215, 0, 0.6) 0%, 
            rgba(255, 140, 0, 0.3) 30%, 
            rgba(255, 140, 0, 0) 70%);
        animation: pulseSol 3s infinite;
        filter: blur(30px);
        z-index: -1;
    }
    
    .nodo-sol .nodo-content {
        position: relative;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, #FFD700, #FF8C00);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 60px rgba(255, 215, 0, 0.7);
    }
    
    .nodo-icon-pulse-sol {
        width: 100px;
        height: 100px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        font-size: 48px;
        color: #FF8C00;
        animation: pulseSolIcon 2s infinite;
        box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
    }
    
    .nodo-title-glow {
        font-size: 18px;
        font-weight: 700;
        color: white;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
    }
    
    .btn-ver-mas {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 215, 0, 0.8));
        border: none;
        color: #000;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-ver-mas:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
    }
    
    /* Planetas (ejes) con órbitas concéntricas - CORREGIDO */
    .ejes-orbitales {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        z-index: 90;
    }
    
    .planeta-contenedor {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center center;
        transform: translate(-50%, -50%) rotate(var(--angulo-inicial, 0deg));
        z-index: 90;
    }
    
    .nodo-eje {
        position: absolute;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 90;
        transform: translate(-50%, -50%);
        left: var(--distancia, 0px);
    }
    
    .nodo-eje .nodo-content {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 15px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3),
                    inset 0 0 20px rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }
    
    .nodo-eje:hover .nodo-content {
        transform: scale(1.1);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4),
                    inset 0 0 30px rgba(255, 255, 255, 0.2);
    }
    
    .nodo-eje .nodo-icon {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        font-size: 18px;
        color: #2980b9;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
    
    .nodo-eje .nodo-title {
        font-size: 11px;
        font-weight: 600;
        color: white;
        text-align: center;
        line-height: 1.2;
        word-break: break-word;
        max-width: 80px;
    }
    
    /* Estrategias (lunas) - REDONDAS Y CONECTADAS */
    .estrategias-orbitales {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        z-index: 80;
    }
    
    .luna-contenedor {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center center;
        transform: translate(-50%, -50%) rotate(var(--angulo-inicial, 0deg));
        z-index: 80;
    }
    
    .nodo-estrategia {
        position: absolute;
        border-radius: 50%;
        cursor: pointer;
        z-index: 80;
        transform: translate(-50%, -50%);
        left: var(--distancia, 0px);
    }
    
    .nodo-estrategia .nodo-content {
        background: radial-gradient(circle, rgba(46, 204, 113, 0.9), rgba(39, 174, 96, 0.8));
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 12px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .nodo-estrategia:hover .nodo-content {
        transform: scale(1.1);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }
    
    .nodo-estrategia .nodo-icon {
        width: 25px;
        height: 25px;
        background: rgba(255, 255, 255, 0.9);
        color: #27ae60;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 5px;
        font-size: 12px;
    }
    
    .nodo-estrategia .nodo-title {
        font-size: 9px;
        font-weight: 600;
        color: white;
        text-align: center;
        line-height: 1.1;
        word-break: break-word;
        max-width: 60px;
    }
    
    /* Actividades (satélites) */
    .actividades-orbitales {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        z-index: 70;
    }
    
    .satelite-contenedor {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center center;
        transform: translate(-50%, -50%) rotate(var(--angulo-inicial, 0deg));
        z-index: 70;
    }
    
    .nodo-actividad {
        position: absolute;
        border-radius: 50%;
        cursor: pointer;
        z-index: 70;
        transform: translate(-50%, -50%);
        left: var(--distancia, 0px);
    }
    
    .nodo-actividad .nodo-content {
        background: radial-gradient(circle, rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.8));
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 10px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .nodo-actividad:hover .nodo-content {
        transform: scale(1.1);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }
    
    .nodo-actividad .nodo-icon {
        width: 20px;
        height: 20px;
        background: rgba(255, 255, 255, 0.9);
        color: #c0392b;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 3px;
        font-size: 10px;
    }
    
    .nodo-actividad .nodo-title {
        font-size: 8px;
        font-weight: 600;
        color: white;
        text-align: center;
        line-height: 1;
        word-break: break-word;
        max-width: 50px;
    }
    
    /* Tareas (asteroides) */
    .tareas-orbitales {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        z-index: 60;
    }
    
    .asteroide-contenedor {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center center;
        transform: translate(-50%, -50%) rotate(var(--angulo-inicial, 0deg));
        z-index: 60;
    }
    
    .nodo-tarea {
        position: absolute;
        border-radius: 50%;
        cursor: pointer;
        z-index: 60;
        transform: translate(-50%, -50%);
        left: var(--distancia, 0px);
    }
    
    .nodo-tarea .nodo-content {
        background: radial-gradient(circle, rgba(243, 156, 18, 0.9), rgba(211, 84, 0, 0.8));
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .nodo-tarea:hover .nodo-content {
        transform: scale(1.1);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }
    
    .nodo-tarea .nodo-icon {
        width: 16px;
        height: 16px;
        background: rgba(255, 255, 255, 0.9);
        color: #d35400;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
    }
    
    .nodo-tarea .nodo-title {
        font-size: 7px;
        font-weight: 600;
        color: white;
        text-align: center;
        line-height: 1;
        word-break: break-word;
        max-width: 40px;
        margin-top: 2px;
    }
    
    /* Panel de detalles */
    .panel-detalles {
        position: fixed;
        top: 0;
        right: -400px;
        width: 380px;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(30px);
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 2000;
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
    }
    
    .panel-detalles.open {
        right: 0;
    }
    
    .panel-header {
        padding: 25px;
        background: rgba(0, 20, 60, 0.5);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .panel-header h3 {
        color: white;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .panel-close {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .panel-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }
    
    .panel-body {
        padding: 25px;
        color: rgba(255, 255, 255, 0.9);
    }
    
    /* Animaciones */
    @keyframes pulseSol {
        0%, 100% { opacity: 0.6; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.05); }
    }
    
    @keyframes pulseSolIcon {
        0%, 100% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.8); }
        50% { box-shadow: 0 0 60px rgba(255, 215, 0, 1); }
    }
    
    /* Colores específicos para cada eje */
    .eje-educacion .nodo-content { background: radial-gradient(circle, #3498db, #2980b9) !important; }
    .eje-salud .nodo-content { background: radial-gradient(circle, #e74c3c, #c0392b) !important; }
    .eje-empleabilidad .nodo-content { background: radial-gradient(circle, #2ecc71, #27ae60) !important; }
    .eje-desarrollo_economico .nodo-content { background: radial-gradient(circle, #9b59b6, #8e44ad) !important; }
    .eje-sostenibilidad_ambiental .nodo-content { background: radial-gradient(circle, #1abc9c, #16a085) !important; }
    .eje-comunicacion .nodo-content { background: radial-gradient(circle, #f1c40f, #f39c12) !important; }
    .eje-institucional .nodo-content { background: radial-gradient(circle, #e67e22, #d35400) !important; }
    
    .eje-educacion .nodo-icon { color: #2980b9 !important; }
    .eje-salud .nodo-icon { color: #c0392b !important; }
    .eje-empleabilidad .nodo-icon { color: #27ae60 !important; }
    .eje-desarrollo_economico .nodo-icon { color: #8e44ad !important; }
    .eje-sostenibilidad_ambiental .nodo-icon { color: #16a085 !important; }
    .eje-comunicacion .nodo-icon { color: #f39c12 !important; }
    .eje-institucional .nodo-icon { color: #d35400 !important; }
</style>

<script>
// ================================
// SISTEMA SOLAR CON FILTROS Y NAVEGACIÓN
// ================================

const SISTEMA_SOLAR = {
    ejes: [],
    estrategias: [],
    actividades: [],
    tareas: [],
    animacionesActivas: true,
    filtros: {
        eje: 'todos',
        tipo: 'todos',
        estado: 'todos',
        mostrarEjes: true,
        mostrarEstrategias: true,
        mostrarActividades: true,
        mostrarTareas: true
    }
};

// Variables para navegación
let offsetX = 0;
let offsetY = 0;
let scale = 1;
let isDragging = false;
let lastX = 0;
let lastY = 0;

// Configuración orbital
const CONFIG_ORBITAS = {
    // Distancias desde el sol para cada eje (órbitas concéntricas)
    distanciasEjes: [400, 500, 600, 700, 800, 900, 1000],
    
    // Velocidades de rotación
    velocidadesEjes: [0.8, 0.6, 0.5, 0.4, 0.35, 0.3, 0.25],
    
    // Tamaños de los nodos
    tamanoEjes: [120, 115, 110, 105, 100, 95, 90],
    tamanoEstrategias: 80,
    tamanoActividades: 60,
    tamanoTareas: 40,
    
    // Radios orbitales
    radioLuna: 100,
    radioSatelite: 70,
    radioAsteroide: 40
};

// ================================
// INICIALIZACIÓN
// ================================

document.addEventListener('DOMContentLoaded', function() {
    inicializarSistema();
    crearEstrellas();
    crearAnillosOrbitales();
    crearEjes();
    inicializarNavegacion();
    cargarDatosBackend();
});

function inicializarSistema() {
    const sistemaSolar = document.getElementById('sistemaSolar');
    const canvas = document.getElementById('mapaCanvas');
    const canvasRect = canvas.getBoundingClientRect();
    
    sistemaSolar.style.width = `${canvasRect.width}px`;
    sistemaSolar.style.height = `${canvasRect.height}px`;
}

function crearEstrellas() {
    const container = document.getElementById('estrellasContainer');
    const cantidad = 200;
    
    for (let i = 0; i < cantidad; i++) {
        const estrella = document.createElement('div');
        estrella.className = 'estrella';
        
        const x = Math.random() * 100;
        const y = Math.random() * 100;
        const size = Math.random() * 2 + 1;
        const duracion = Math.random() * 5 + 2;
        const delay = Math.random() * 5;
        
        estrella.style.left = `${x}%`;
        estrella.style.top = `${y}%`;
        estrella.style.width = `${size}px`;
        estrella.style.height = `${size}px`;
        estrella.style.animation = `twinkle ${duracion}s infinite ${delay}s`;
        estrella.style.opacity = Math.random() * 0.5 + 0.3;
        
        container.appendChild(estrella);
    }
}

function crearAnillosOrbitales() {
    const container = document.getElementById('anillosOrbitales');
    container.innerHTML = '';
    
    const sistemaSolar = document.getElementById('sistemaSolar');
    const sistemaRect = sistemaSolar.getBoundingClientRect();
    const centroX = sistemaRect.width / 2;
    const centroY = sistemaRect.height / 2;
    
    // Crear anillos concéntricos para cada eje
    CONFIG_ORBITAS.distanciasEjes.forEach((distancia, index) => {
        const anillo = document.createElement('div');
        anillo.className = 'anillo-orbital';
        
        anillo.style.cssText = `
            width: ${distancia * 2}px;
            height: ${distancia * 2}px;
            top: ${centroY}px;
            left: ${centroX}px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.02);
            z-index: 2;
        `;
        
        container.appendChild(anillo);
    });
}

function crearEjes() {
    const container = document.getElementById('ejesOrbitales');
    container.innerHTML = '';
    
    // Definir ejes estratégicos
    SISTEMA_SOLAR.ejes = [
        {
            id: 'educacion',
            nombre: 'EDUCACIÓN',
            icono: 'graduation-cap',
            color: '#3498db',
            descripcion: 'Mejora de infraestructura educativa y capacitación docente',
            distancia: CONFIG_ORBITAS.distanciasEjes[0],
            velocidad: CONFIG_ORBITAS.velocidadesEjes[0],
            tamano: CONFIG_ORBITAS.tamanoEjes[0],
            anguloInicial: 0
        },
        {
            id: 'salud',
            nombre: 'SALUD',
            icono: 'heartbeat',
            color: '#e74c3c',
            descripcion: 'Equipamiento médico y mejoras en servicios de salud',
            distancia: CONFIG_ORBITAS.distanciasEjes[1],
            velocidad: CONFIG_ORBITAS.velocidadesEjes[1],
            tamano: CONFIG_ORBITAS.tamanoEjes[1],
            anguloInicial: 51.4
        },
        {
            id: 'empleabilidad',
            nombre: 'EMPLEABILIDAD',
            icono: 'briefcase',
            color: '#2ecc71',
            descripcion: 'Formación técnica y oportunidades de empleo local',
            distancia: CONFIG_ORBITAS.distanciasEjes[2],
            velocidad: CONFIG_ORBITAS.velocidadesEjes[2],
            tamano: CONFIG_ORBITAS.tamanoEjes[2],
            anguloInicial: 102.8
        },
        {
            id: 'desarrollo_economico',
            nombre: 'DESARROLLO ECONÓMICO',
            icono: 'chart-line',
            color: '#9b59b6',
            descripcion: 'Impulso al desarrollo económico comunitario',
            distancia: CONFIG_ORBITAS.distanciasEjes[3],
            velocidad: CONFIG_ORBITAS.velocidadesEjes[3],
            tamano: CONFIG_ORBITAS.tamanoEjes[3],
            anguloInicial: 154.2
        },
        {
            id: 'sostenibilidad_ambiental',
            nombre: 'SOSTENIBILIDAD AMBIENTAL',
            icono: 'tint',
            color: '#1abc9c',
            descripcion: 'Gestión sostenible del recurso hídrico y monitoreo ambiental',
            distancia: CONFIG_ORBITAS.distanciasEjes[4],
            velocidad: CONFIG_ORBITAS.velocidadesEjes[4],
            tamano: CONFIG_ORBITAS.tamanoEjes[4],
            anguloInicial: 205.6
        },
        {
            id: 'comunicacion',
            nombre: 'COMUNICACIÓN',
            icono: 'bullhorn',
            color: '#f1c40f',
            descripcion: 'Sistema de comunicación comunitaria y transparencia',
            distancia: CONFIG_ORBITAS.distanciasEjes[5],
            velocidad: CONFIG_ORBITAS.velocidadesEjes[5],
            tamano: CONFIG_ORBITAS.tamanoEjes[5],
            anguloInicial: 257
        },
        {
            id: 'institucional',
            nombre: 'INSTITUCIONAL',
            icono: 'landmark',
            color: '#e67e22',
            descripcion: 'Cooperación técnica con GADs y niveles distritales',
            distancia: CONFIG_ORBITAS.distanciasEjes[6],
            velocidad: CONFIG_ORBITAS.velocidadesEjes[6],
            tamano: CONFIG_ORBITAS.tamanoEjes[6],
            anguloInicial: 308.4
        }
    ];
    
    // Crear cada planeta (eje) en su órbita
    SISTEMA_SOLAR.ejes.forEach((eje, index) => {
        // Contenedor para el planeta
        const planetaContenedor = document.createElement('div');
        planetaContenedor.className = 'planeta-contenedor';
        planetaContenedor.id = `contenedor-${eje.id}`;
        planetaContenedor.dataset.ejeId = eje.id;
        planetaContenedor.style.setProperty('--angulo-inicial', `${eje.anguloInicial}deg`);
        
        // Crear el planeta (nodo eje)
        const planetaDiv = document.createElement('div');
        planetaDiv.className = `nodo nodo-eje eje-${eje.id}`;
        planetaDiv.id = `eje-${eje.id}`;
        planetaDiv.dataset.ejeId = eje.id;
        planetaDiv.dataset.tipo = 'eje';
        planetaDiv.dataset.velocidad = eje.velocidad;
        planetaDiv.dataset.angulo = eje.anguloInicial;
        planetaDiv.style.setProperty('--distancia', `${eje.distancia}px`);
        
        // Tamaño del planeta
        planetaDiv.style.cssText = `
            width: ${eje.tamano}px;
            height: ${eje.tamano}px;
        `;
        
        planetaDiv.innerHTML = `
            <div class="nodo-content">
                <div class="nodo-icon">
                    <i class="fas fa-${eje.icono}"></i>
                </div>
                <div class="nodo-title">${eje.nombre}</div>
            </div>
        `;
        
        // Eventos
        planetaDiv.addEventListener('click', function(e) {
            e.stopPropagation();
            mostrarDetallesEje(eje.id);
        });
        
        // Añadir planeta al contenedor
        planetaContenedor.appendChild(planetaDiv);
        container.appendChild(planetaContenedor);
    });
    
    // Actualizar contador
    document.getElementById('total-ejes').textContent = `${SISTEMA_SOLAR.ejes.length} Ejes`;
}

// ================================
// CARGAR DATOS DEL BACKEND
// ================================

function cargarDatosBackend() {
    // Cargar estrategias con eje
    fetch('/api/estrategias_foda_con_eje')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                SISTEMA_SOLAR.estrategias = data.estrategias;
                document.getElementById('total-estrategias').textContent = `${SISTEMA_SOLAR.estrategias.length} Lunas`;
                
                // Cargar actividades
                return fetch('/api/actividades');
            }
            throw new Error('Error al cargar estrategias');
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                SISTEMA_SOLAR.actividades = data.actividades;
                document.getElementById('total-actividades').textContent = `${SISTEMA_SOLAR.actividades.length} Satélites`;
                
                // Cargar tareas
                return fetch('/api/tareas');
            }
            throw new Error('Error al cargar actividades');
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                SISTEMA_SOLAR.tareas = data.tareas;
                document.getElementById('total-tareas').textContent = `${SISTEMA_SOLAR.tareas.length} Asteroides`;
                
                // Crear todas las lunas, satélites y asteroides
                crearEstrategias();
                iniciarOrbitasPlanetas();
            }
        })
        .catch(error => {
            console.error('Error al cargar datos del backend:', error);
        });
}

function crearEstrategias() {
    const container = document.getElementById('estrategiasOrbitales');
    container.innerHTML = '';
    
    const conexionesSVG = document.getElementById('conexionesSVG');
    conexionesSVG.innerHTML = '';
    
    SISTEMA_SOLAR.estrategias.forEach((estrategia, index) => {
        const eje = SISTEMA_SOLAR.ejes.find(e => e.id === estrategia.eje_id);
        if (!eje) return;
        
        const ejeElement = document.getElementById(`eje-${eje.id}`);
        if (!ejeElement) return;
        
        // Contenedor para la luna (estrategia)
        const lunaContenedor = document.createElement('div');
        lunaContenedor.className = 'luna-contenedor';
        lunaContenedor.id = `contenedor-estrategia-${estrategia.id}`;
        lunaContenedor.dataset.estrategiaId = estrategia.id;
        lunaContenedor.dataset.ejeId = estrategia.eje_id;
        lunaContenedor.dataset.tipo = estrategia.tipo_cruce;
        lunaContenedor.style.setProperty('--angulo-inicial', `${index * 72}deg`);
        
        // Crear la luna (estrategia) - FORMA REDONDA ASEGURADA
        const lunaDiv = document.createElement('div');
        lunaDiv.className = 'nodo nodo-estrategia';
        lunaDiv.id = `estrategia-${estrategia.id}`;
        lunaDiv.dataset.estrategiaId = estrategia.id;
        lunaDiv.dataset.ejeId = estrategia.eje_id;
        lunaDiv.dataset.tipo = 'estrategia';
        lunaDiv.dataset.tipoCruce = estrategia.tipo_cruce;
        lunaDiv.style.setProperty('--distancia', `${CONFIG_ORBITAS.radioLuna}px`);
        
        // Tamaño de la luna
        lunaDiv.style.cssText = `
            width: ${CONFIG_ORBITAS.tamanoEstrategias}px;
            height: ${CONFIG_ORBITAS.tamanoEstrategias}px;
        `;
        
        // Determinar color según tipo de cruce
        let colorTipo = '#2ecc71'; // FO
        switch(estrategia.tipo_cruce) {
            case 'DO': colorTipo = '#3498db'; break;
            case 'FA': colorTipo = '#e74c3c'; break;
            case 'DA': colorTipo = '#f39c12'; break;
        }
        
        lunaDiv.innerHTML = `
            <div class="nodo-content" style="background: radial-gradient(circle, ${colorTipo}, ${oscurecerColor(colorTipo, 20)})">
                <div class="nodo-icon" style="background: rgba(255,255,255,0.9); color: ${colorTipo}">
                    <i class="fas fa-moon"></i>
                </div>
                <div class="nodo-title">${estrategia.estrategia.substring(0, 20)}...</div>
            </div>
        `;
        
        // Eventos
        lunaDiv.addEventListener('click', function(e) {
            e.stopPropagation();
            mostrarDetallesEstrategia(estrategia.id);
        });
        
        // Añadir luna al contenedor
        lunaContenedor.appendChild(lunaDiv);
        container.appendChild(lunaContenedor);
        
        // Crear conexión entre planeta y luna
        crearConexionPlanetaLuna(eje.id, estrategia.id);
        
        // Crear actividades para esta estrategia
        crearActividadesParaEstrategia(estrategia.id);
    });
    
    aplicarFiltros();
}

function crearConexionPlanetaLuna(ejeId, estrategiaId) {
    const conexionesSVG = document.getElementById('conexionesSVG');
    
    // Crear línea SVG
    const linea = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    linea.classList.add('conexion', 'conexion-planeta-luna');
    linea.setAttribute('data-eje', ejeId);
    linea.setAttribute('data-estrategia', estrategiaId);
    
    // Actualizar posición de la línea en cada frame
    function actualizarLinea() {
        const planeta = document.getElementById(`eje-${ejeId}`);
        const luna = document.getElementById(`estrategia-${estrategiaId}`);
        
        if (planeta && luna) {
            const rectPlaneta = planeta.getBoundingClientRect();
            const rectLuna = luna.getBoundingClientRect();
            
            // Calcular centro de los elementos
            const centroPlanetaX = rectPlaneta.left + rectPlaneta.width / 2;
            const centroPlanetaY = rectPlaneta.top + rectPlaneta.height / 2;
            const centroLunaX = rectLuna.left + rectLuna.width / 2;
            const centroLunaY = rectLuna.top + rectLuna.height / 2;
            
            // Actualizar coordenadas de la línea
            linea.setAttribute('x1', centroPlanetaX);
            linea.setAttribute('y1', centroPlanetaY);
            linea.setAttribute('x2', centroLunaX);
            linea.setAttribute('y2', centroLunaY);
        }
        
        if (SISTEMA_SOLAR.animacionesActivas) {
            requestAnimationFrame(actualizarLinea);
        }
    }
    
    conexionesSVG.appendChild(linea);
    requestAnimationFrame(actualizarLinea);
}

function crearActividadesParaEstrategia(estrategiaId) {
    const actividades = SISTEMA_SOLAR.actividades.filter(a => a.estrategia_id == estrategiaId);
    const container = document.getElementById('actividadesOrbitales');
    
    actividades.forEach((actividad, index) => {
        const estrategiaElement = document.getElementById(`estrategia-${estrategiaId}`);
        if (!estrategiaElement) return;
        
        // Contenedor para el satélite (actividad)
        const sateliteContenedor = document.createElement('div');
        sateliteContenedor.className = 'satelite-contenedor';
        sateliteContenedor.id = `contenedor-actividad-${actividad.id}`;
        sateliteContenedor.dataset.actividadId = actividad.id;
        sateliteContenedor.dataset.estrategiaId = estrategiaId;
        sateliteContenedor.style.setProperty('--angulo-inicial', `${index * 90}deg`);
        
        // Crear el satélite (actividad)
        const sateliteDiv = document.createElement('div');
        sateliteDiv.className = 'nodo nodo-actividad';
        sateliteDiv.id = `actividad-${actividad.id}`;
        sateliteDiv.dataset.actividadId = actividad.id;
        sateliteDiv.dataset.tipo = 'actividad';
        sateliteDiv.style.setProperty('--distancia', `${CONFIG_ORBITAS.radioSatelite}px`);
        
        // Tamaño del satélite
        sateliteDiv.style.cssText = `
            width: ${CONFIG_ORBITAS.tamanoActividades}px;
            height: ${CONFIG_ORBITAS.tamanoActividades}px;
        `;
        
        sateliteDiv.innerHTML = `
            <div class="nodo-content">
                <div class="nodo-icon">
                    <i class="fas fa-satellite"></i>
                </div>
                <div class="nodo-title">${actividad.nombre.substring(0, 12)}</div>
            </div>
        `;
        
        // Eventos
        sateliteDiv.addEventListener('click', function(e) {
            e.stopPropagation();
            mostrarDetallesActividad(actividad.id);
        });
        
        // Añadir satélite al contenedor
        sateliteContenedor.appendChild(sateliteDiv);
        container.appendChild(sateliteContenedor);
        
        // Crear conexión entre luna y satélite
        crearConexionLunaSatelite(estrategiaId, actividad.id);
        
        // Crear tareas para esta actividad
        crearTareasParaActividad(actividad.id);
    });
}

function crearConexionLunaSatelite(estrategiaId, actividadId) {
    const conexionesSVG = document.getElementById('conexionesSVG');
    
    const linea = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    linea.classList.add('conexion', 'conexion-luna-satelite');
    linea.setAttribute('data-estrategia', estrategiaId);
    linea.setAttribute('data-actividad', actividadId);
    
    function actualizarLinea() {
        const luna = document.getElementById(`estrategia-${estrategiaId}`);
        const satelite = document.getElementById(`actividad-${actividadId}`);
        
        if (luna && satelite) {
            const rectLuna = luna.getBoundingClientRect();
            const rectSatelite = satelite.getBoundingClientRect();
            
            const centroLunaX = rectLuna.left + rectLuna.width / 2;
            const centroLunaY = rectLuna.top + rectLuna.height / 2;
            const centroSateliteX = rectSatelite.left + rectSatelite.width / 2;
            const centroSateliteY = rectSatelite.top + rectSatelite.height / 2;
            
            linea.setAttribute('x1', centroLunaX);
            linea.setAttribute('y1', centroLunaY);
            linea.setAttribute('x2', centroSateliteX);
            linea.setAttribute('y2', centroSateliteY);
        }
        
        if (SISTEMA_SOLAR.animacionesActivas) {
            requestAnimationFrame(actualizarLinea);
        }
    }
    
    conexionesSVG.appendChild(linea);
    requestAnimationFrame(actualizarLinea);
}

function crearTareasParaActividad(actividadId) {
    const tareas = SISTEMA_SOLAR.tareas.filter(t => t.actividad_id == actividadId);
    const container = document.getElementById('tareasOrbitales');
    
    tareas.forEach((tarea, index) => {
        const actividadElement = document.getElementById(`actividad-${actividadId}`);
        if (!actividadElement) return;
        
        // Contenedor para el asteroide (tarea)
        const asteroideContenedor = document.createElement('div');
        asteroideContenedor.className = 'asteroide-contenedor';
        asteroideContenedor.id = `contenedor-tarea-${tarea.id}`;
        asteroideContenedor.dataset.tareaId = tarea.id;
        asteroideContenedor.dataset.actividadId = actividadId;
        asteroideContenedor.dataset.estado = tarea.estado;
        asteroideContenedor.style.setProperty('--angulo-inicial', `${index * 120}deg`);
        
        // Crear el asteroide (tarea)
        const asteroideDiv = document.createElement('div');
        asteroideDiv.className = 'nodo nodo-tarea';
        asteroideDiv.id = `tarea-${tarea.id}`;
        asteroideDiv.dataset.tareaId = tarea.id;
        asteroideDiv.dataset.tipo = 'tarea';
        asteroideDiv.dataset.estado = tarea.estado;
        asteroideDiv.style.setProperty('--distancia', `${CONFIG_ORBITAS.radioAsteroide}px`);
        
        // Determinar color según estado
        let colorEstado = '#f39c12';
        let iconoEstado = 'fa-clock';
        switch(tarea.estado) {
            case 'completada':
                colorEstado = '#2ecc71';
                iconoEstado = 'fa-check-circle';
                break;
            case 'en_progreso':
                colorEstado = '#3498db';
                iconoEstado = 'fa-spinner';
                break;
        }
        
        // Tamaño del asteroide
        asteroideDiv.style.cssText = `
            width: ${CONFIG_ORBITAS.tamanoTareas}px;
            height: ${CONFIG_ORBITAS.tamanoTareas}px;
        `;
        
        asteroideDiv.innerHTML = `
            <div class="nodo-content" style="background: radial-gradient(circle, ${colorEstado}, ${oscurecerColor(colorEstado, 20)})">
                <div class="nodo-icon" style="background: rgba(255,255,255,0.9); color: ${colorEstado}">
                    <i class="fas ${iconoEstado}"></i>
                </div>
                <div class="nodo-title">${tarea.nombre.substring(0, 8)}</div>
            </div>
        `;
        
        // Eventos
        asteroideDiv.addEventListener('click', function(e) {
            e.stopPropagation();
            mostrarDetallesTarea(tarea.id);
        });
        
        // Añadir asteroide al contenedor
        asteroideContenedor.appendChild(asteroideDiv);
        container.appendChild(asteroideContenedor);
        
        // Crear conexión entre satélite y asteroide
        crearConexionSateliteAsteroide(actividadId, tarea.id);
    });
}

function crearConexionSateliteAsteroide(actividadId, tareaId) {
    const conexionesSVG = document.getElementById('conexionesSVG');
    
    const linea = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    linea.classList.add('conexion', 'conexion-satelite-asteroide');
    linea.setAttribute('data-actividad', actividadId);
    linea.setAttribute('data-tarea', tareaId);
    
    function actualizarLinea() {
        const satelite = document.getElementById(`actividad-${actividadId}`);
        const asteroide = document.getElementById(`tarea-${tareaId}`);
        
        if (satelite && asteroide) {
            const rectSatelite = satelite.getBoundingClientRect();
            const rectAsteroide = asteroide.getBoundingClientRect();
            
            const centroSateliteX = rectSatelite.left + rectSatelite.width / 2;
            const centroSateliteY = rectSatelite.top + rectSatelite.height / 2;
            const centroAsteroideX = rectAsteroide.left + rectAsteroide.width / 2;
            const centroAsteroideY = rectAsteroide.top + rectAsteroide.height / 2;
            
            linea.setAttribute('x1', centroSateliteX);
            linea.setAttribute('y1', centroSateliteY);
            linea.setAttribute('x2', centroAsteroideX);
            linea.setAttribute('y2', centroAsteroideY);
        }
        
        if (SISTEMA_SOLAR.animacionesActivas) {
            requestAnimationFrame(actualizarLinea);
        }
    }
    
    conexionesSVG.appendChild(linea);
    requestAnimationFrame(actualizarLinea);
}

// ================================
// FILTROS FUNCIONALES
// ================================

function mostrarFiltros() {
    const panelFiltros = document.getElementById('panelFiltros');
    panelFiltros.style.display = panelFiltros.style.display === 'none' ? 'block' : 'none';
}

function aplicarFiltros() {
    // Actualizar estado de filtros
    SISTEMA_SOLAR.filtros.eje = document.getElementById('filtroEje').value;
    SISTEMA_SOLAR.filtros.tipo = document.getElementById('filtroTipo').value;
    SISTEMA_SOLAR.filtros.estado = document.getElementById('filtroEstado').value;
    SISTEMA_SOLAR.filtros.mostrarEjes = document.getElementById('mostrarEjes').checked;
    SISTEMA_SOLAR.filtros.mostrarEstrategias = document.getElementById('mostrarEstrategias').checked;
    SISTEMA_SOLAR.filtros.mostrarActividades = document.getElementById('mostrarActividades').checked;
    SISTEMA_SOLAR.filtros.mostrarTareas = document.getElementById('mostrarTareas').checked;
    
    // Aplicar filtros a todos los elementos
    aplicarFiltroEjes();
    aplicarFiltroEstrategias();
    aplicarFiltroActividades();
    aplicarFiltroTareas();
    aplicarFiltroConexiones();
}

function aplicarFiltroEjes() {
    const mostrarEjes = SISTEMA_SOLAR.filtros.mostrarEjes;
    const filtroEje = SISTEMA_SOLAR.filtros.eje;
    
    document.querySelectorAll('.nodo-eje').forEach(eje => {
        const ejeId = eje.dataset.ejeId;
        const mostrar = mostrarEjes && (filtroEje === 'todos' || filtroEje === ejeId);
        eje.style.display = mostrar ? 'block' : 'none';
    });
}

function aplicarFiltroEstrategias() {
    const mostrarEstrategias = SISTEMA_SOLAR.filtros.mostrarEstrategias;
    const filtroEje = SISTEMA_SOLAR.filtros.eje;
    const filtroTipo = SISTEMA_SOLAR.filtros.tipo;
    
    document.querySelectorAll('.nodo-estrategia').forEach(estrategia => {
        const ejeId = estrategia.dataset.ejeId;
        const tipoCruce = estrategia.dataset.tipoCruce;
        const estrategiaObj = SISTEMA_SOLAR.estrategias.find(e => e.id == estrategia.dataset.estrategiaId);
        
        const mostrar = mostrarEstrategias && 
                      (filtroEje === 'todos' || filtroEje === ejeId) &&
                      (filtroTipo === 'todos' || filtroTipo === tipoCruce) &&
                      estrategiaObj;
        
        estrategia.style.display = mostrar ? 'block' : 'none';
    });
}

function aplicarFiltroActividades() {
    const mostrarActividades = SISTEMA_SOLAR.filtros.mostrarActividades;
    
    document.querySelectorAll('.nodo-actividad').forEach(actividad => {
        const estrategiaId = actividad.closest('[data-estrategia-id]')?.dataset.estrategiaId;
        const estrategiaElement = document.getElementById(`estrategia-${estrategiaId}`);
        
        const mostrar = mostrarActividades && 
                       estrategiaElement && 
                       estrategiaElement.style.display !== 'none';
        
        actividad.style.display = mostrar ? 'block' : 'none';
    });
}

function aplicarFiltroTareas() {
    const mostrarTareas = SISTEMA_SOLAR.filtros.mostrarTareas;
    const filtroEstado = SISTEMA_SOLAR.filtros.estado;
    
    document.querySelectorAll('.nodo-tarea').forEach(tarea => {
        const estado = tarea.dataset.estado;
        const actividadId = tarea.closest('[data-actividad-id]')?.dataset.actividadId;
        const actividadElement = document.getElementById(`actividad-${actividadId}`);
        
        const mostrar = mostrarTareas && 
                       (filtroEstado === 'todos' || filtroEstado === estado) &&
                       actividadElement && 
                       actividadElement.style.display !== 'none';
        
        tarea.style.display = mostrar ? 'block' : 'none';
    });
}

function aplicarFiltroConexiones() {
    document.querySelectorAll('.conexion').forEach(conexion => {
        const tipo = conexion.classList.contains('conexion-planeta-luna') ? 'planeta-luna' :
                    conexion.classList.contains('conexion-luna-satelite') ? 'luna-satelite' :
                    'satelite-asteroide';
        
        let mostrar = true;
        
        switch(tipo) {
            case 'planeta-luna':
                const ejeId = conexion.dataset.eje;
                const estrategiaId = conexion.dataset.estrategia;
                const planeta = document.getElementById(`eje-${ejeId}`);
                const luna = document.getElementById(`estrategia-${estrategiaId}`);
                mostrar = planeta && planeta.style.display !== 'none' && 
                         luna && luna.style.display !== 'none';
                break;
                
            case 'luna-satelite':
                const estrategiaId2 = conexion.dataset.estrategia;
                const actividadId = conexion.dataset.actividad;
                const luna2 = document.getElementById(`estrategia-${estrategiaId2}`);
                const satelite = document.getElementById(`actividad-${actividadId}`);
                mostrar = luna2 && luna2.style.display !== 'none' && 
                         satelite && satelite.style.display !== 'none';
                break;
                
            case 'satelite-asteroide':
                const actividadId2 = conexion.dataset.actividad;
                const tareaId = conexion.dataset.tarea;
                const satelite2 = document.getElementById(`actividad-${actividadId2}`);
                const asteroide = document.getElementById(`tarea-${tareaId}`);
                mostrar = satelite2 && satelite2.style.display !== 'none' && 
                         asteroide && asteroide.style.display !== 'none';
                break;
        }
        
        conexion.style.display = mostrar ? 'block' : 'none';
    });
}

// ================================
// ANIMACIONES
// ================================

function animarPlaneta(planetaDiv, eje) {
    let angulo = parseFloat(planetaDiv.dataset.angulo) || 0;
    const velocidad = parseFloat(planetaDiv.dataset.velocidad) || 0.5;
    const contenedor = document.getElementById(`contenedor-${eje.id}`);
    
    function actualizarPosicion() {
        if (!SISTEMA_SOLAR.animacionesActivas || !contenedor) return;
        
        angulo += velocidad * 0.1;
        if (angulo >= 360) angulo = 0;
        
        contenedor.style.setProperty('--angulo-inicial', `${angulo}deg`);
        planetaDiv.dataset.angulo = angulo;
        
        requestAnimationFrame(actualizarPosicion);
    }
    
    requestAnimationFrame(actualizarPosicion);
}

function animarLuna(lunaDiv, estrategia) {
    let angulo = 0;
    const velocidad = 1.2;
    const contenedor = document.getElementById(`contenedor-estrategia-${estrategia.id}`);
    
    function actualizarPosicion() {
        if (!SISTEMA_SOLAR.animacionesActivas || !contenedor) return;
        
        angulo += velocidad * 0.1;
        if (angulo >= 360) angulo = 0;
        
        contenedor.style.setProperty('--angulo-inicial', `${angulo}deg`);
        
        requestAnimationFrame(actualizarPosicion);
    }
    
    requestAnimationFrame(actualizarPosicion);
}

function animarSatelite(sateliteDiv, actividad) {
    let angulo = 0;
    const velocidad = 1.8;
    const contenedor = document.getElementById(`contenedor-actividad-${actividad.id}`);
    
    function actualizarPosicion() {
        if (!SISTEMA_SOLAR.animacionesActivas || !contenedor) return;
        
        angulo += velocidad * 0.1;
        if (angulo >= 360) angulo = 0;
        
        contenedor.style.setProperty('--angulo-inicial', `${angulo}deg`);
        
        requestAnimationFrame(actualizarPosicion);
    }
    
    requestAnimationFrame(actualizarPosicion);
}

function animarAsteroide(asteroideDiv, tarea) {
    let angulo = 0;
    const velocidad = 2.5;
    const contenedor = document.getElementById(`contenedor-tarea-${tarea.id}`);
    
    function actualizarPosicion() {
        if (!SISTEMA_SOLAR.animacionesActivas || !contenedor) return;
        
        angulo += velocidad * 0.1;
        if (angulo >= 360) angulo = 0;
        
        contenedor.style.setProperty('--angulo-inicial', `${angulo}deg`);
        
        // Rotación sobre su propio eje
        const rotacion = (parseFloat(asteroideDiv.dataset.rotacion) || 0) + 2;
        asteroideDiv.dataset.rotacion = rotacion;
        asteroideDiv.querySelector('.nodo-content').style.transform = `rotate(${rotacion}deg)`;
        
        requestAnimationFrame(actualizarPosicion);
    }
    
    requestAnimationFrame(actualizarPosicion);
}

function iniciarOrbitasPlanetas() {
    SISTEMA_SOLAR.animacionesActivas = true;
    
    // Iniciar animación para cada planeta
    SISTEMA_SOLAR.ejes.forEach(eje => {
        const planetaDiv = document.getElementById(`eje-${eje.id}`);
        if (planetaDiv && planetaDiv.style.display !== 'none') {
            animarPlaneta(planetaDiv, eje);
        }
    });
    
    // Iniciar animación para lunas
    SISTEMA_SOLAR.estrategias.forEach(estrategia => {
        const lunaDiv = document.getElementById(`estrategia-${estrategia.id}`);
        if (lunaDiv && lunaDiv.style.display !== 'none') {
            animarLuna(lunaDiv, estrategia);
        }
    });
    
    // Iniciar animación para satélites
    SISTEMA_SOLAR.actividades.forEach(actividad => {
        const sateliteDiv = document.getElementById(`actividad-${actividad.id}`);
        if (sateliteDiv && sateliteDiv.style.display !== 'none') {
            animarSatelite(sateliteDiv, actividad);
        }
    });
    
    // Iniciar animación para asteroides
    SISTEMA_SOLAR.tareas.forEach(tarea => {
        const asteroideDiv = document.getElementById(`tarea-${tarea.id}`);
        if (asteroideDiv && asteroideDiv.style.display !== 'none') {
            animarAsteroide(asteroideDiv, tarea);
        }
    });
}

// ================================
// NAVEGACIÓN Y ZOOM
// ================================

function inicializarNavegacion() {
    const canvas = document.getElementById('mapaCanvas');
    const sistemaSolar = document.getElementById('sistemaSolar');
    
    // Eventos de mouse para arrastrar
    canvas.addEventListener('mousedown', (e) => {
        if (e.target.closest('.nodo') || e.target.closest('.control-btn') || e.target.closest('.nav-btn')) {
            return;
        }
        
        isDragging = true;
        lastX = e.clientX;
        lastY = e.clientY;
        canvas.classList.add('grabbing');
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const deltaX = e.clientX - lastX;
        const deltaY = e.clientY - lastY;
        
        offsetX += deltaX;
        offsetY += deltaY;
        
        aplicarTransformacion();
        
        lastX = e.clientX;
        lastY = e.clientY;
    });
    
    canvas.addEventListener('mouseup', () => {
        isDragging = false;
        canvas.classList.remove('grabbing');
    });
    
    canvas.addEventListener('mouseleave', () => {
        isDragging = false;
        canvas.classList.remove('grabbing');
    });
    
    // Zoom con rueda del mouse
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        
        const zoomIntensity = 0.1;
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const worldX = (mouseX - offsetX) / scale;
        const worldY = (mouseY - offsetY) / scale;
        
        if (e.deltaY < 0) {
            scale *= 1 + zoomIntensity;
        } else {
            scale *= 1 - zoomIntensity;
        }
        
        // Limitar zoom
        scale = Math.min(Math.max(0.1, scale), 5);
        
        // Ajustar offset para hacer zoom en el punto del mouse
        offsetX = mouseX - worldX * scale;
        offsetY = mouseY - worldY * scale;
        
        aplicarTransformacion();
    });
    
    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case '+':
                case '=':
                    e.preventDefault();
                    zoomIn();
                    break;
                case '-':
                    e.preventDefault();
                    zoomOut();
                    break;
                case '0':
                    e.preventDefault();
                    resetView();
                    break;
            }
        }
        
        // Teclas de flecha para navegación
        if (!e.ctrlKey && !e.metaKey) {
            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    moverArriba();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    moverAbajo();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    moverIzquierda();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    moverDerecha();
                    break;
            }
        }
    });
}

function aplicarTransformacion() {
    const sistemaSolar = document.getElementById('sistemaSolar');
    sistemaSolar.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
}

function zoomIn() {
    scale *= 1.2;
    scale = Math.min(scale, 5);
    aplicarTransformacion();
}

function zoomOut() {
    scale *= 0.8;
    scale = Math.max(scale, 0.1);
    aplicarTransformacion();
}

function moverArriba() {
    offsetY += 50;
    aplicarTransformacion();
}

function moverAbajo() {
    offsetY -= 50;
    aplicarTransformacion();
}

function moverIzquierda() {
    offsetX += 50;
    aplicarTransformacion();
}

function moverDerecha() {
    offsetX -= 50;
    aplicarTransformacion();
}

function centrarVista() {
    offsetX = 0;
    offsetY = 0;
    scale = 1;
    aplicarTransformacion();
}

// ================================
// FUNCIONES DE CONTROL
// ================================

function toggleFullscreen() {
    const container = document.getElementById('mapaFullscreen');
    
    if (!document.fullscreenElement) {
        container.requestFullscreen().catch(err => {
            console.log(`Error al activar pantalla completa: ${err.message}`);
        });
    } else {
        document.exitFullscreen();
    }
}

function resetView() {
    // Resetear posición y zoom
    offsetX = 0;
    offsetY = 0;
    scale = 1;
    aplicarTransformacion();
    
    // Resetear ángulos de planetas
    SISTEMA_SOLAR.ejes.forEach((eje, index) => {
        const planeta = document.getElementById(`eje-${eje.id}`);
        if (planeta) {
            planeta.dataset.angulo = eje.anguloInicial;
            const contenedor = document.getElementById(`contenedor-${eje.id}`);
            if (contenedor) {
                contenedor.style.setProperty('--angulo-inicial', `${eje.anguloInicial}deg`);
            }
        }
    });
}

function toggleAnimaciones() {
    SISTEMA_SOLAR.animacionesActivas = !SISTEMA_SOLAR.animacionesActivas;
    const icon = document.getElementById('animacionIcon');
    
    if (SISTEMA_SOLAR.animacionesActivas) {
        icon.className = 'fas fa-pause';
        iniciarOrbitas();
    } else {
        icon.className = 'fas fa-play';
    }
}

function iniciarOrbitas() {
    SISTEMA_SOLAR.animacionesActivas = true;
    iniciarOrbitasPlanetas();
    document.getElementById('animacionIcon').className = 'fas fa-pause';
}

// ================================
// FUNCIONES DE DETALLES (MANTENER)
// ================================

function mostrarDetalleObjetivo() {
    const panel = document.getElementById('panelDetalles');
    const titulo = document.getElementById('detalleTitulo');
    const contenido = document.getElementById('detalleContenido');
    
    titulo.innerHTML = `<i class="fas fa-sun"></i> Objetivo Estratégico`;
    
    contenido.innerHTML = `
        <div class="detalle-sol">
            <div class="encabezado-detalle" style="background: linear-gradient(135deg, #FFD700, #FF8C00);">
                <div class="icono-grande">
                    <i class="fas fa-sun"></i>
                </div>
                <h3>OBJETIVO ESTRATÉGICO</h3>
                <p>Centro del Sistema Solar</p>
            </div>
            
            <div class="descripcion-objetivo">
                <p><strong>Consolidar la viabilidad y el respaldo social del Proyecto El Domo</strong> mediante un modelo de gestión integral que garantice la integridad y disponibilidad del recurso hídrico local, asegurando su no afectación por actividades mineras.</p>
                
                <div class="estadisticas-detalle">
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${SISTEMA_SOLAR.ejes.length}</div>
                        <div class="estadistica-label">Ejes</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${SISTEMA_SOLAR.estrategias.length}</div>
                        <div class="estadistica-label">Estrategias</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${SISTEMA_SOLAR.actividades.length}</div>
                        <div class="estadistica-label">Actividades</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${SISTEMA_SOLAR.tareas.length}</div>
                        <div class="estadistica-label">Tareas</div>
                    </div>
                </div>
            </div>
        </div>
        
        <style>
            .encabezado-detalle {
                padding: 30px;
                border-radius: 15px;
                margin-bottom: 20px;
                text-align: center;
                color: white;
            }
            
            .icono-grande {
                width: 80px;
                height: 80px;
                background: rgba(255,255,255,0.2);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 15px;
                font-size: 32px;
            }
            
            .encabezado-detalle h3 {
                font-size: 24px;
                margin-bottom: 10px;
            }
            
            .encabezado-detalle p {
                opacity: 0.9;
                font-size: 14px;
            }
            
            .descripcion-objetivo {
                line-height: 1.6;
                color: rgba(255,255,255,0.9);
            }
            
            .descripcion-objetivo p {
                margin-bottom: 20px;
            }
            
            .estadisticas-detalle {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
                margin: 20px 0;
            }
            
            .estadistica-item {
                background: rgba(255,255,255,0.05);
                border-radius: 10px;
                padding: 15px;
                text-align: center;
            }
            
            .estadistica-valor {
                font-size: 28px;
                font-weight: bold;
                color: white;
                margin-bottom: 5px;
            }
            
            .estadistica-label {
                font-size: 12px;
                color: rgba(255,255,255,0.7);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
        </style>
    `;
    
    panel.classList.add('open');
}

function mostrarDetallesEje(ejeId) {
    const eje = SISTEMA_SOLAR.ejes.find(e => e.id === ejeId);
    if (!eje) return;
    
    const estrategiasDelEje = SISTEMA_SOLAR.estrategias.filter(e => e.eje_id === ejeId);
    
    const panel = document.getElementById('panelDetalles');
    const titulo = document.getElementById('detalleTitulo');
    const contenido = document.getElementById('detalleContenido');
    
    titulo.innerHTML = `<i class="fas fa-${eje.icono}"></i> ${eje.nombre}`;
    
    contenido.innerHTML = `
        <div class="detalle-eje">
            <div class="encabezado-detalle" style="background: linear-gradient(135deg, ${eje.color}, ${oscurecerColor(eje.color, 20)});">
                <div class="icono-grande">
                    <i class="fas fa-${eje.icono}"></i>
                </div>
                <h3>${eje.nombre}</h3>
                <p>Eje Estratégico</p>
            </div>
            
            <div class="info-eje">
                <p><strong>Descripción:</strong> ${eje.descripcion}</p>
                
                <div class="parametros-orbitales">
                    <h4><i class="fas fa-satellite"></i> Parámetros Orbitales</h4>
                    <div class="parametros-grid">
                        <div class="parametro">
                            <div class="parametro-label">Distancia al Sol</div>
                            <div class="parametro-valor">${eje.distancia}px</div>
                        </div>
                        <div class="parametro">
                            <div class="parametro-label">Velocidad Orbital</div>
                            <div class="parametro-valor">${eje.velocidad}</div>
                        </div>
                        <div class="parametro">
                            <div class="parametro-label">Tamaño</div>
                            <div class="parametro-valor">${eje.tamano}px</div>
                        </div>
                        <div class="parametro">
                            <div class="parametro-label">Posición Inicial</div>
                            <div class="parametro-valor">${eje.anguloInicial}°</div>
                        </div>
                    </div>
                </div>
                
                <div class="estadisticas-detalle">
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${estrategiasDelEje.length}</div>
                        <div class="estadistica-label">Estrategias</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${SISTEMA_SOLAR.actividades.filter(a => estrategiasDelEje.find(e => e.id == a.estrategia_id)).length}</div>
                        <div class="estadistica-label">Actividades</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${SISTEMA_SOLAR.tareas.filter(t => SISTEMA_SOLAR.actividades.find(a => a.id == t.actividad_id && estrategiasDelEje.find(e => e.id == a.estrategia_id))).length}</div>
                        <div class="estadistica-label">Tareas</div>
                    </div>
                </div>
                
                ${estrategiasDelEje.length > 0 ? `
                    <h4><i class="fas fa-moon"></i> Estrategias</h4>
                    <div class="lista-elementos">
                        ${estrategiasDelEje.map(estrategia => `
                            <div class="item-elemento" onclick="mostrarDetallesEstrategia(${estrategia.id})">
                                <div class="item-icono" style="background: ${getColorByTipo(estrategia.tipo_cruce)}">
                                    <i class="fas fa-moon"></i>
                                </div>
                                <div class="item-info">
                                    <div class="item-titulo">${estrategia.estrategia.substring(0, 30)}...</div>
                                    <div class="item-subtitulo">Tipo: ${estrategia.tipo_cruce}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    panel.classList.add('open');
}

function mostrarDetallesEstrategia(estrategiaId) {
    const estrategia = SISTEMA_SOLAR.estrategias.find(e => e.id == estrategiaId);
    if (!estrategia) return;
    
    const eje = SISTEMA_SOLAR.ejes.find(e => e.id === estrategia.eje_id);
    const actividadesDeEstrategia = SISTEMA_SOLAR.actividades.filter(a => a.estrategia_id == estrategiaId);
    
    const panel = document.getElementById('panelDetalles');
    const titulo = document.getElementById('detalleTitulo');
    const contenido = document.getElementById('detalleContenido');
    
    titulo.innerHTML = `<i class="fas fa-moon"></i> Estrategia #${estrategia.id}`;
    
    contenido.innerHTML = `
        <div class="detalle-estrategia">
            <div class="encabezado-detalle" style="background: linear-gradient(135deg, ${getColorByTipo(estrategia.tipo_cruce)}, ${oscurecerColor(getColorByTipo(estrategia.tipo_cruce), 20)});">
                <div class="icono-grande">
                    <i class="fas fa-moon"></i>
                </div>
                <h3>Estrategia ${estrategia.tipo_cruce}</h3>
                <p>${eje ? eje.nombre : 'Sin eje'}</p>
            </div>
            
            <div class="info-estrategia">
                <p><strong>Elemento Interno:</strong> ${estrategia.elemento_interno_texto}</p>
                <p><strong>Elemento Externo:</strong> ${estrategia.elemento_externo_texto}</p>
                <p><strong>Estrategia:</strong> ${estrategia.estrategia}</p>
                ${estrategia.eje_texto ? `<p><strong>Eje:</strong> ${estrategia.eje_texto}</p>` : ''}
                <p><strong>Fecha:</strong> ${new Date(estrategia.fecha_creacion).toLocaleDateString()}</p>
                <p><strong>Creador:</strong> ${estrategia.creador || 'N/A'}</p>
                
                <div class="estadisticas-detalle">
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${actividadesDeEstrategia.length}</div>
                        <div class="estadistica-label">Actividades</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${SISTEMA_SOLAR.tareas.filter(t => actividadesDeEstrategia.find(a => a.id === t.actividad_id)).length}</div>
                        <div class="estadistica-label">Tareas</div>
                    </div>
                </div>
                
                ${actividadesDeEstrategia.length > 0 ? `
                    <h4><i class="fas fa-satellite"></i> Actividades</h4>
                    <div class="lista-elementos">
                        ${actividadesDeEstrategia.map(actividad => `
                            <div class="item-elemento" onclick="mostrarDetallesActividad(${actividad.id})">
                                <div class="item-icono" style="background: #e74c3c">
                                    <i class="fas fa-satellite"></i>
                                </div>
                                <div class="item-info">
                                    <div class="item-titulo">${actividad.nombre}</div>
                                    <div class="item-subtitulo">Responsable: ${actividad.responsable || 'No asignado'}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    panel.classList.add('open');
}

function mostrarDetallesActividad(actividadId) {
    const actividad = SISTEMA_SOLAR.actividades.find(a => a.id == actividadId);
    if (!actividad) return;
    
    const estrategia = SISTEMA_SOLAR.estrategias.find(e => e.id == actividad.estrategia_id);
    const tareasDeActividad = SISTEMA_SOLAR.tareas.filter(t => t.actividad_id == actividadId);
    
    const panel = document.getElementById('panelDetalles');
    const titulo = document.getElementById('detalleTitulo');
    const contenido = document.getElementById('detalleContenido');
    
    titulo.innerHTML = `<i class="fas fa-satellite"></i> ${actividad.nombre}`;
    
    contenido.innerHTML = `
        <div class="detalle-actividad">
            <div class="encabezado-detalle" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                <div class="icono-grande">
                    <i class="fas fa-satellite"></i>
                </div>
                <h3>${actividad.nombre}</h3>
                <p>Actividad</p>
            </div>
            
            <div class="info-actividad">
                <p><strong>Descripción:</strong> ${actividad.descripcion || 'Sin descripción'}</p>
                <p><strong>Responsable:</strong> ${actividad.responsable || 'No asignado'}</p>
                <p><strong>Estrategia:</strong> ${estrategia ? estrategia.estrategia.substring(0, 50) + '...' : 'No asignada'}</p>
                ${actividad.fecha_inicio ? `<p><strong>Fecha Inicio:</strong> ${new Date(actividad.fecha_inicio).toLocaleDateString()}</p>` : ''}
                ${actividad.fecha_fin ? `<p><strong>Fecha Fin:</strong> ${new Date(actividad.fecha_fin).toLocaleDateString()}</p>` : ''}
                <p><strong>Creador:</strong> ${actividad.creador || 'N/A'}</p>
                
                <div class="estadisticas-detalle">
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${tareasDeActividad.length}</div>
                        <div class="estadistica-label">Tareas</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${tareasDeActividad.filter(t => t.estado === 'completada').length}</div>
                        <div class="estadistica-label">Completadas</div>
                    </div>
                </div>
                
                ${tareasDeActividad.length > 0 ? `
                    <h4><i class="fas fa-meteor"></i> Tareas</h4>
                    <div class="lista-elementos">
                        ${tareasDeActividad.map(tarea => {
                            let colorEstado = '#f39c12';
                            let iconoEstado = 'fa-clock';
                            let textoEstado = 'Pendiente';
                            
                            switch(tarea.estado) {
                                case 'completada':
                                    colorEstado = '#2ecc71';
                                    iconoEstado = 'fa-check-circle';
                                    textoEstado = 'Completada';
                                    break;
                                case 'en_progreso':
                                    colorEstado = '#3498db';
                                    iconoEstado = 'fa-spinner';
                                    textoEstado = 'En progreso';
                                    break;
                            }
                            
                            return `
                                <div class="item-elemento" onclick="mostrarDetallesTarea(${tarea.id})">
                                    <div class="item-icono" style="background: ${colorEstado}">
                                        <i class="fas ${iconoEstado}"></i>
                                    </div>
                                    <div class="item-info">
                                        <div class="item-titulo">${tarea.nombre}</div>
                                        <div class="item-subtitulo">Estado: ${textoEstado}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    panel.classList.add('open');
}

function mostrarDetallesTarea(tareaId) {
    const tarea = SISTEMA_SOLAR.tareas.find(t => t.id == tareaId);
    if (!tarea) return;
    
    const actividad = SISTEMA_SOLAR.actividades.find(a => a.id == tarea.actividad_id);
    const estrategia = actividad ? SISTEMA_SOLAR.estrategias.find(e => e.id == actividad.estrategia_id) : null;
    const eje = estrategia ? SISTEMA_SOLAR.ejes.find(e => e.id == estrategia.eje_id) : null;
    
    const panel = document.getElementById('panelDetalles');
    const titulo = document.getElementById('detalleTitulo');
    const contenido = document.getElementById('detalleContenido');
    
    let colorEstado = '#f39c12';
    let iconoEstado = 'fa-clock';
    let textoEstado = 'Pendiente';
    
    switch(tarea.estado) {
        case 'completada':
            colorEstado = '#2ecc71';
            iconoEstado = 'fa-check-circle';
            textoEstado = 'Completada';
            break;
        case 'en_progreso':
            colorEstado = '#3498db';
            iconoEstado = 'fa-spinner';
            textoEstado = 'En progreso';
            break;
    }
    
    titulo.innerHTML = `<i class="fas fa-meteor"></i> ${tarea.nombre}`;
    
    contenido.innerHTML = `
        <div class="detalle-tarea">
            <div class="encabezado-detalle" style="background: linear-gradient(135deg, ${colorEstado}, ${oscurecerColor(colorEstado, 20)});">
                <div class="icono-grande">
                    <i class="fas ${iconoEstado}"></i>
                </div>
                <h3>${tarea.nombre}</h3>
                <p>Tarea - ${textoEstado}</p>
            </div>
            
            <div class="info-tarea">
                <p><strong>Estado:</strong> ${textoEstado}</p>
                <p><strong>Descripción:</strong> ${tarea.descripcion || 'Sin descripción'}</p>
                <p><strong>Responsable:</strong> ${tarea.responsable || 'No asignado'}</p>
                ${actividad ? `<p><strong>Actividad:</strong> ${actividad.nombre}</p>` : ''}
                ${estrategia ? `<p><strong>Estrategia:</strong> ${estrategia.estrategia.substring(0, 50)}...</p>` : ''}
                ${eje ? `<p><strong>Eje:</strong> ${eje.nombre}</p>` : ''}
                ${tarea.fecha_inicio ? `<p><strong>Fecha Inicio:</strong> ${new Date(tarea.fecha_inicio).toLocaleDateString()}</p>` : ''}
                ${tarea.fecha_fin ? `<p><strong>Fecha Fin:</strong> ${new Date(tarea.fecha_fin).toLocaleDateString()}</p>` : ''}
                <p><strong>Creador:</strong> ${tarea.creador || 'N/A'}</p>
            </div>
        </div>
    `;
    
    panel.classList.add('open');
}

function cerrarPanel() {
    document.getElementById('panelDetalles').classList.remove('open');
}

// ================================
// FUNCIONES AUXILIARES
// ================================

function oscurecerColor(color, percent) {
    // Convertir color hex a RGB
    let r = parseInt(color.substr(1, 2), 16);
    let g = parseInt(color.substr(3, 2), 16);
    let b = parseInt(color.substr(5, 2), 16);
    
    // Oscurecer
    r = Math.max(0, Math.floor(r * (100 - percent) / 100));
    g = Math.max(0, Math.floor(g * (100 - percent) / 100));
    b = Math.max(0, Math.floor(b * (100 - percent) / 100));
    
    // Convertir de vuelta a hex
    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
}

function getColorByTipo(tipo) {
    switch(tipo) {
        case 'FO': return '#2ecc71';
        case 'DO': return '#3498db';
        case 'FA': return '#e74c3c';
        case 'DA': return '#f39c12';
        default: return '#95a5a6';
    }
}

// Iniciar animaciones al cargar
window.addEventListener('load', function() {
    iniciarOrbitasPlanetas();
});
</script>
{% endblock %}
