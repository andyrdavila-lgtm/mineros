{% extends "inicio.html" %}

{% block content %}
<!-- Mapa Neuronal Estratégico - Versión Corregida -->
<div class="mapa-neuronal-container" id="mapaFullscreen">
    <!-- Cabecera principal -->
    <div class="mapa-header-glass">
        <div class="header-content">
            <h1 class="mapa-title-glow">
                <i class="fas fa-project-diagram"></i>
                <span class="title-text">MAPA NEURONAL ESTRATÉGICO</span>
                <span class="subtitle">Proyecto El Domo</span>
            </h1>
            <div class="header-stats">
                <div class="stat-badge">
                    <i class="fas fa-bullseye"></i>
                    <span>1 Objetivo</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-layer-group"></i>
                    <span id="total-ejes">7 Ejes</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-chess-board"></i>
                    <span id="total-estrategias">0 Estrategias</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-tasks"></i>
                    <span id="total-tacticas">0 Tácticas</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-check-circle"></i>
                    <span id="total-actividades">0 Actividades</span>
                </div>
                <div class="stat-badge">
                    <i class="fas fa-network-wired"></i>
                    <span id="total-conexiones">0 Conexiones</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de controles organizado -->
    <div class="panel-controles">
        <div class="grupo-controles">
            <h4><i class="fas fa-sliders-h"></i> Controles</h4>
            <div class="controles-grid">
                <button class="control-btn tooltip" onclick="toggleFullscreen()" data-tooltip="Pantalla completa">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="control-btn tooltip" onclick="resetView()" data-tooltip="Reiniciar vista">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="control-btn tooltip" onclick="toggleAnimations()" data-tooltip="Animaciones">
                    <i class="fas fa-play" id="animacionIcon"></i>
                </button>
                <button class="control-btn tooltip" onclick="exportMap()" data-tooltip="Exportar">
                    <i class="fas fa-download"></i>
                </button>
                <button class="control-btn tooltip" onclick="cargarDatosDesdeAPI()" data-tooltip="Actualizar datos">
                    <i class="fas fa-sync"></i>
                </button>
            </div>
        </div>
        
        <div class="grupo-controles">
            <h4><i class="fas fa-filter"></i> Filtros</h4>
            <select id="filtro-nivel" onchange="aplicarFiltro()" class="filtro-select">
                <option value="todos">Todos los niveles</option>
                <option value="objetivo">Objetivo Central</option>
                <option value="ejes">Ejes Estratégicos</option>
                <option value="estrategias">Estrategias</option>
                <option value="tacticas">Tácticas</option>
                <option value="actividades">Actividades</option>
            </select>
            
            <select id="filtro-eje" onchange="filtrarPorEje()" class="filtro-select">
                <option value="todos">Todos los ejes</option>
                <option value="educacion">Educación</option>
                <option value="salud">Salud</option>
                <option value="empleabilidad">Empleabilidad</option>
                <option value="desarrollo_economico">Desarrollo Económico</option>
                <option value="sostenibilidad_ambiental">Sostenibilidad Ambiental</option>
                <option value="comunicacion">Comunicación</option>
                <option value="institucional">Institucional</option>
            </select>
            
            <div class="filtro-checkbox">
                <label>
                    <input type="checkbox" id="mostrar-conexiones" checked onchange="toggleConexiones()">
                    <span>Mostrar conexiones</span>
                </label>
                <label>
                    <input type="checkbox" id="mostrar-nombres" checked onchange="toggleNombres()">
                    <span>Mostrar nombres</span>
                </label>
            </div>
        </div>
        
        <div class="grupo-controles">
            <h4><i class="fas fa-search"></i> Zoom</h4>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()">-</button>
                <input type="range" id="zoomSlider" min="0.3" max="3" step="0.1" value="1" 
                       oninput="zoomSliderChange(this.value)">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <div class="zoom-value" id="zoomValue">100%</div>
            </div>
            <div class="modo-controls">
                <button class="modo-btn active" onclick="cambiarModo('navegacion')" id="modo-navegacion">
                    <i class="fas fa-hand-paper"></i> Navegar
                </button>
                <button class="modo-btn" onclick="cambiarModo('seleccion')" id="modo-seleccion">
                    <i class="fas fa-mouse-pointer"></i> Seleccionar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Canvas principal -->
    <div class="mapa-canvas-fullscreen" id="mapaCanvas">
        <!-- Fondo con partículas -->
        <div class="particles-container" id="particlesContainer"></div>
        
        <!-- SVG para conexiones dinámicas -->
        <svg class="conexiones-svg" id="conexionesSvg">
            <defs>
                <linearGradient id="gradient-central" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#9C27B0" stop-opacity="0.4" />
                    <stop offset="100%" stop-color="#E91E63" stop-opacity="0.4" />
                </linearGradient>
                <linearGradient id="gradient-eje" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#3498db" stop-opacity="0.5" />
                    <stop offset="100%" stop-color="#2980b9" stop-opacity="0.5" />
                </linearGradient>
                <linearGradient id="gradient-estrategia" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#2ecc71" stop-opacity="0.5" />
                    <stop offset="100%" stop-color="#27ae60" stop-opacity="0.5" />
                </linearGradient>
                <linearGradient id="gradient-tactica" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#e74c3c" stop-opacity="0.5" />
                    <stop offset="100%" stop-color="#c0392b" stop-opacity="0.5" />
                </linearGradient>
                <linearGradient id="gradient-actividad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#f39c12" stop-opacity="0.5" />
                    <stop offset="100%" stop-color="#d35400" stop-opacity="0.5" />
                </linearGradient>
                <filter id="glow">
                    <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#3498db"/>
                </marker>
            </defs>
        </svg>
        
        <!-- Contenedor de nodos -->
        <div class="nodos-container" id="nodosContainer">
            <!-- Nodo Central -->
            <div class="nodo nodo-central" id="nodo-objetivo">
                <div class="nodo-glow"></div>
                <div class="nodo-content">
                    <div class="nodo-icon-pulse">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="nodo-title-glow">OBJETIVO ESTRATÉGICO</div>
                    <div class="nodo-desc-scroll">
                        Consolidar la viabilidad y el respaldo social del Proyecto El Domo mediante un modelo de gestión integral...
                    </div>
                    <button class="btn-ver-mas" onclick="mostrarDetalleObjetivo()">
                        <i class="fas fa-eye"></i> Ver completo
                    </button>
                    <div class="nodo-stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="contador-ejes">7</div>
                            <div class="stat-label">Ejes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="contador-estrategias">0</div>
                            <div class="stat-label">Estrategias</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="contador-tacticas">0</div>
                            <div class="stat-label">Tácticas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="contador-actividades">0</div>
                            <div class="stat-label">Actividades</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Los nodos de ejes se generan dinámicamente aquí -->
            <div class="ejes-container" id="ejesContainer"></div>
            
            <!-- Contenedores para niveles jerárquicos -->
            <div class="estrategias-container" id="estrategiasContainer"></div>
            <div class="tacticas-container" id="tacticasContainer"></div>
            <div class="actividades-container" id="actividadesContainer"></div>
        </div>
        
        <!-- Mini mapa de navegación -->
        <div class="minimap" id="minimap">
            <div class="minimap-viewport" id="minimapViewport"></div>
        </div>
    </div>
    
    <!-- Leyenda flotante -->
    <div class="leyenda-flotante">
        <div class="leyenda-header">
            <i class="fas fa-key"></i> Leyenda
        </div>
        <div class="leyenda-content">
            <div class="leyenda-item">
                <div class="leyenda-icon nodo-central-color"></div>
                <span>Objetivo Central</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-icon nodo-eje-color"></div>
                <span>Ejes Estratégicos</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-icon nodo-estrategia-color"></div>
                <span>Estrategias</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-icon nodo-tactica-color"></div>
                <span>Tácticas</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-icon nodo-actividad-color"></div>
                <span>Actividades</span>
            </div>
        </div>
        <div class="leyenda-stats">
            <div class="stat-leyenda">
                <span id="leyenda-activos">0</span> nodos activos
            </div>
            <div class="stat-leyenda">
                <span id="leyenda-conexiones">0</span> conexiones
            </div>
        </div>
    </div>
    
    <!-- Panel de detalles -->
    <div class="panel-detalles" id="panelDetalles">
        <div class="panel-header">
            <h3 id="detalleTitulo"><i class="fas fa-info-circle"></i> Detalles del Nodo</h3>
            <button class="panel-close" onclick="cerrarPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-body" id="detalleContenido">
            <div class="cargando-detalles">
                <i class="fas fa-spinner fa-spin"></i> Cargando detalles...
            </div>
        </div>
    </div>
    
    <!-- Indicador de carga -->
    <div class="cargando-overlay" id="cargandoOverlay">
        <div class="cargando-content">
            <div class="cargando-spinner">
                <i class="fas fa-project-diagram fa-spin"></i>
            </div>
            <div class="cargando-texto">
                <h3>Cargando Mapa Neuronal</h3>
                <p id="estadoCarga">Inicializando sistema...</p>
                <div class="cargando-progreso">
                    <div class="cargando-barra" id="progresoCarga"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Reset y configuración base */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    /* Contenedor principal fullscreen */
    .mapa-neuronal-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #0c0e2a 0%, #1a1b3a 50%, #0c2461 100%);
        overflow: hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* Cabecera glassmorphism */
    .mapa-header-glass {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0 20px;
        z-index: 1000;
        display: flex;
        align-items: center;
    }
    
    .header-content {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .mapa-title-glow {
        color: white;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .title-text {
        font-size: 22px;
        font-weight: 700;
        letter-spacing: 1px;
        text-shadow: 0 0 10px rgba(52, 152, 219, 0.7);
    }
    
    .subtitle {
        font-size: 14px;
        opacity: 0.8;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .header-stats {
        display: flex;
        gap: 15px;
    }
    
    .stat-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 15px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
        font-size: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }
    
    .stat-badge:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
    }
    
    /* Panel de controles organizado */
    .panel-controles {
        position: absolute;
        top: 90px;
        right: 20px;
        width: 350px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 15px;
        padding: 20px;
        z-index: 1000;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .grupo-controles {
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .grupo-controles:last-child {
        border-bottom: none;
    }
    
    .grupo-controles h4 {
        color: white;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .controles-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
    }
    
    .control-btn {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(52, 152, 219, 0.2);
        border: 1px solid rgba(52, 152, 219, 0.3);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    .control-btn:hover {
        background: rgba(52, 152, 219, 0.4);
        transform: translateY(-2px);
    }
    
    .tooltip {
        position: relative;
    }
    
    .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
        z-index: 10000;
    }
    
    .tooltip:hover::after {
        opacity: 1;
        visibility: visible;
        bottom: 120%;
    }
    
    .filtro-select {
        width: 100%;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .filtro-select option {
        background: #0c0e2a;
        color: white;
    }
    
    .filtro-checkbox {
        display: flex;
        flex-direction: column;
        gap: 8px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
    }
    
    .filtro-checkbox label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }
    
    .filtro-checkbox input {
        accent-color: #3498db;
    }
    
    .zoom-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .zoom-btn {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .zoom-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .zoom-controls input[type="range"] {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        height: 6px;
        outline: none;
        -webkit-appearance: none;
    }
    
    .zoom-controls input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #3498db;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
    }
    
    .zoom-value {
        min-width: 45px;
        text-align: center;
        color: white;
        font-size: 12px;
        background: rgba(255, 255, 255, 0.1);
        padding: 5px;
        border-radius: 6px;
    }
    
    .modo-controls {
        display: flex;
        gap: 10px;
    }
    
    .modo-btn {
        flex: 1;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        font-size: 12px;
        transition: all 0.3s ease;
    }
    
    .modo-btn.active {
        background: rgba(52, 152, 219, 0.3);
        border-color: rgba(52, 152, 219, 0.5);
        color: white;
    }
    
    /* Canvas principal */
    .mapa-canvas-fullscreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        cursor: grab;
        z-index: 1;
    }
    
    .mapa-canvas-fullscreen:active {
        cursor: grabbing;
    }
    
    /* Partículas de fondo */
    .particles-container {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }
    
    .particle {
        position: absolute;
        background: rgba(52, 152, 219, 0.3);
        border-radius: 50%;
        pointer-events: none;
    }
    
    /* SVG para conexiones */
    .conexiones-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
    }
    
    .conexion {
        stroke-width: 2;
        fill: none;
        filter: url(#glow);
        transition: stroke-width 0.3s ease;
    }
    
    .conexion:hover {
        stroke-width: 3;
    }
    
    .conexion-central {
        stroke: url(#gradient-central);
        stroke-dasharray: 5, 5;
        stroke-opacity: 0.6;
        animation: dashMove 20s linear infinite;
    }
    
    .conexion-eje {
        stroke: url(#gradient-eje);
        stroke-opacity: 0.6;
    }
    
    .conexion-estrategia {
        stroke: url(#gradient-estrategia);
        stroke-opacity: 0.6;
    }
    
    .conexion-tactica {
        stroke: url(#gradient-tactica);
        stroke-opacity: 0.6;
    }
    
    .conexion-actividad {
        stroke: url(#gradient-actividad);
        stroke-opacity: 0.6;
    }
    
    @keyframes dashMove {
        to {
            stroke-dashoffset: -100;
        }
    }
    
    /* Contenedor de nodos */
    .nodos-container {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 3;
        transform-origin: center;
        transition: transform 0.3s ease;
        will-change: transform;
    }
    
    /* Nodos generales */
    .nodo {
        position: absolute;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center;
        z-index: 10;
    }
    
    .nodo:hover {
        z-index: 1000;
        transform: scale(1.05);
    }
    
    .nodo.seleccionado {
        z-index: 999;
        box-shadow: 0 0 30px rgba(52, 152, 219, 0.8);
    }
    
    /* Nodo central */
    .nodo-central {
        width: 300px;
        height: 300px;
        z-index: 100;
    }
    
    .nodo-glow {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(156, 39, 176, 0.4) 0%, rgba(156, 39, 176, 0) 70%);
        animation: pulseGlow 3s infinite;
        filter: blur(20px);
        z-index: -1;
    }
    
    .nodo-central .nodo-content {
        position: relative;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 30px;
        border: 2px solid rgba(156, 39, 176, 0.3);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .nodo-icon-pulse {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, #9C27B0, #E91E63);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        font-size: 28px;
        color: white;
        animation: pulseIcon 2s infinite;
        box-shadow: 0 0 30px rgba(156, 39, 176, 0.5);
    }
    
    .nodo-title-glow {
        font-size: 16px;
        font-weight: 700;
        color: white;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 0 10px rgba(156, 39, 176, 0.7);
    }
    
    .nodo-desc-scroll {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
        line-height: 1.4;
        margin-bottom: 15px;
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }
    
    .btn-ver-mas {
        background: linear-gradient(135deg, #3498db, #9b59b6);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-bottom: 15px;
    }
    
    .btn-ver-mas:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
    }
    
    .nodo-stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        width: 80%;
    }
    
    .stat-item {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 8px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 20px;
        font-weight: 700;
        color: white;
        margin-bottom: 2px;
    }
    
    .stat-label {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Nodos de ejes */
    .nodo-eje {
        width: 160px;
        height: 160px;
        z-index: 90;
    }
    
    .nodo-eje .nodo-content {
        position: relative;
        width: 100%;
        height: 100%;
        background: rgba(52, 152, 219, 0.1);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
        border: 2px solid rgba(52, 152, 219, 0.3);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .nodo-eje:hover .nodo-content {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        border-color: rgba(52, 152, 219, 0.5);
    }
    
    .nodo-eje .nodo-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #3498db, #2980b9);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        font-size: 20px;
        color: white;
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    
    .nodo-eje .nodo-title {
        font-size: 14px;
        font-weight: 600;
        color: white;
        margin-bottom: 5px;
        text-align: center;
        line-height: 1.2;
    }
    
    .nodo-eje .nodo-counter {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        background: rgba(255, 255, 255, 0.1);
        padding: 3px 10px;
        border-radius: 12px;
    }
    
    /* Nodos de estrategias */
    .nodo-estrategia {
        width: 140px;
        height: 140px;
        z-index: 80;
    }
    
    .nodo-estrategia .nodo-content {
        background: rgba(46, 204, 113, 0.1);
        border: 2px solid rgba(46, 204, 113, 0.3);
    }
    
    .nodo-estrategia .nodo-icon {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
    }
    
    /* Nodos de tácticas */
    .nodo-tactica {
        width: 120px;
        height: 120px;
        z-index: 70;
    }
    
    .nodo-tactica .nodo-content {
        background: rgba(231, 76, 60, 0.1);
        border: 2px solid rgba(231, 76, 60, 0.3);
    }
    
    .nodo-tactica .nodo-icon {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    
    /* Nodos de actividades */
    .nodo-actividad {
        width: 100px;
        height: 100px;
        z-index: 60;
    }
    
    .nodo-actividad .nodo-content {
        background: rgba(243, 156, 18, 0.1);
        border: 2px solid rgba(243, 156, 18, 0.3);
    }
    
    .nodo-actividad .nodo-icon {
        background: linear-gradient(135deg, #f39c12, #d35400);
    }
    
    /* Estilos comunes para nodos hijos */
    .nodo-estrategia .nodo-content,
    .nodo-tactica .nodo-content,
    .nodo-actividad .nodo-content {
        position: relative;
        width: 100%;
        height: 100%;
        backdrop-filter: blur(10px);
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .nodo-estrategia .nodo-icon,
    .nodo-tactica .nodo-icon,
    .nodo-actividad .nodo-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        font-size: 16px;
        color: white;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }
    
    .nodo-estrategia .nodo-title,
    .nodo-tactica .nodo-title,
    .nodo-actividad .nodo-title {
        font-size: 12px;
        font-weight: 600;
        color: white;
        text-align: center;
        line-height: 1.2;
        max-height: 40px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    
    /* Leyenda flotante */
    .leyenda-flotante {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 15px;
        padding: 15px;
        width: 220px;
        z-index: 1000;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    .leyenda-header {
        color: white;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .leyenda-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 15px;
    }
    
    .leyenda-item {
        display: flex;
        align-items: center;
        gap: 10px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 12px;
    }
    
    .leyenda-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    .nodo-central-color {
        background: linear-gradient(135deg, #9C27B0, #E91E63);
    }
    
    .nodo-eje-color {
        background: linear-gradient(135deg, #3498db, #2980b9);
    }
    
    .nodo-estrategia-color {
        background: linear-gradient(135deg, #2ecc71, #27ae60);
    }
    
    .nodo-tactica-color {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    
    .nodo-actividad-color {
        background: linear-gradient(135deg, #f39c12, #d35400);
    }
    
    .leyenda-stats {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .stat-leyenda {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: space-between;
    }
    
    .stat-leyenda span {
        color: white;
        font-weight: 600;
    }
    
    /* Panel de detalles */
    .panel-detalles {
        position: fixed;
        top: 0;
        right: -400px;
        width: 380px;
        height: 100%;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(30px);
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 2000;
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
    }
    
    .panel-detalles.open {
        right: 0;
    }
    
    .panel-header {
        padding: 25px;
        background: rgba(12, 36, 97, 0.5);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .panel-header h3 {
        color: white;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .panel-close {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .panel-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }
    
    .panel-body {
        padding: 25px;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .cargando-detalles {
        text-align: center;
        padding: 40px 20px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    /* Mini mapa */
    .minimap {
        position: absolute;
        bottom: 250px;
        left: 20px;
        width: 150px;
        height: 150px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
        z-index: 1000;
    }
    
    .minimap-viewport {
        position: absolute;
        border: 2px solid rgba(52, 152, 219, 0.8);
        background: rgba(52, 152, 219, 0.1);
        transition: all 0.3s ease;
    }
    
    /* Indicador de carga */
    .cargando-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(12, 14, 42, 0.95);
        backdrop-filter: blur(10px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.5s ease;
    }
    
    .cargando-content {
        text-align: center;
        color: white;
        max-width: 400px;
        padding: 40px;
    }
    
    .cargando-spinner {
        font-size: 60px;
        margin-bottom: 20px;
        color: #3498db;
    }
    
    .cargando-texto h3 {
        font-size: 24px;
        margin-bottom: 10px;
        color: white;
    }
    
    .cargando-texto p {
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 20px;
    }
    
    .cargando-progreso {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
    }
    
    .cargando-barra {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #9b59b6);
        width: 0%;
        transition: width 0.3s ease;
    }
    
    /* Animaciones */
    @keyframes pulseGlow {
        0%, 100% {
            opacity: 0.5;
            transform: scale(1);
        }
        50% {
            opacity: 0.8;
            transform: scale(1.05);
        }
    }
    
    @keyframes pulseIcon {
        0%, 100% {
            box-shadow: 0 0 30px rgba(156, 39, 176, 0.5);
        }
        50% {
            box-shadow: 0 0 50px rgba(156, 39, 176, 0.8);
        }
    }
    
    @keyframes aparecerNodo {
        from {
            opacity: 0;
            transform: translateY(50px) scale(0.5);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .nodo-aparecer {
        animation: aparecerNodo 0.6s ease forwards;
    }
    
    /* Scrollbar personalizado */
    ::-webkit-scrollbar {
        width: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #3498db, #9b59b6);
        border-radius: 10px;
    }
    
    /* Mejor espaciado entre nodos */
    .ejes-container, .estrategias-container, 
    .tacticas-container, .actividades-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 40px;
    }
    
    .nodo-aparecer {
        position: relative;
        margin: 15px;
    }
    
    /* Mejor visibilidad de nodos ocultos por filtro */
    .nodo[style*="opacity: 0.1"] {
        transition: opacity 0.3s ease;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
        .panel-controles {
            width: 300px;
            top: 90px;
            right: 10px;
        }
        
        .panel-detalles {
            width: 320px;
        }
        
        .leyenda-flotante {
            width: 200px;
        }
        
        .minimap {
            display: none;
        }
    }
    
    @media (max-width: 768px) {
        .mapa-header-glass {
            height: 100px;
            padding: 0 10px;
        }
        
        .header-content {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
        }
        
        .header-stats {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .stat-badge {
            font-size: 12px;
            padding: 6px 10px;
        }
        
        .panel-controles {
            width: calc(100% - 20px);
            right: 10px;
            flex-direction: column;
            top: 110px;
        }
        
        .panel-detalles {
            width: 100%;
            right: -100%;
        }
        
        .leyenda-flotante {
            width: calc(100% - 40px);
            left: 20px;
        }
        
        .minimap {
            display: none;
        }
        
        .nodo-central {
            width: 250px;
            height: 250px;
        }
        
        .nodo-eje {
            width: 140px;
            height: 140px;
        }
    }
</style>

<script>
    // Variables globales
    let mapa = {
        ejes: [],
        estrategias: [],
        tacticas: [],
        actividades: [],
        conexiones: []
    };
    
    let config = {
        animacionesActivas: true,
        zoomLevel: 1,
        panning: false,
        startX: 0,
        startY: 0,
        translateX: 0,
        translateY: 0,
        nodoSeleccionado: null,
        mostrarConexiones: true,
        mostrarNombres: true,
        modo: 'navegacion',
        filtroNivel: 'todos',
        filtroEje: 'todos'
    };
    
    let elementos = {
        particulas: [],
        intervaloConexiones: null,
        animacionFrame: null
    };
    
    // Función para verificar colisiones entre nodos
    function verificarColision(x, y, radioMinimo = 120, tipoNodo = '') {
        const todosNodos = document.querySelectorAll('.nodo:not([style*="display: none"]):not(.nodo-central)');
        
        for (const nodo of todosNodos) {
            if (!nodo.style.left || !nodo.style.top) continue;
            
            const nodoX = parseFloat(nodo.style.left);
            const nodoY = parseFloat(nodo.style.top);
            
            const distancia = Math.sqrt(Math.pow(x - nodoX, 2) + Math.pow(y - nodoY, 2));
            
            // Aumentar radio mínimo para nodos del mismo tipo
            const radioAjustado = tipoNodo && nodo.classList.contains(tipoNodo) ? radioMinimo * 1.5 : radioMinimo;
            
            if (distancia < radioAjustado) {
                // Ajustar posición para evitar colisión
                const angulo = Math.atan2(y - nodoY, x - nodoX);
                return {
                    x: nodoX + radioAjustado * Math.cos(angulo),
                    y: nodoY + radioAjustado * Math.sin(angulo)
                };
            }
        }
        
        return { x, y };
    }
    
    // Función para oscurecer color
    function oscurecerColor(color, percent) {
        let num = parseInt(color.replace("#", ""), 16),
            amt = Math.round(2.55 * percent),
            R = (num >> 16) - amt,
            G = (num >> 8 & 0x00FF) - amt,
            B = (num & 0x0000FF) - amt;
        
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }
    
    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        inicializarMapa();
        crearParticulas();
        inicializarEventos();
        cargarDatosDesdeAPI();
    });
    
    function inicializarMapa() {
        mostrarCargando('Inicializando mapa...', 10);
        
        // Posicionar nodo central
        const objetivo = document.getElementById('nodo-objetivo');
        objetivo.style.left = '50%';
        objetivo.style.top = '50%';
        objetivo.style.transform = 'translate(-50%, -50%)';
        
        // Crear nodos de ejes iniciales
        crearNodosEjes();
        
        actualizarProgresoCarga(30);
        
        // Iniciar sistema de actualización de conexiones
        iniciarSistemaConexiones();
        
        actualizarProgresoCarga(50);
    }
    
    function crearNodosEjes() {
        const ejesContainer = document.getElementById('ejesContainer');
        ejesContainer.innerHTML = '';
        
        // Definir ejes estratégicos
        mapa.ejes = [
            { 
                id: 'educacion', 
                nombre: 'EDUCACIÓN', 
                icono: 'graduation-cap', 
                color: '#3498db',
                descripcion: 'Mejora de infraestructura educativa y capacitación docente'
            },
            { 
                id: 'salud', 
                nombre: 'SALUD', 
                icono: 'heartbeat', 
                color: '#e74c3c',
                descripcion: 'Equipamiento médico y mejoras en servicios de salud'
            },
            { 
                id: 'empleabilidad', 
                nombre: 'EMPLEABILIDAD', 
                icono: 'briefcase', 
                color: '#2ecc71',
                descripcion: 'Formación técnica y oportunidades de empleo local'
            },
            { 
                id: 'desarrollo_economico', 
                nombre: 'DESARROLLO ECONÓMICO', 
                icono: 'chart-line', 
                color: '#9b59b6',
                descripcion: 'Impulso al desarrollo económico comunitario'
            },
            { 
                id: 'sostenibilidad_ambiental', 
                nombre: 'SOSTENIBILIDAD AMBIENTAL', 
                icono: 'tint', 
                color: '#1abc9c',
                descripcion: 'Gestión sostenible del recurso hídrico y monitoreo ambiental'
            },
            { 
                id: 'comunicacion', 
                nombre: 'COMUNICACIÓN', 
                icono: 'bullhorn', 
                color: '#f1c40f',
                descripcion: 'Sistema de comunicación comunitaria y transparencia'
            },
            { 
                id: 'institucional', 
                nombre: 'INSTITUCIONAL', 
                icono: 'landmark', 
                color: '#e67e22',
                descripcion: 'Cooperación técnica con GADs y niveles distritales'
            }
        ];
        
        const canvasRect = document.getElementById('mapaCanvas').getBoundingClientRect();
        const centroX = canvasRect.width / 2;
        const centroY = canvasRect.height / 2;
        const radio = Math.min(canvasRect.width, canvasRect.height) * 0.45;
        
        mapa.ejes.forEach((eje, index) => {
            const angulo = (2 * Math.PI / mapa.ejes.length) * index - Math.PI / 2;
            let x = centroX + radio * Math.cos(angulo);
            let y = centroY + radio * Math.sin(angulo);
            
            // Verificar colisión
            const posicionAjustada = verificarColision(x, y, 180, 'nodo-eje');
            x = posicionAjustada.x;
            y = posicionAjustada.y;
            
            const nodoDiv = document.createElement('div');
            nodoDiv.className = 'nodo nodo-eje nodo-aparecer';
            nodoDiv.id = `nodo-${eje.id}`;
            nodoDiv.dataset.ejeId = eje.id;
            nodoDiv.dataset.tipo = 'eje';
            nodoDiv.style.left = `${x}px`;
            nodoDiv.style.top = `${y}px`;
            nodoDiv.style.transform = 'translate(-50%, -50%)';
            nodoDiv.style.animationDelay = `${index * 0.1}s`;
            
            nodoDiv.innerHTML = `
                <div class="nodo-content">
                    <div class="nodo-icon" style="background: linear-gradient(135deg, ${eje.color}, ${oscurecerColor(eje.color, 20)})">
                        <i class="fas fa-${eje.icono}"></i>
                    </div>
                    <div class="nodo-title">${eje.nombre}</div>
                    <div class="nodo-counter" id="counter-${eje.id}">0 estrategias</div>
                </div>
            `;
            
            ejesContainer.appendChild(nodoDiv);
            
            // Agregar eventos
            nodoDiv.addEventListener('click', function(e) {
                e.stopPropagation();
                seleccionarNodo(this.id);
                mostrarDetallesEje(eje.id);
            });
        });
        
        // Crear conexiones iniciales
        crearConexionesEjes();
        
        actualizarEstadisticas();
    }
    
    function crearConexionesEjes() {
        mapa.conexiones = [];
        
        // Conexiones desde el objetivo central hacia cada eje
        mapa.ejes.forEach(eje => {
            mapa.conexiones.push({
                id: `conexion-objetivo-${eje.id}`,
                tipo: 'central',
                sourceId: 'nodo-objetivo',
                targetId: `nodo-${eje.id}`,
                color: eje.color
            });
        });
    }
    
    function iniciarSistemaConexiones() {
        // Usar requestAnimationFrame para mejor rendimiento
        function actualizarFrame() {
            if (config.mostrarConexiones) {
                dibujarConexiones();
            }
            actualizarMinimap();
            elementos.animacionFrame = requestAnimationFrame(actualizarFrame);
        }
        
        elementos.animacionFrame = requestAnimationFrame(actualizarFrame);
    }
    
    function inicializarEventos() {
        const canvas = document.getElementById('mapaCanvas');
        const nodosContainer = document.getElementById('nodosContainer');
        
        // Eventos de mouse para pan
        canvas.addEventListener('mousedown', startPan);
        canvas.addEventListener('mousemove', pan);
        canvas.addEventListener('mouseup', endPan);
        canvas.addEventListener('mouseleave', endPan);
        
        // Eventos táctiles
        canvas.addEventListener('touchstart', startPanTouch);
        canvas.addEventListener('touchmove', panTouch);
        canvas.addEventListener('touchend', endPan);
        
        // Evento de rueda para zoom
        canvas.addEventListener('wheel', zoomWheel, { passive: false });
        
        // Evento de redimensionamiento
        window.addEventListener('resize', recalcularPosiciones);
        
        // Eventos de clic en nodos
        document.addEventListener('click', function(e) {
            if (config.modo === 'seleccion' && e.target.closest('.nodo')) {
                const nodo = e.target.closest('.nodo');
                seleccionarNodo(nodo.id);
            }
        });
        
        // Evento para cerrar panel al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.panel-detalles') && !e.target.closest('.nodo')) {
                cerrarPanel();
            }
        });
        
        // Detectar cambios en fullscreen
        document.addEventListener('fullscreenchange', recalcularPosiciones);
        document.addEventListener('webkitfullscreenchange', recalcularPosiciones);
        document.addEventListener('mozfullscreenchange', recalcularPosiciones);
        document.addEventListener('MSFullscreenChange', recalcularPosiciones);
        
        // Agregar evento al nodo objetivo
        const objetivo = document.getElementById('nodo-objetivo');
        objetivo.addEventListener('click', function(e) {
            e.stopPropagation();
            seleccionarNodo('nodo-objetivo');
            mostrarDetallesObjetivo();
        });
    }
    
    // Funciones de pan y zoom
    function startPan(e) {
        if (config.modo !== 'navegacion') return;
        
        config.panning = true;
        config.startX = e.clientX - config.translateX;
        config.startY = e.clientY - config.translateY;
        document.getElementById('mapaCanvas').style.cursor = 'grabbing';
    }
    
    function pan(e) {
        if (!config.panning || config.modo !== 'navegacion') return;
        e.preventDefault();
        config.translateX = e.clientX - config.startX;
        config.translateY = e.clientY - config.startY;
        actualizarTransformacion();
    }
    
    function endPan() {
        config.panning = false;
        if (config.modo === 'navegacion') {
            document.getElementById('mapaCanvas').style.cursor = 'grab';
        }
    }
    
    function startPanTouch(e) {
        if (config.modo !== 'navegacion' || e.touches.length !== 1) return;
        config.panning = true;
        config.startX = e.touches[0].clientX - config.translateX;
        config.startY = e.touches[0].clientY - config.translateY;
    }
    
    function panTouch(e) {
        if (!config.panning || config.modo !== 'navegacion' || e.touches.length !== 1) return;
        e.preventDefault();
        config.translateX = e.touches[0].clientX - config.startX;
        config.translateY = e.touches[0].clientY - config.startY;
        actualizarTransformacion();
    }
    
    function zoomWheel(e) {
        if (config.modo !== 'navegacion') return;
        
        e.preventDefault();
        const zoomIntensity = 0.1;
        const oldZoom = config.zoomLevel;
        
        config.zoomLevel += e.deltaY < 0 ? zoomIntensity : -zoomIntensity;
        config.zoomLevel = Math.min(Math.max(0.3, config.zoomLevel), 3);
        
        document.getElementById('zoomSlider').value = config.zoomLevel;
        document.getElementById('zoomValue').textContent = `${Math.round(config.zoomLevel * 100)}%`;
        
        const rect = e.target.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        config.translateX = mouseX - (mouseX - config.translateX) * (config.zoomLevel / oldZoom);
        config.translateY = mouseY - (mouseY - config.translateY) * (config.zoomLevel / oldZoom);
        
        actualizarTransformacion();
    }
    
    function zoomSliderChange(value) {
        const oldZoom = config.zoomLevel;
        config.zoomLevel = parseFloat(value);
        
        document.getElementById('zoomValue').textContent = `${Math.round(config.zoomLevel * 100)}%`;
        
        const canvas = document.getElementById('mapaCanvas');
        const rect = canvas.getBoundingClientRect();
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        
        config.translateX = centerX - (centerX - config.translateX) * (config.zoomLevel / oldZoom);
        config.translateY = centerY - (centerY - config.translateY) * (config.zoomLevel / oldZoom);
        
        actualizarTransformacion();
    }
    
    function zoomIn() {
        zoomSliderChange(Math.min(config.zoomLevel + 0.1, 3));
    }
    
    function zoomOut() {
        zoomSliderChange(Math.max(config.zoomLevel - 0.1, 0.3));
    }
    
    function actualizarTransformacion() {
        const nodosContainer = document.getElementById('nodosContainer');
        nodosContainer.style.transform = `translate(${config.translateX}px, ${config.translateY}px) scale(${config.zoomLevel})`;
        
        // Forzar redibujo de conexiones
        if (config.mostrarConexiones) {
            dibujarConexiones();
        }
        
        actualizarMinimap();
    }
    
    // Funciones de conexiones dinámicas
    function obtenerPosicionNodo(nodoId) {
        const nodo = document.getElementById(nodoId);
        if (!nodo) return null;
        
        const rect = nodo.getBoundingClientRect();
        const canvas = document.getElementById('mapaCanvas');
        const canvasRect = canvas.getBoundingClientRect();
        
        // Calcular posición relativa al viewport del canvas
        const x = rect.left + rect.width / 2 - canvasRect.left;
        const y = rect.top + rect.height / 2 - canvasRect.top;
        
        return { x, y };
    }
    
    function dibujarConexiones() {
        if (!config.mostrarConexiones || mapa.conexiones.length === 0) {
            document.getElementById('conexionesSvg').innerHTML = '';
            return;
        }
        
        const svg = document.getElementById('conexionesSvg');
        let svgHTML = '<defs>' +
            '<linearGradient id="gradient-central" x1="0%" y1="0%" x2="100%" y2="0%">' +
            '<stop offset="0%" stop-color="#9C27B0" stop-opacity="0.4" /><stop offset="100%" stop-color="#E91E63" stop-opacity="0.4" />' +
            '</linearGradient>' +
            '<linearGradient id="gradient-eje" x1="0%" y1="0%" x2="100%" y2="0%">' +
            '<stop offset="0%" stop-color="#3498db" stop-opacity="0.5" /><stop offset="100%" stop-color="#2980b9" stop-opacity="0.5" />' +
            '</linearGradient>' +
            '<linearGradient id="gradient-estrategia" x1="0%" y1="0%" x2="100%" y2="0%">' +
            '<stop offset="0%" stop-color="#2ecc71" stop-opacity="0.5" /><stop offset="100%" stop-color="#27ae60" stop-opacity="0.5" />' +
            '</linearGradient>' +
            '<linearGradient id="gradient-tactica" x1="0%" y1="0%" x2="100%" y2="0%">' +
            '<stop offset="0%" stop-color="#e74c3c" stop-opacity="0.5" /><stop offset="100%" stop-color="#c0392b" stop-opacity="0.5" />' +
            '</linearGradient>' +
            '<linearGradient id="gradient-actividad" x1="0%" y1="0%" x2="100%" y2="0%">' +
            '<stop offset="0%" stop-color="#f39c12" stop-opacity="0.5" /><stop offset="100%" stop-color="#d35400" stop-opacity="0.5" />' +
            '</linearGradient>' +
            '<filter id="glow">' +
            '<feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>' +
            '<feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>' +
            '</filter></defs>';
        
        mapa.conexiones.forEach((conexion, index) => {
            const sourcePos = obtenerPosicionNodo(conexion.sourceId);
            const targetPos = obtenerPosicionNodo(conexion.targetId);
            
            if (!sourcePos || !targetPos) return;
            
            // Calcular puntos de control para curva Bezier
            const midX = (sourcePos.x + targetPos.x) / 2;
            const midY = (sourcePos.y + targetPos.y) / 2;
            
            // Crear curva suave
            const dx = targetPos.x - sourcePos.x;
            const dy = targetPos.y - sourcePos.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const offset = Math.min(distance * 0.2, 50);
            
            let claseConexion = 'conexion';
            let gradientId = 'gradient-eje';
            
            switch(conexion.tipo) {
                case 'central':
                    claseConexion += ' conexion-central';
                    gradientId = 'gradient-central';
                    break;
                case 'eje':
                    claseConexion += ' conexion-eje';
                    gradientId = 'gradient-eje';
                    break;
                case 'estrategia':
                    claseConexion += ' conexion-estrategia';
                    gradientId = 'gradient-estrategia';
                    break;
                case 'tactica':
                    claseConexion += ' conexion-tactica';
                    gradientId = 'gradient-tactica';
                    break;
                case 'actividad':
                    claseConexion += ' conexion-actividad';
                    gradientId = 'gradient-actividad';
                    break;
            }
            
            // Crear línea curva
            const line = `<path d="M ${sourcePos.x},${sourcePos.y} Q ${midX + offset},${midY - offset} ${targetPos.x},${targetPos.y}" 
                class="${claseConexion}" 
                stroke="url(#${gradientId})" 
                fill="none" 
                stroke-width="2"
                data-conexion-id="${conexion.id}"
                style="animation-delay: ${index * 0.05}s" />`;
            
            svgHTML += line;
        });
        
        svg.innerHTML = svgHTML;
    }
    
    function toggleConexiones() {
        config.mostrarConexiones = document.getElementById('mostrar-conexiones').checked;
        if (!config.mostrarConexiones) {
            document.getElementById('conexionesSvg').innerHTML = '';
        } else {
            dibujarConexiones();
        }
    }
    
    function toggleNombres() {
        config.mostrarNombres = document.getElementById('mostrar-nombres').checked;
        document.querySelectorAll('.nodo-title').forEach(titulo => {
            titulo.style.display = config.mostrarNombres ? 'block' : 'none';
        });
    }
    
    // Crear partículas de fondo
    function crearParticulas() {
        const container = document.getElementById('particlesContainer');
        const particulaCount = 60;
        
        for (let i = 0; i < particulaCount; i++) {
            const particula = document.createElement('div');
            particula.className = 'particle';
            
            const x = Math.random() * 100;
            const y = Math.random() * 100;
            const size = Math.random() * 2 + 1;
            const duration = Math.random() * 15 + 10;
            const delay = Math.random() * 5;
            
            particula.style.left = `${x}%`;
            particula.style.top = `${y}%`;
            particula.style.width = `${size}px`;
            particula.style.height = `${size}px`;
            particula.style.animation = `float ${duration}s infinite ${delay}s linear`;
            particula.style.opacity = Math.random() * 0.2 + 0.1;
            particula.style.backgroundColor = `rgba(52, 152, 219, ${Math.random() * 0.3})`;
            
            container.appendChild(particula);
            elementos.particulas.push(particula);
        }
    }
    
    // Cargar datos desde API
    async function cargarDatosDesdeAPI() {
        mostrarCargando('Cargando datos estratégicos...', 60);
        
        try {
            // Cargar estrategias desde la API con ejes
            const respuesta = await fetch('/api/estrategias_foda_con_eje');
            const data = await respuesta.json();
            
            if (data.success && data.estrategias) {
                mapa.estrategias = data.estrategias.map(e => ({
                    id: e.id,
                    tipo_cruce: e.tipo_cruce,
                    estrategia: e.estrategia,
                    eje_id: e.eje_id || 'educacion',
                    eje_texto: e.eje_texto || 'EDUCACIÓN'
                }));
                actualizarProgresoCarga(70);
                
                // Cargar tácticas desde el backend
                await cargarTacticasDesdeBackend();
                actualizarProgresoCarga(85);
                
                // Cargar actividades desde el backend
                await cargarActividadesDesdeBackend();
                actualizarProgresoCarga(95);
                
                // Crear nodos de estrategias
                crearNodosEstrategias();
                
                // Crear conexiones
                crearConexionesJerarquicas();
                
                actualizarProgresoCarga(100);
                
                setTimeout(() => {
                    ocultarCargando();
                    mostrarNotificacion('Mapa cargado exitosamente', 'success');
                    animarEntrada();
                }, 500);
            } else {
                throw new Error('Error en la respuesta de la API');
            }
        } catch (error) {
            console.error('Error al cargar datos:', error);
            mostrarNotificacion('Error al cargar datos. Usando datos de ejemplo.', 'error');
            cargarDatosEjemplo();
        }
    }
    
    async function cargarTacticasDesdeBackend() {
        try {
            const respuesta = await fetch('/api/actividades');
            if (!respuesta.ok) throw new Error('API no disponible');
            
            const data = await respuesta.json();
            
            if (data.success && data.actividades) {
                mapa.tacticas = data.actividades.map(a => ({
                    ...a,
                    // Renombrar para consistencia
                    nombre: a.nombre || a.descripcion || `Táctica ${a.id}`
                }));
                
                // Asignar eje_id a cada táctica basado en su estrategia
                mapa.tacticas.forEach(tactica => {
                    const estrategia = mapa.estrategias.find(e => e.id === tactica.estrategia_id);
                    if (estrategia) {
                        tactica.eje_id = estrategia.eje_id;
                    }
                });
            } else {
                throw new Error('Formato de respuesta inválido');
            }
        } catch (error) {
            console.error('Error al cargar tácticas:', error);
            // Usar datos de ejemplo
            mapa.tacticas = [
                { id: 1, estrategia_id: 1, nombre: 'Capacitación en metodologías activas', eje_id: 'educacion' },
                { id: 2, estrategia_id: 1, nombre: 'Actualización de planes de estudio', eje_id: 'educacion' },
                { id: 3, estrategia_id: 2, nombre: 'Construcción de aulas', eje_id: 'educacion' },
                { id: 4, estrategia_id: 3, nombre: 'Adquisición de equipos médicos', eje_id: 'salud' },
                { id: 5, estrategia_id: 4, nombre: 'Talleres de formación técnica', eje_id: 'empleabilidad' },
                { id: 6, estrategia_id: 5, nombre: 'Monitoreo de calidad del agua', eje_id: 'sostenibilidad_ambiental' }
            ];
        }
    }
    
    async function cargarActividadesDesdeBackend() {
        try {
            const respuesta = await fetch('/api/tareas');
            if (!respuesta.ok) throw new Error('API no disponible');
            
            const data = await respuesta.json();
            
            if (data.success && data.tareas) {
                mapa.actividades = data.tareas.map(t => ({
                    ...t,
                    // Renombrar para consistencia
                    nombre: t.nombre || `Actividad ${t.id}`
                }));
            } else {
                throw new Error('Formato de respuesta inválido');
            }
        } catch (error) {
            console.error('Error al cargar actividades:', error);
            // Usar datos de ejemplo
            mapa.actividades = [
                { id: 1, tactica_id: 1, nombre: 'Organizar taller inicial', estado: 'completada' },
                { id: 2, tactica_id: 1, nombre: 'Evaluar participantes', estado: 'en_progreso' },
                { id: 3, tactica_id: 2, nombre: 'Revisar currículo actual', estado: 'pendiente' },
                { id: 4, tactica_id: 3, nombre: 'Elaborar planos', estado: 'completada' },
                { id: 5, tactica_id: 4, nombre: 'Cotizar equipos', estado: 'en_progreso' },
                { id: 6, tactica_id: 5, nombre: 'Convocar participantes', estado: 'pendiente' }
            ];
        }
    }
    
    function cargarDatosEjemplo() {
        // Datos de ejemplo para cuando falla la API
        mapa.estrategias = [
            { id: 1, eje_id: 'educacion', estrategia: 'Capacitación docente en metodologías activas', tipo_cruce: 'FO' },
            { id: 2, eje_id: 'educacion', estrategia: 'Mejora de infraestructura educativa', tipo_cruce: 'DA' },
            { id: 3, eje_id: 'salud', estrategia: 'Equipamiento de centros de salud', tipo_cruce: 'FO' },
            { id: 4, eje_id: 'empleabilidad', estrategia: 'Formación técnica para jóvenes', tipo_cruce: 'FA' },
            { id: 5, eje_id: 'sostenibilidad_ambiental', estrategia: 'Monitoreo permanente de calidad del agua', tipo_cruce: 'DO' }
        ];
        
        mapa.tacticas = [
            { id: 1, estrategia_id: 1, nombre: 'Capacitación en metodologías activas', eje_id: 'educacion' },
            { id: 2, estrategia_id: 1, nombre: 'Actualización de planes de estudio', eje_id: 'educacion' },
            { id: 3, estrategia_id: 2, nombre: 'Construcción de aulas', eje_id: 'educacion' },
            { id: 4, estrategia_id: 3, nombre: 'Adquisición de equipos médicos', eje_id: 'salud' },
            { id: 5, estrategia_id: 4, nombre: 'Talleres de formación técnica', eje_id: 'empleabilidad' },
            { id: 6, estrategia_id: 5, nombre: 'Monitoreo de calidad del agua', eje_id: 'sostenibilidad_ambiental' }
        ];
        
        mapa.actividades = [
            { id: 1, tactica_id: 1, nombre: 'Organizar taller inicial', estado: 'completada' },
            { id: 2, tactica_id: 1, nombre: 'Evaluar participantes', estado: 'en_progreso' },
            { id: 3, tactica_id: 2, nombre: 'Revisar currículo actual', estado: 'pendiente' },
            { id: 4, tactica_id: 3, nombre: 'Elaborar planos', estado: 'completada' },
            { id: 5, tactica_id: 4, nombre: 'Cotizar equipos', estado: 'en_progreso' },
            { id: 6, tactica_id: 5, nombre: 'Convocar participantes', estado: 'pendiente' }
        ];
        
        crearNodosEstrategias();
        crearConexionesJerarquicas();
        ocultarCargando();
        animarEntrada();
    }
    
    function crearNodosEstrategias() {
        const estrategiasContainer = document.getElementById('estrategiasContainer');
        estrategiasContainer.innerHTML = '';
        
        mapa.estrategias.forEach((estrategia, index) => {
            const eje = mapa.ejes.find(e => e.id === estrategia.eje_id);
            if (!eje) return;
            
            // Encontrar posición del eje
            const ejeElement = document.getElementById(`nodo-${eje.id}`);
            if (!ejeElement) return;
            
            const ejeRect = ejeElement.getBoundingClientRect();
            const canvasRect = document.getElementById('mapaCanvas').getBoundingClientRect();
            
            // Posicionar estrategias en círculo alrededor del eje
            const estrategiasDelEje = mapa.estrategias.filter(e => e.eje_id === estrategia.eje_id);
            const indice = estrategiasDelEje.findIndex(e => e.id === estrategia.id);
            const total = estrategiasDelEje.length;
            
            const angulo = (2 * Math.PI / total) * indice;
            const radio = 250;
            
            let x = (ejeRect.left + ejeRect.width / 2 - canvasRect.left) + radio * Math.cos(angulo);
            let y = (ejeRect.top + ejeRect.height / 2 - canvasRect.top) + radio * Math.sin(angulo);
            
            // Verificar colisión
            const posicionAjustada = verificarColision(x, y, 150, 'nodo-estrategia');
            x = posicionAjustada.x;
            y = posicionAjustada.y;
            
            const nodoDiv = document.createElement('div');
            nodoDiv.className = 'nodo nodo-estrategia nodo-aparecer';
            nodoDiv.id = `estrategia-${estrategia.id}`;
            nodoDiv.dataset.estrategiaId = estrategia.id;
            nodoDiv.dataset.ejeId = estrategia.eje_id;
            nodoDiv.dataset.tipo = 'estrategia';
            nodoDiv.style.left = `${x}px`;
            nodoDiv.style.top = `${y}px`;
            nodoDiv.style.transform = 'translate(-50%, -50%)';
            nodoDiv.style.animationDelay = `${index * 0.05 + 0.5}s`;
            
            let tipoTexto = '';
            switch(estrategia.tipo_cruce) {
                case 'FO': tipoTexto = 'FORTALEZA + OPORTUNIDAD'; break;
                case 'DO': tipoTexto = 'DEBILIDAD + OPORTUNIDAD'; break;
                case 'FA': tipoTexto = 'FORTALEZA + AMENAZA'; break;
                case 'DA': tipoTexto = 'DEBILIDAD + AMENAZA'; break;
                default: tipoTexto = estrategia.tipo_cruce;
            }
            
            nodoDiv.innerHTML = `
                <div class="nodo-content">
                    <div class="nodo-icon">
                        <i class="fas fa-chess-board"></i>
                    </div>
                    <div class="nodo-title">${tipoTexto}</div>
                    <div class="nodo-counter">${estrategia.eje_texto || eje.nombre}</div>
                </div>
            `;
            
            estrategiasContainer.appendChild(nodoDiv);
            
            // Agregar eventos
            nodoDiv.addEventListener('click', function(e) {
                e.stopPropagation();
                seleccionarNodo(this.id);
                mostrarDetallesEstrategia(estrategia.id);
            });
            
            // Crear conexión con el eje
            mapa.conexiones.push({
                id: `conexion-${eje.id}-estrategia-${estrategia.id}`,
                tipo: 'estrategia',
                sourceId: `nodo-${eje.id}`,
                targetId: `estrategia-${estrategia.id}`,
                color: '#2ecc71'
            });
            
            // Crear nodos de tácticas para esta estrategia
            crearNodosTacticas(estrategia.id, x, y);
        });
        
        actualizarContadoresEjes();
    }
    
    function crearNodosTacticas(estrategiaId, estrategiaX, estrategiaY) {
        const tacticasContainer = document.getElementById('tacticasContainer');
        const tacticas = mapa.tacticas.filter(t => t.estrategia_id === estrategiaId);
        
        if (tacticas.length === 0) return;
        
        tacticas.forEach((tactica, index) => {
            const angulo = (2 * Math.PI / tacticas.length) * index;
            const radio = 130;
            
            let x = estrategiaX + radio * Math.cos(angulo);
            let y = estrategiaY + radio * Math.sin(angulo);
            
            // Verificar colisión
            const posicionAjustada = verificarColision(x, y, 120, 'nodo-tactica');
            x = posicionAjustada.x;
            y = posicionAjustada.y;
            
            const nodoDiv = document.createElement('div');
            nodoDiv.className = 'nodo nodo-tactica nodo-aparecer';
            nodoDiv.id = `tactica-${tactica.id}`;
            nodoDiv.dataset.tacticaId = tactica.id;
            nodoDiv.dataset.estrategiaId = estrategiaId;
            nodoDiv.dataset.tipo = 'tactica';
            nodoDiv.style.left = `${x}px`;
            nodoDiv.style.top = `${y}px`;
            nodoDiv.style.transform = 'translate(-50%, -50%)';
            nodoDiv.style.animationDelay = `${index * 0.05 + 1}s`;
            
            nodoDiv.innerHTML = `
                <div class="nodo-content">
                    <div class="nodo-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="nodo-title">${tactica.nombre.substring(0, 30)}${tactica.nombre.length > 30 ? '...' : ''}</div>
                </div>
            `;
            
            tacticasContainer.appendChild(nodoDiv);
            
            // Agregar eventos
            nodoDiv.addEventListener('click', function(e) {
                e.stopPropagation();
                seleccionarNodo(this.id);
                mostrarDetallesTactica(tactica.id);
            });
            
            // Crear conexión con la estrategia
            mapa.conexiones.push({
                id: `conexion-estrategia-${estrategiaId}-tactica-${tactica.id}`,
                tipo: 'tactica',
                sourceId: `estrategia-${estrategiaId}`,
                targetId: `tactica-${tactica.id}`,
                color: '#e74c3c'
            });
            
            // Crear nodos de actividades para esta táctica
            crearNodosActividades(tactica.id, x, y);
        });
    }
    
    function crearNodosActividades(tacticaId, tacticaX, tacticaY) {
        const actividadesContainer = document.getElementById('actividadesContainer');
        const actividades = mapa.actividades.filter(a => a.tactica_id === tacticaId);
        
        if (actividades.length === 0) return;
        
        actividades.forEach((actividad, index) => {
            const angulo = (2 * Math.PI / actividades.length) * index;
            const radio = 90;
            
            let x = tacticaX + radio * Math.cos(angulo);
            let y = tacticaY + radio * Math.sin(angulo);
            
            // Verificar colisión
            const posicionAjustada = verificarColision(x, y, 100, 'nodo-actividad');
            x = posicionAjustada.x;
            y = posicionAjustada.y;
            
            const nodoDiv = document.createElement('div');
            nodoDiv.className = 'nodo nodo-actividad nodo-aparecer';
            nodoDiv.id = `actividad-${actividad.id}`;
            nodoDiv.dataset.actividadId = actividad.id;
            nodoDiv.dataset.tacticaId = tacticaId;
            nodoDiv.dataset.tipo = 'actividad';
            nodoDiv.style.left = `${x}px`;
            nodoDiv.style.top = `${y}px`;
            nodoDiv.style.transform = 'translate(-50%, -50%)';
            nodoDiv.style.animationDelay = `${index * 0.05 + 1.5}s`;
            
            let estadoIcono = 'fa-clock';
            let estadoColor = '#f39c12';
            switch(actividad.estado) {
                case 'completada':
                    estadoIcono = 'fa-check-circle';
                    estadoColor = '#2ecc71';
                    break;
                case 'en_progreso':
                    estadoIcono = 'fa-spinner';
                    estadoColor = '#3498db';
                    break;
            }
            
            nodoDiv.innerHTML = `
                <div class="nodo-content">
                    <div class="nodo-icon" style="background: linear-gradient(135deg, ${estadoColor}, ${oscurecerColor(estadoColor, 20)})">
                        <i class="fas ${estadoIcono}"></i>
                    </div>
                    <div class="nodo-title">${actividad.nombre.substring(0, 20)}${actividad.nombre.length > 20 ? '...' : ''}</div>
                </div>
            `;
            
            actividadesContainer.appendChild(nodoDiv);
            
            // Agregar eventos
            nodoDiv.addEventListener('click', function(e) {
                e.stopPropagation();
                seleccionarNodo(this.id);
                mostrarDetallesActividad(actividad.id);
            });
            
            // Crear conexión con la táctica
            mapa.conexiones.push({
                id: `conexion-tactica-${tacticaId}-actividad-${actividad.id}`,
                tipo: 'actividad',
                sourceId: `tactica-${tacticaId}`,
                targetId: `actividad-${actividad.id}`,
                color: estadoColor
            });
        });
    }
    
    function crearConexionesJerarquicas() {
        // Las conexiones ya se crearon al crear los nodos
        actualizarEstadisticas();
        dibujarConexiones();
    }
    
    function actualizarContadoresEjes() {
        mapa.ejes.forEach(eje => {
            const count = mapa.estrategias.filter(e => e.eje_id === eje.id).length;
            const counterElement = document.getElementById(`counter-${eje.id}`);
            if (counterElement) {
                counterElement.textContent = `${count} estrategias`;
            }
        });
    }
    
    function actualizarEstadisticas() {
        const totalEjes = mapa.ejes.length;
        const totalEstrategias = mapa.estrategias.length;
        const totalTacticas = mapa.tacticas.length;
        const totalActividades = mapa.actividades.length;
        const totalConexiones = mapa.conexiones.length;
        const totalNodos = totalEjes + totalEstrategias + totalTacticas + totalActividades + 1; // +1 por el objetivo
        
        document.getElementById('total-ejes').textContent = `${totalEjes} Ejes`;
        document.getElementById('total-estrategias').textContent = `${totalEstrategias} Estrategias`;
        document.getElementById('total-tacticas').textContent = `${totalTacticas} Tácticas`;
        document.getElementById('total-actividades').textContent = `${totalActividades} Actividades`;
        document.getElementById('total-conexiones').textContent = `${totalConexiones} Conexiones`;
        document.getElementById('contador-ejes').textContent = totalEjes;
        document.getElementById('contador-estrategias').textContent = totalEstrategias;
        document.getElementById('contador-tacticas').textContent = totalTacticas;
        document.getElementById('contador-actividades').textContent = totalActividades;
        document.getElementById('leyenda-activos').textContent = totalNodos;
        document.getElementById('leyenda-conexiones').textContent = totalConexiones;
    }
    
    // Funciones de animación y visualización
    function animarEntrada() {
        const todosNodos = document.querySelectorAll('.nodo');
        todosNodos.forEach((nodo, index) => {
            nodo.classList.add('nodo-aparecer');
            nodo.style.animationDelay = `${index * 0.02}s`;
        });
        
        // Efecto de onda desde el centro
        setTimeout(crearOndaCentro, 500);
    }
    
    function crearOndaCentro() {
        const canvas = document.getElementById('mapaCanvas');
        const onda = document.createElement('div');
        onda.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid rgba(52, 152, 219, 0.5);
            z-index: 0;
            pointer-events: none;
        `;
        
        canvas.appendChild(onda);
        
        let size = 10;
        const animacion = setInterval(() => {
            size += 20;
            onda.style.width = `${size}px`;
            onda.style.height = `${size}px`;
            onda.style.opacity = 1 - (size / 500);
            
            if (size > 500) {
                clearInterval(animacion);
                onda.remove();
            }
        }, 20);
    }
    
    function seleccionarNodo(nodoId) {
        if (config.nodoSeleccionado) {
            config.nodoSeleccionado.classList.remove('seleccionado');
        }
        
        config.nodoSeleccionado = document.getElementById(nodoId);
        if (config.nodoSeleccionado) {
            config.nodoSeleccionado.classList.add('seleccionado');
            config.nodoSeleccionado.style.zIndex = '1000';
        }
    }
    
    // Funciones de UI
    function mostrarDetallesEje(ejeId) {
        const panel = document.getElementById('panelDetalles');
        const titulo = document.getElementById('detalleTitulo');
        const contenido = document.getElementById('detalleContenido');
        
        const eje = mapa.ejes.find(e => e.id === ejeId);
        if (!eje) return;
        
        const estrategiasEje = mapa.estrategias.filter(e => e.eje_id === ejeId);
        const tacticasEje = mapa.tacticas.filter(t => t.eje_id === ejeId);
        
        titulo.innerHTML = `<i class="fas fa-${eje.icono}"></i> ${eje.nombre}`;
        
        let estrategiasHTML = '';
        if (estrategiasEje.length > 0) {
            estrategiasHTML = `
                <div class="seccion-detalles">
                    <h4><i class="fas fa-chess-board"></i> Estrategias (${estrategiasEje.length})</h4>
                    ${estrategiasEje.map(estrategia => `
                        <div class="item-detalle" onclick="mostrarDetallesEstrategia(${estrategia.id})">
                            <div class="item-tipo ${estrategia.tipo_cruce.toLowerCase()}">${estrategia.tipo_cruce}</div>
                            <div class="item-texto">${estrategia.estrategia}</div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        let tacticasHTML = '';
        if (tacticasEje.length > 0) {
            tacticasHTML = `
                <div class="seccion-detalles">
                    <h4><i class="fas fa-tasks"></i> Tácticas (${tacticasEje.length})</h4>
                    ${tacticasEje.map(tactica => `
                        <div class="item-detalle" onclick="mostrarDetallesTactica(${tactica.id})">
                            <div class="item-texto">${tactica.nombre}</div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        contenido.innerHTML = `
            <div class="detalle-eje">
                <div class="encabezado-detalle" style="background: linear-gradient(135deg, ${eje.color}, ${oscurecerColor(eje.color, 20)});">
                    <div class="icono-grande">
                        <i class="fas fa-${eje.icono}"></i>
                    </div>
                    <h3>${eje.nombre}</h3>
                    <p>${eje.descripcion}</p>
                </div>
                
                <div class="estadisticas-detalle">
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${estrategiasEje.length}</div>
                        <div class="estadistica-label">Estrategias</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${tacticasEje.length}</div>
                        <div class="estadistica-label">Tácticas</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${mapa.actividades.filter(a => mapa.tacticas.find(t => t.id === a.tactica_id && t.eje_id === ejeId)).length}</div>
                        <div class="estadistica-label">Actividades</div>
                    </div>
                </div>
                
                ${estrategiasHTML}
                ${tacticasHTML}
            </div>
            
            <style>
                .encabezado-detalle {
                    padding: 30px;
                    border-radius: 15px;
                    margin-bottom: 20px;
                    text-align: center;
                    color: white;
                }
                
                .icono-grande {
                    width: 80px;
                    height: 80px;
                    background: rgba(255,255,255,0.2);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 15px;
                    font-size: 32px;
                }
                
                .encabezado-detalle h3 {
                    font-size: 24px;
                    margin-bottom: 10px;
                }
                
                .encabezado-detalle p {
                    opacity: 0.9;
                    font-size: 14px;
                }
                
                .estadisticas-detalle {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 15px;
                    margin-bottom: 25px;
                }
                
                .estadistica-item {
                    background: rgba(255,255,255,0.05);
                    border-radius: 10px;
                    padding: 15px;
                    text-align: center;
                }
                
                .estadistica-valor {
                    font-size: 28px;
                    font-weight: bold;
                    color: white;
                    margin-bottom: 5px;
                }
                
                .estadistica-label {
                    font-size: 12px;
                    color: rgba(255,255,255,0.7);
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .seccion-detalles {
                    margin-bottom: 25px;
                }
                
                .seccion-detalles h4 {
                    font-size: 16px;
                    color: white;
                    margin-bottom: 15px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                
                .item-detalle {
                    background: rgba(255,255,255,0.05);
                    border-radius: 10px;
                    padding: 15px;
                    margin-bottom: 10px;
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    border-left: 4px solid ${eje.color};
                }
                
                .item-detalle:hover {
                    background: rgba(255,255,255,0.1);
                    transform: translateX(5px);
                }
                
                .item-tipo {
                    background: ${eje.color};
                    color: white;
                    padding: 4px 10px;
                    border-radius: 15px;
                    font-size: 11px;
                    font-weight: bold;
                    min-width: 40px;
                    text-align: center;
                }
                
                .item-texto {
                    flex: 1;
                    color: rgba(255,255,255,0.9);
                    font-size: 14px;
                }
                
                .item-detalle .fa-chevron-right {
                    color: rgba(255,255,255,0.5);
                    font-size: 12px;
                }
            </style>
        `;
        
        panel.classList.add('open');
    }
    
    function mostrarDetallesEstrategia(estrategiaId) {
        const panel = document.getElementById('panelDetalles');
        const titulo = document.getElementById('detalleTitulo');
        const contenido = document.getElementById('detalleContenido');
        
        const estrategia = mapa.estrategias.find(e => e.id === estrategiaId);
        if (!estrategia) return;
        
        const eje = mapa.ejes.find(e => e.id === estrategia.eje_id);
        const tacticas = mapa.tacticas.filter(t => t.estrategia_id === estrategiaId);
        
        titulo.innerHTML = `<i class="fas fa-chess-board"></i> Estrategia #${estrategiaId}`;
        
        let tipoTexto = '';
        switch(estrategia.tipo_cruce) {
            case 'FO': tipoTexto = 'FORTALEZA + OPORTUNIDAD'; break;
            case 'DO': tipoTexto = 'DEBILIDAD + OPORTUNIDAD'; break;
            case 'FA': tipoTexto = 'FORTALEZA + AMENAZA'; break;
            case 'DA': tipoTexto = 'DEBILIDAD + AMENAZA'; break;
            default: tipoTexto = estrategia.tipo_cruce;
        }
        
        let tacticasHTML = '';
        if (tacticas.length > 0) {
            tacticasHTML = `
                <div class="seccion-detalles">
                    <h4><i class="fas fa-tasks"></i> Tácticas (${tacticas.length})</h4>
                    ${tacticas.map(tactica => `
                        <div class="item-detalle" onclick="mostrarDetallesTactica(${tactica.id})">
                            <div class="item-texto">${tactica.nombre}</div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        contenido.innerHTML = `
            <div class="detalle-estrategia">
                <div class="encabezado-detalle" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                    <div class="icono-grande">
                        <i class="fas fa-chess-board"></i>
                    </div>
                    <div class="badge-eje" style="background: ${eje ? eje.color : '#3498db'}">
                        ${eje ? eje.nombre : 'EJE'}
                    </div>
                    <h3>${tipoTexto}</h3>
                    <p>${estrategia.estrategia}</p>
                </div>
                
                <div class="estadisticas-detalle">
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${tacticas.length}</div>
                        <div class="estadistica-label">Tácticas</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${mapa.actividades.filter(a => tacticas.find(t => t.id === a.tactica_id)).length}</div>
                        <div class="estadistica-label">Actividades</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${tacticas.filter(t => mapa.actividades.filter(a => a.tactica_id === t.id && a.estado === 'completada').length > 0).length}</div>
                        <div class="estadistica-label">En progreso</div>
                    </div>
                </div>
                
                ${tacticasHTML}
                
                <button class="btn-accion" onclick="seleccionarNodo('nodo-${estrategia.eje_id}')">
                    <i class="fas fa-arrow-up"></i> Ver eje padre: ${eje ? eje.nombre : 'Eje'}
                </button>
            </div>
            
            <style>
                .badge-eje {
                    display: inline-block;
                    padding: 5px 15px;
                    background: ${eje ? eje.color : '#3498db'};
                    color: white;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-bottom: 15px;
                }
                
                .btn-accion {
                    width: 100%;
                    padding: 12px;
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.2);
                    color: white;
                    border-radius: 10px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                    font-size: 14px;
                    transition: all 0.3s ease;
                    margin-top: 20px;
                }
                
                .btn-accion:hover {
                    background: rgba(255,255,255,0.2);
                    transform: translateY(-2px);
                }
            </style>
        `;
        
        panel.classList.add('open');
    }
    
    function mostrarDetallesTactica(tacticaId) {
        const panel = document.getElementById('panelDetalles');
        const titulo = document.getElementById('detalleTitulo');
        const contenido = document.getElementById('detalleContenido');
        
        const tactica = mapa.tacticas.find(t => t.id === tacticaId);
        if (!tactica) return;
        
        const estrategia = mapa.estrategias.find(e => e.id === tactica.estrategia_id);
        const actividades = mapa.actividades.filter(a => a.tactica_id === tacticaId);
        
        titulo.innerHTML = `<i class="fas fa-tasks"></i> Táctica #${tacticaId}`;
        
        let actividadesHTML = '';
        if (actividades.length > 0) {
            actividadesHTML = `
                <div class="seccion-detalles">
                    <h4><i class="fas fa-check-circle"></i> Actividades (${actividades.length})</h4>
                    ${actividades.map(actividad => {
                        let estadoIcono = 'fa-clock';
                        let estadoColor = '#f39c12';
                        let estadoTexto = 'Pendiente';
                        
                        switch(actividad.estado) {
                            case 'completada':
                                estadoIcono = 'fa-check-circle';
                                estadoColor = '#2ecc71';
                                estadoTexto = 'Completada';
                                break;
                            case 'en_progreso':
                                estadoIcono = 'fa-spinner';
                                estadoColor = '#3498db';
                                estadoTexto = 'En progreso';
                                break;
                        }
                        
                        return `
                            <div class="item-detalle" onclick="mostrarDetallesActividad(${actividad.id})">
                                <div class="item-estado" style="background: ${estadoColor}">
                                    <i class="fas ${estadoIcono}"></i>
                                </div>
                                <div class="item-texto">${actividad.nombre}</div>
                                <div class="item-badge" style="color: ${estadoColor}">${estadoTexto}</div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        contenido.innerHTML = `
            <div class="detalle-tactica">
                <div class="encabezado-detalle" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                    <div class="icono-grande">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <h3>${tactica.nombre}</h3>
                    <p>Táctica de la estrategia: ${estrategia ? estrategia.estrategia.substring(0, 50) + '...' : 'No especificada'}</p>
                </div>
                
                <div class="estadisticas-detalle">
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${actividades.length}</div>
                        <div class="estadistica-label">Actividades</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${actividades.filter(a => a.estado === 'completada').length}</div>
                        <div class="estadistica-label">Completadas</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${actividades.filter(a => a.estado === 'en_progreso').length}</div>
                        <div class="estadistica-label">En progreso</div>
                    </div>
                </div>
                
                ${actividadesHTML}
                
                <button class="btn-accion" onclick="seleccionarNodo('estrategia-${tactica.estrategia_id}')">
                    <i class="fas fa-arrow-up"></i> Ver estrategia padre
                </button>
            </div>
            
            <style>
                .item-estado {
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 14px;
                }
                
                .item-badge {
                    font-size: 11px;
                    padding: 3px 10px;
                    border-radius: 12px;
                    background: rgba(255,255,255,0.1);
                }
            </style>
        `;
        
        panel.classList.add('open');
    }
    
    function mostrarDetallesActividad(actividadId) {
        const panel = document.getElementById('panelDetalles');
        const titulo = document.getElementById('detalleTitulo');
        const contenido = document.getElementById('detalleContenido');
        
        const actividad = mapa.actividades.find(a => a.id === actividadId);
        if (!actividad) return;
        
        const tactica = mapa.tacticas.find(t => t.id === actividad.tactica_id);
        
        let estadoIcono = 'fa-clock';
        let estadoColor = '#f39c12';
        let estadoTexto = 'Pendiente';
        
        switch(actividad.estado) {
            case 'completada':
                estadoIcono = 'fa-check-circle';
                estadoColor = '#2ecc71';
                estadoTexto = 'Completada';
                break;
            case 'en_progreso':
                estadoIcono = 'fa-spinner';
                estadoColor = '#3498db';
                estadoTexto = 'En progreso';
                break;
        }
        
        titulo.innerHTML = `<i class="fas ${estadoIcono}"></i> Actividad #${actividadId}`;
        
        contenido.innerHTML = `
            <div class="detalle-actividad">
                <div class="encabezado-detalle" style="background: linear-gradient(135deg, ${estadoColor}, ${oscurecerColor(estadoColor, 20)});">
                    <div class="icono-grande">
                        <i class="fas ${estadoIcono}"></i>
                    </div>
                    <div class="estado-badge">${estadoTexto}</div>
                    <h3>${actividad.nombre}</h3>
                    <p>Actividad de la táctica: ${tactica ? tactica.nombre.substring(0, 50) + '...' : 'No especificada'}</p>
                </div>
                
                <div class="info-detalle">
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-calendar"></i> Estado
                        </div>
                        <div class="info-value" style="color: ${estadoColor}">
                            ${estadoTexto}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-layer-group"></i> Jerarquía
                        </div>
                        <div class="info-value">
                            ${tactica ? 
                                `Táctica → Actividad` : 
                                `Actividad independiente`
                            }
                        </div>
                    </div>
                </div>
                
                <div class="acciones-detalle">
                    <button class="btn-accion" onclick="cambiarEstadoActividad(${actividadId}, 'pendiente')" style="background: ${actividad.estado === 'pendiente' ? estadoColor : 'rgba(255,255,255,0.1)'}">
                        <i class="fas fa-clock"></i> Pendiente
                    </button>
                    <button class="btn-accion" onclick="cambiarEstadoActividad(${actividadId}, 'en_progreso')" style="background: ${actividad.estado === 'en_progreso' ? estadoColor : 'rgba(255,255,255,0.1)'}">
                        <i class="fas fa-spinner"></i> En progreso
                    </button>
                    <button class="btn-accion" onclick="cambiarEstadoActividad(${actividadId}, 'completada')" style="background: ${actividad.estado === 'completada' ? estadoColor : 'rgba(255,255,255,0.1)'}">
                        <i class="fas fa-check-circle"></i> Completada
                    </button>
                </div>
                
                <button class="btn-accion" onclick="seleccionarNodo('tactica-${actividad.tactica_id}')">
                    <i class="fas fa-arrow-up"></i> Ver táctica padre
                </button>
            </div>
            
            <style>
                .estado-badge {
                    display: inline-block;
                    padding: 8px 20px;
                    background: rgba(255,255,255,0.2);
                    color: white;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: bold;
                    margin-bottom: 15px;
                }
                
                .info-detalle {
                    background: rgba(255,255,255,0.05);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 20px 0;
                }
                
                .info-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px 0;
                    border-bottom: 1px solid rgba(255,255,255,0.1);
                }
                
                .info-item:last-child {
                    border-bottom: none;
                }
                
                .info-label {
                    color: rgba(255,255,255,0.7);
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                
                .info-value {
                    color: white;
                    font-weight: 600;
                }
                
                .acciones-detalle {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 10px;
                    margin: 20px 0;
                }
                
                .acciones-detalle .btn-accion {
                    margin: 0;
                    padding: 10px;
                    font-size: 12px;
                }
            </style>
        `;
        
        panel.classList.add('open');
    }
    
    function cambiarEstadoActividad(actividadId, nuevoEstado) {
        const actividad = mapa.actividades.find(a => a.id === actividadId);
        if (actividad) {
            actividad.estado = nuevoEstado;
            
            // Actualizar nodo visualmente
            const nodoActividad = document.getElementById(`actividad-${actividadId}`);
            if (nodoActividad) {
                let estadoColor = '#f39c12';
                let estadoIcono = 'fa-clock';
                
                switch(nuevoEstado) {
                    case 'completada':
                        estadoColor = '#2ecc71';
                        estadoIcono = 'fa-check-circle';
                        break;
                    case 'en_progreso':
                        estadoColor = '#3498db';
                        estadoIcono = 'fa-spinner';
                        break;
                }
                
                const icono = nodoActividad.querySelector('.nodo-icon');
                if (icono) {
                    icono.style.background = `linear-gradient(135deg, ${estadoColor}, ${oscurecerColor(estadoColor, 20)})`;
                    icono.innerHTML = `<i class="fas ${estadoIcono}"></i>`;
                }
            }
            
            // Actualizar conexión
            const conexion = mapa.conexiones.find(c => c.targetId === `actividad-${actividadId}`);
            if (conexion) {
                conexion.color = estadoColor;
            }
            
            dibujarConexiones();
            mostrarDetallesActividad(actividadId);
            mostrarNotificacion(`Actividad actualizada: ${nuevoEstado}`, 'success');
        }
    }
    
    function mostrarDetallesObjetivo() {
        const panel = document.getElementById('panelDetalles');
        const titulo = document.getElementById('detalleTitulo');
        const contenido = document.getElementById('detalleContenido');
        
        titulo.innerHTML = `<i class="fas fa-brain"></i> Objetivo Estratégico`;
        
        contenido.innerHTML = `
            <div class="detalle-objetivo">
                <div class="encabezado-detalle" style="background: linear-gradient(135deg, #9C27B0, #E91E63);">
                    <div class="icono-grande">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h3>OBJETIVO ESTRATÉGICO</h3>
                    <p>Proyecto El Domo</p>
                </div>
                
                <div class="descripcion-objetivo">
                    <p>Consolidar la viabilidad y el respaldo social del Proyecto El Domo mediante un modelo de gestión integral que garantice la integridad y disponibilidad del recurso hídrico local, asegurando su no afectación por las actividades mineras, a través de la repotenciación de sistemas comunitarios y el monitoreo estricto de su calidad; este compromiso se complementa con la mejora de equipamiento en salud, la intervención en infraestructura sanitaria y lúdica de 4 unidades educativas, la reubicación estratégica de al menos el 60% del personal local hacia nuevos departamentos, y una cooperación técnica con los GADs y niveles distritales, todo dinamizado por un sistema de comunicación comunitaria que transparente la propuesta de valor y los beneficios del proyecto en el AID y AII.</p>
                </div>
                
                <div class="estadisticas-detalle">
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${mapa.ejes.length}</div>
                        <div class="estadistica-label">Ejes Estratégicos</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${mapa.estrategias.length}</div>
                        <div class="estadistica-label">Estrategias</div>
                    </div>
                    <div class="estadistica-item">
                        <div class="estadistica-valor">${mapa.tacticas.length}</div>
                        <div class="estadistica-label">Tácticas</div>
                    </div>
                </div>
                
                <div class="ejes-lista">
                    <h4><i class="fas fa-layer-group"></i> Ejes Estratégicos</h4>
                    ${mapa.ejes.map(eje => `
                        <div class="item-detalle" onclick="mostrarDetallesEje('${eje.id}')">
                            <div class="item-icono" style="background: ${eje.color}">
                                <i class="fas fa-${eje.icono}"></i>
                            </div>
                            <div class="item-texto">${eje.nombre}</div>
                            <div class="item-badge">${mapa.estrategias.filter(e => e.eje_id === eje.id).length} estrategias</div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <style>
                .descripcion-objetivo {
                    background: rgba(255,255,255,0.05);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 20px 0;
                    line-height: 1.6;
                    color: rgba(255,255,255,0.9);
                }
                
                .item-icono {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                }
            </style>
        `;
        
        panel.classList.add('open');
    }
    
    function mostrarDetalleObjetivo() {
        mostrarDetallesObjetivo();
    }
    
    function cerrarPanel() {
        document.getElementById('panelDetalles').classList.remove('open');
        if (config.nodoSeleccionado) {
            config.nodoSeleccionado.classList.remove('seleccionado');
            config.nodoSeleccionado = null;
        }
    }
    
    // Funciones de filtrado
    function aplicarFiltro() {
        config.filtroNivel = document.getElementById('filtro-nivel').value;
        
        const todosNodos = document.querySelectorAll('.nodo');
        const niveles = {
            'objetivo': ['nodo-objetivo'],
            'ejes': ['nodo-eje'],
            'estrategias': ['nodo-estrategia'],
            'tacticas': ['nodo-tactica'],
            'actividades': ['nodo-actividad']
        };
        
        todosNodos.forEach(nodo => {
            const tipo = Array.from(nodo.classList).find(cls => 
                ['nodo-eje', 'nodo-estrategia', 'nodo-tactica', 'nodo-actividad'].includes(cls)
            );
            
            const mostrar = config.filtroNivel === 'todos' || 
                           niveles[config.filtroNivel]?.includes(tipo) ||
                           (config.filtroNivel === 'objetivo' && nodo.id === 'nodo-objetivo');
            
            nodo.style.display = mostrar ? 'block' : 'none';
            nodo.style.opacity = mostrar ? '1' : '0.1';
            nodo.style.pointerEvents = mostrar ? 'auto' : 'none';
        });
        
        // Reaplicar filtro de eje si está activo
        if (config.filtroEje !== 'todos') {
            filtrarPorEje();
        }
        
        // Redibujar conexiones
        dibujarConexiones();
        mostrarNotificacion(`Filtro aplicado: ${config.filtroNivel}`, 'info');
    }
    
    function filtrarPorEje() {
        config.filtroEje = document.getElementById('filtro-eje').value;
        
        if (config.filtroEje === 'todos') {
            // Mostrar todos los nodos según el filtro de nivel
            aplicarFiltro();
            return;
        }
        
        const todosNodos = document.querySelectorAll('.nodo');
        
        todosNodos.forEach(nodo => {
            const ejeId = nodo.dataset.ejeId;
            
            if (nodo.id === 'nodo-objetivo') {
                // El objetivo siempre visible
                nodo.style.opacity = '1';
                nodo.style.pointerEvents = 'auto';
                nodo.style.display = 'block';
            } else if (ejeId === config.filtroEje) {
                // Mostrar nodos del eje seleccionado
                nodo.style.opacity = '1';
                nodo.style.pointerEvents = 'auto';
                nodo.style.display = 'block';
            } else if (nodo.classList.contains('nodo-eje') && nodo.id === `nodo-${config.filtroEje}`) {
                // Mostrar el eje seleccionado
                nodo.style.opacity = '1';
                nodo.style.pointerEvents = 'auto';
                nodo.style.display = 'block';
            } else if (nodo.id === 'nodo-objetivo') {
                // El objetivo siempre visible
                nodo.style.opacity = '1';
                nodo.style.pointerEvents = 'auto';
                nodo.style.display = 'block';
            } else {
                // Ocultar otros nodos
                nodo.style.opacity = '0.1';
                nodo.style.pointerEvents = 'none';
                nodo.style.display = 'block';
            }
        });
        
        // Resaltar el eje seleccionado
        const ejeSeleccionado = document.getElementById(`nodo-${config.filtroEje}`);
        if (ejeSeleccionado) {
            if (config.nodoSeleccionado) {
                config.nodoSeleccionado.classList.remove('seleccionado');
            }
            ejeSeleccionado.classList.add('seleccionado');
            config.nodoSeleccionado = ejeSeleccionado;
        }
        
        // Redibujar conexiones
        dibujarConexiones();
        mostrarNotificacion(`Mostrando eje: ${config.filtroEje}`, 'info');
    }
    
    // Funciones de control
    function toggleFullscreen() {
        const container = document.getElementById('mapaFullscreen');
        
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => {
                console.log(`Error attempting to enable fullscreen: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }
    
    function resetView() {
        config.zoomLevel = 1;
        config.translateX = 0;
        config.translateY = 0;
        document.getElementById('zoomSlider').value = 1;
        document.getElementById('zoomValue').textContent = '100%';
        actualizarTransformacion();
        mostrarNotificacion('Vista reiniciada', 'success');
    }
    
    function toggleAnimations() {
        config.animacionesActivas = !config.animacionesActivas;
        const icon = document.getElementById('animacionIcon');
        
        if (config.animacionesActivas) {
            icon.className = 'fas fa-pause';
            document.querySelectorAll('.conexion, .nodo-icon-pulse').forEach(elemento => {
                elemento.style.animationPlayState = 'running';
            });
        } else {
            icon.className = 'fas fa-play';
            document.querySelectorAll('.conexion, .nodo-icon-pulse').forEach(elemento => {
                elemento.style.animationPlayState = 'paused';
            });
        }
        
        mostrarNotificacion(`Animaciones ${config.animacionesActivas ? 'activadas' : 'pausadas'}`, 'info');
    }
    
    function cambiarModo(modo) {
        config.modo = modo;
        
        // Actualizar botones
        document.querySelectorAll('.modo-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`modo-${modo}`).classList.add('active');
        
        // Cambiar cursor
        const canvas = document.getElementById('mapaCanvas');
        canvas.style.cursor = modo === 'navegacion' ? 'grab' : 'pointer';
        
        mostrarNotificacion(`Modo: ${modo === 'navegacion' ? 'Navegación' : 'Selección'}`, 'info');
    }
    
    function exportMap() {
        mostrarNotificacion('Preparando exportación del mapa...', 'success');
        
        // En una implementación real, aquí se exportaría el mapa como imagen
        setTimeout(() => {
            mostrarNotificacion('Mapa exportado exitosamente', 'success');
        }, 1500);
    }
    
    function recalcularPosiciones() {
        // Esta función se llama cuando se redimensiona la ventana
        // En una implementación más avanzada, se recalcularían las posiciones de todos los nodos
        dibujarConexiones();
    }
    
    function actualizarMinimap() {
        const minimap = document.getElementById('minimapViewport');
        if (!minimap) return;
        
        const scale = 0.15;
        const viewportWidth = 150 * (1/config.zoomLevel);
        const viewportHeight = 150 * (1/config.zoomLevel);
        const viewportX = -config.translateX * scale + 75;
        const viewportY = -config.translateY * scale + 75;
        
        minimap.style.width = `${viewportWidth}px`;
        minimap.style.height = `${viewportHeight}px`;
        minimap.style.left = `${viewportX}px`;
        minimap.style.top = `${viewportY}px`;
    }
    
    // Funciones de carga
    function mostrarCargando(mensaje, progreso) {
        const overlay = document.getElementById('cargandoOverlay');
        overlay.style.display = 'flex';
        document.getElementById('estadoCarga').textContent = mensaje;
        actualizarProgresoCarga(progreso);
    }
    
    function actualizarProgresoCarga(progreso) {
        document.getElementById('progresoCarga').style.width = `${progreso}%`;
    }
    
    function ocultarCargando() {
        setTimeout(() => {
            const overlay = document.getElementById('cargandoOverlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.style.opacity = '1';
            }, 500);
        }, 500);
    }
    
    function mostrarNotificacion(mensaje, tipo) {
        const notificacion = document.createElement('div');
        notificacion.className = 'notificacion';
        notificacion.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 20px;
            background: ${tipo === 'success' ? 'rgba(46, 204, 113, 0.9)' : 
                         tipo === 'error' ? 'rgba(231, 76, 60, 0.9)' : 
                         'rgba(52, 152, 219, 0.9)'};
            color: white;
            border-radius: 10px;
            font-weight: 600;
            z-index: 4000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        `;
        
        notificacion.innerHTML = `
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : 
                               tipo === 'error' ? 'exclamation-circle' : 
                               'info-circle'}"></i>
            ${mensaje}
        `;
        
        document.body.appendChild(notificacion);
        
        setTimeout(() => {
            notificacion.style.transform = 'translateX(0)';
        }, 10);
        
        setTimeout(() => {
            notificacion.style.transform = 'translateX(150%)';
            setTimeout(() => {
                notificacion.remove();
            }, 300);
        }, 3000);
    }
    
    // Limpiar recursos al salir
    window.addEventListener('beforeunload', function() {
        if (elementos.animacionFrame) {
            cancelAnimationFrame(elementos.animacionFrame);
        }
    });
</script>
{% endblock %}
