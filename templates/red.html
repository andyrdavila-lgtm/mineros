{% extends "inicio.html" %}

{% block content %}
<!-- Sistema de Gestión de Actividades - Vista Optimizada -->
<div class="flow-system-container">
    <!-- Header compacto -->
    <div class="flow-header-compact">
        <div class="header-main">
            <h1>
                <i class="fas fa-project-diagram"></i>
                Mapa de Flujo de Actividades
                <small>Proyecto El Domo - Gestión de Responsables y Tiempos</small>
            </h1>
        </div>
        
        <div class="header-stats-row">
            <div class="stat-item">
                <i class="fas fa-tasks"></i>
                <span id="total-actividades-flow">0</span>
                <span>Actividades</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-user-tie"></i>
                <span id="total-responsables">0</span>
                <span>Responsables</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-calendar-alt"></i>
                <span id="dias-totales">0</span>
                <span>Días</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-check-circle"></i>
                <span id="completadas-flow">0%</span>
                <span>Completado</span>
            </div>
        </div>
    </div>

    <!-- Barra de herramientas principal -->
    <div class="flow-toolbar">
        <div class="toolbar-section">
            <div class="filter-group">
                <select id="filtroResponsable" class="toolbar-select">
                    <option value="todos">Todos los responsables</option>
                </select>
                <select id="filtroEstadoFlow" class="toolbar-select">
                    <option value="todos">Todos los estados</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="en_progreso">En Progreso</option>
                    <option value="completada">Completada</option>
                </select>
                <div class="date-range">
                    <input type="date" id="fechaDesde" class="toolbar-date">
                    <span>a</span>
                    <input type="date" id="fechaHasta" class="toolbar-date">
                </div>
            </div>
        </div>
        
        <div class="toolbar-section">
            <div class="view-toggle-group">
                <button class="view-toggle active" data-view="gantt">
                    <i class="fas fa-chart-bar"></i>
                    <span>Gantt</span>
                </button>
                <button class="view-toggle" data-view="flow">
                    <i class="fas fa-project-diagram"></i>
                    <span>Flujo</span>
                </button>
                <button class="view-toggle" data-view="responsables">
                    <i class="fas fa-user-tie"></i>
                    <span>Responsables</span>
                </button>
                <button class="view-toggle" data-view="timeline">
                    <i class="fas fa-stream"></i>
                    <span>Timeline</span>
                </button>
            </div>
        </div>
        
        <div class="toolbar-section">
            <button class="toolbar-btn" onclick="exportarReporte()">
                <i class="fas fa-file-export"></i>
                Exportar
            </button>
            <button class="toolbar-btn" onclick="imprimirFlujo()">
                <i class="fas fa-print"></i>
                Imprimir
            </button>
            <button class="toolbar-btn" onclick="toggleFullscreenFlow()">
                <i class="fas fa-expand"></i>
                Pantalla Completa
            </button>
        </div>
    </div>

    <!-- Contenido principal - Vista única -->
    <div class="flow-main-view">
        <!-- Vista Gantt -->
        <div class="flow-view active" id="ganttView">
            <div class="view-header">
                <h3><i class="fas fa-chart-bar"></i> Diagrama Gantt</h3>
                <div class="view-controls">
                    <button class="control-btn" onclick="zoomGantt('in')">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button class="control-btn" onclick="zoomGantt('out')">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="control-btn" onclick="ajustarGantt()">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="gantt-main" id="ganttContainer">
                <div class="gantt-timeline" id="ganttTimeline"></div>
                <div class="gantt-rows" id="ganttContent"></div>
            </div>
        </div>

        <!-- Vista Flujo -->
        <div class="flow-view" id="flowView">
            <div class="view-header">
                <h3><i class="fas fa-project-diagram"></i> Diagrama de Flujo</h3>
                <div class="view-controls">
                    <button class="control-btn" onclick="autoOrganizarFlujo()">
                        <i class="fas fa-sitemap"></i>
                        Auto-organizar
                    </button>
                    <button class="control-btn" onclick="descargarDiagrama()">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="flow-canvas-container">
                <svg class="flow-connections" id="flowConnections"></svg>
                <div class="flow-nodes-container" id="flowNodes"></div>
            </div>
        </div>

        <!-- Vista Responsables -->
        <div class="flow-view" id="responsableView">
            <div class="view-header">
                <h3><i class="fas fa-user-tie"></i> Panel de Responsables</h3>
                <div class="view-controls">
                    <button class="control-btn" onclick="actualizarResponsables()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="responsables-grid" id="responsablesContainer"></div>
        </div>

        <!-- Vista Timeline -->
        <div class="flow-view" id="timelineView">
            <div class="view-header">
                <h3><i class="fas fa-stream"></i> Línea de Tiempo</h3>
                <div class="view-controls">
                    <button class="control-btn" onclick="expandirTimeline()">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                </div>
            </div>
            <div class="timeline-content" id="timelineContainer"></div>
        </div>
    </div>

    <!-- Panel de detalles (se activa al seleccionar) -->
    <div class="flow-details-panel" id="detailsPanel">
        <div class="details-header">
            <h3><i class="fas fa-info-circle"></i> Detalles</h3>
            <button class="close-details" onclick="cerrarDetalles()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="details-content" id="detallesContenido">
            <div class="empty-details">
                <i class="fas fa-mouse-pointer"></i>
                <p>Selecciona una actividad para ver los detalles</p>
            </div>
        </div>
    </div>

    <!-- Barra de estado -->
    <div class="flow-status-bar">
        <div class="status-info">
            <span><i class="fas fa-sync-alt"></i> <span id="ultimaActualizacion">Actualizado ahora</span></span>
            <span><i class="fas fa-database"></i> <span id="totalRegistros">0 registros</span></span>
            <span><i class="fas fa-memory"></i> <span id="memoriaUsada">Cargando...</span></span>
        </div>
    </div>
</div>

<style>
/* ===================================
   ESTILOS OPTIMIZADOS PARA ESPACIO
=================================== */

.flow-system-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #0f1b3d 0%, #1a2b5e 100%);
    color: white;
    font-family: 'Segoe UI', system-ui, sans-serif;
    overflow: hidden;
}

/* Header compacto */
.flow-header-compact {
    background: rgba(0, 10, 40, 0.85);
    backdrop-filter: blur(20px);
    padding: 12px 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
}

.header-main h1 {
    font-size: 20px;
    font-weight: 600;
    color: #4fc3f7;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.header-main small {
    font-size: 13px;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.7);
    margin-left: 10px;
}

.header-stats-row {
    display: flex;
    gap: 20px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: rgba(255, 255, 255, 0.9);
}

.stat-item i {
    color: #4fc3f7;
    font-size: 14px;
}

.stat-item span:first-of-type {
    font-weight: 700;
    font-size: 16px;
    color: white;
}

/* Barra de herramientas */
.flow-toolbar {
    background: rgba(0, 15, 50, 0.7);
    padding: 12px 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    gap: 20px;
    flex-shrink: 0;
}

.toolbar-section {
    display: flex;
    align-items: center;
    gap: 12px;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.toolbar-select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: white;
    padding: 6px 12px;
    font-size: 13px;
    min-width: 180px;
}

.date-range {
    display: flex;
    align-items: center;
    gap: 8px;
}

.toolbar-date {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: white;
    padding: 6px 10px;
    font-size: 13px;
    width: 130px;
}

.view-toggle-group {
    display: flex;
    gap: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 4px;
}

.view-toggle {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.view-toggle.active {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.toolbar-btn {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.toolbar-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
}

/* Contenido principal */
.flow-main-view {
    flex: 1;
    position: relative;
    overflow: hidden;
}

.flow-view {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
    flex-direction: column;
    background: rgba(0, 20, 60, 0.6);
    border-radius: 12px;
    margin: 12px;
    overflow: hidden;
}

.flow-view.active {
    display: flex;
}

.view-header {
    padding: 12px 20px;
    background: rgba(0, 30, 80, 0.8);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.view-header h3 {
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.view-controls {
    display: flex;
    gap: 6px;
}

.control-btn {
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* Vista Gantt optimizada */
.gantt-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.gantt-timeline {
    height: 50px;
    background: rgba(0, 30, 80, 0.8);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    padding: 0 20px;
    flex-shrink: 0;
    overflow-x: auto;
}

.gantt-rows {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.gantt-row {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.2s;
}

.gantt-row:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(4px);
}

.gantt-info {
    width: 250px;
    flex-shrink: 0;
    padding-right: 16px;
}

.gantt-bar-container {
    flex: 1;
    height: 24px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}

.gantt-bar {
    height: 100%;
    border-radius: 12px;
    position: absolute;
    top: 0;
    left: 0;
}

/* Vista Flujo optimizada */
.flow-canvas-container {
    flex: 1;
    position: relative;
    overflow: auto;
    background: rgba(0, 0, 0, 0.2);
}

.flow-nodes-container {
    position: relative;
    min-width: 2000px;
    min-height: 2000px;
    padding: 40px;
}

.flow-node {
    position: absolute;
    background: linear-gradient(135deg, #2196F3, #1976D2);
    border-radius: 8px;
    padding: 12px;
    width: 220px;
    cursor: move;
    border: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s;
}

.flow-node:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
}

/* Vista Responsables optimizada */
.responsables-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    padding: 20px;
    overflow-y: auto;
}

.responsable-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
    cursor: pointer;
}

.responsable-card:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-3px);
}

/* Vista Timeline optimizada */
.timeline-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.timeline-event {
    position: relative;
    margin-bottom: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 16px;
    border-left: 4px solid #2196F3;
    cursor: pointer;
    transition: all 0.3s;
}

.timeline-event:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(4px);
}

/* Panel de detalles */
.flow-details-panel {
    position: fixed;
    top: 0;
    right: -400px;
    width: 380px;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(30px);
    border-left: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1000;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
}

.flow-details-panel.open {
    right: 0;
}

.details-header {
    padding: 20px;
    background: rgba(0, 20, 60, 0.5);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.details-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.empty-details {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255, 255, 255, 0.5);
}

/* Barra de estado */
.flow-status-bar {
    height: 36px;
    background: rgba(0, 10, 40, 0.8);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding: 0 24px;
    display: flex;
    align-items: center;
    flex-shrink: 0;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
}

.status-info {
    display: flex;
    gap: 20px;
}

/* Estados de colores */
.estado-pendiente { background: linear-gradient(135deg, #FF9800, #F57C00); }
.estado-progreso { background: linear-gradient(135deg, #2196F3, #1976D2); }
.estado-completado { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
.estado-atrasado { background: linear-gradient(135deg, #F44336, #D32F2F); }

/* Responsive */
@media (max-width: 1200px) {
    .flow-toolbar {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
    }
    
    .toolbar-section {
        justify-content: space-between;
    }
    
    .filter-group {
        flex-wrap: wrap;
    }
    
    .responsables-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    .flow-header-compact {
        padding: 10px 16px;
    }
    
    .header-stats-row {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .flow-toolbar {
        padding: 10px 16px;
    }
    
    .view-toggle span {
        display: none;
    }
    
    .gantt-info {
        width: 200px;
    }
    
    .flow-details-panel {
        width: 100%;
        right: -100%;
    }
}

@media (max-width: 480px) {
    .flow-view {
        margin: 8px;
    }
    
    .view-header {
        padding: 10px;
    }
    
    .gantt-info {
        width: 150px;
    }
    
    .toolbar-select {
        min-width: 140px;
    }
}
</style>

<script>
// ===================================
// SISTEMA DE FLUJO OPTIMIZADO
// ===================================

const FLOW_SYSTEM = {
    actividades: [],
    responsables: new Set(),
    tareas: [],
    filtros: {
        responsable: 'todos',
        estado: 'todos',
        fechaDesde: null,
        fechaHasta: null
    },
    vistaActiva: 'gantt'
};

// ===================================
// INICIALIZACIÓN
// ===================================

document.addEventListener('DOMContentLoaded', function() {
    inicializarSistema();
    cargarDatosIniciales();
});

function inicializarSistema() {
    // Configurar listeners
    document.querySelectorAll('.view-toggle').forEach(btn => {
        btn.addEventListener('click', function() {
            const view = this.dataset.view;
            cambiarVista(view);
        });
    });
    
    document.getElementById('filtroResponsable').addEventListener('change', aplicarFiltros);
    document.getElementById('filtroEstadoFlow').addEventListener('change', aplicarFiltros);
    document.getElementById('fechaDesde').addEventListener('change', aplicarFiltros);
    document.getElementById('fechaHasta').addEventListener('change', aplicarFiltros);
    
    // Configurar fechas por defecto
    const hoy = new Date();
    const haceUnMes = new Date();
    haceUnMes.setMonth(hoy.getMonth() - 1);
    
    document.getElementById('fechaDesde').value = haceUnMes.toISOString().split('T')[0];
    document.getElementById('fechaHasta').value = hoy.toISOString().split('T')[0];
    
    // Iniciar monitoreo
    setInterval(monitorearMemoria, 10000);
}

function cargarDatosIniciales() {
    // Cargar datos desde API
    Promise.all([
        fetch('/api/actividades').then(r => r.json()),
        fetch('/api/tareas').then(r => r.json())
    ]).then(([actividadesData, tareasData]) => {
        if (actividadesData.success) {
            FLOW_SYSTEM.actividades = actividadesData.actividades;
        }
        if (tareasData.success) {
            FLOW_SYSTEM.tareas = tareasData.tareas;
        }
        
        procesarDatos();
        actualizarUI();
        renderizarVistaActiva();
        
        document.getElementById('ultimaActualizacion').textContent = 
            'Actualizado: ' + new Date().toLocaleTimeString();
    }).catch(error => {
        console.error('Error cargando datos:', error);
    });
}

function procesarDatos() {
    // Extraer responsables únicos
    FLOW_SYSTEM.responsables = new Set();
    
    FLOW_SYSTEM.actividades.forEach(a => {
        if (a.responsable) FLOW_SYSTEM.responsables.add(a.responsable);
    });
    
    FLOW_SYSTEM.tareas.forEach(t => {
        if (t.responsable) FLOW_SYSTEM.responsables.add(t.responsable);
    });
    
    // Actualizar filtro de responsables
    const select = document.getElementById('filtroResponsable');
    select.innerHTML = '<option value="todos">Todos los responsables</option>';
    
    FLOW_SYSTEM.responsables.forEach(r => {
        const option = document.createElement('option');
        option.value = r;
        option.textContent = r;
        select.appendChild(option);
    });
}

function actualizarUI() {
    const totalActividades = FLOW_SYSTEM.actividades.length;
    const totalResponsables = FLOW_SYSTEM.responsables.size;
    
    // Calcular días totales
    let diasTotales = 0;
    FLOW_SYSTEM.actividades.forEach(a => {
        if (a.fecha_inicio && a.fecha_fin) {
            const inicio = new Date(a.fecha_inicio);
            const fin = new Date(a.fecha_fin);
            const dias = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24));
            if (dias > 0) diasTotales += dias;
        }
    });
    
    // Calcular completado
    const tareasCompletadas = FLOW_SYSTEM.tareas.filter(t => t.estado === 'completada').length;
    const porcentaje = FLOW_SYSTEM.tareas.length > 0 ? 
        Math.round((tareasCompletadas / FLOW_SYSTEM.tareas.length) * 100) : 0;
    
    // Actualizar estadísticas
    document.getElementById('total-actividades-flow').textContent = totalActividades;
    document.getElementById('total-responsables').textContent = totalResponsables;
    document.getElementById('dias-totales').textContent = diasTotales;
    document.getElementById('completadas-flow').textContent = porcentaje + '%';
    document.getElementById('totalRegistros').textContent = 
        (totalActividades + FLOW_SYSTEM.tareas.length) + ' registros';
}

// ===================================
// GESTIÓN DE VISTAS
// ===================================

function cambiarVista(vista) {
    // Actualizar botones
    document.querySelectorAll('.view-toggle').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-view="${vista}"]`).classList.add('active');
    
    // Ocultar todas las vistas
    document.querySelectorAll('.flow-view').forEach(view => {
        view.classList.remove('active');
    });
    
    // Mostrar vista seleccionada
    document.getElementById(vista + 'View').classList.add('active');
    FLOW_SYSTEM.vistaActiva = vista;
    
    renderizarVistaActiva();
}

function renderizarVistaActiva() {
    const vista = FLOW_SYSTEM.vistaActiva;
    
    switch(vista) {
        case 'gantt':
            renderizarGantt();
            break;
        case 'flow':
            renderizarFlujo();
            break;
        case 'responsables':
            renderizarResponsables();
            break;
        case 'timeline':
            renderizarTimeline();
            break;
    }
}

// ===================================
// VISTA GANTT
// ===================================

function renderizarGantt() {
    const container = document.getElementById('ganttContent');
    const timeline = document.getElementById('ganttTimeline');
    
    if (!container || !timeline) return;
    
    // Filtrar actividades
    const actividades = filtrarActividades();
    
    // Calcular rango de fechas
    const fechas = actividades.flatMap(a => [
        a.fecha_inicio ? new Date(a.fecha_inicio) : null,
        a.fecha_fin ? new Date(a.fecha_fin) : null
    ]).filter(d => d);
    
    const fechaMin = fechas.length ? new Date(Math.min(...fechas)) : new Date();
    const fechaMax = fechas.length ? new Date(Math.max(...fechas)) : new Date();
    fechaMax.setDate(fechaMax.getDate() + 7); // Margen
    
    // Renderizar timeline
    renderizarTimelineGantt(timeline, fechaMin, fechaMax);
    
    // Renderizar filas
    container.innerHTML = '';
    
    actividades.forEach(actividad => {
        const row = document.createElement('div');
        row.className = 'gantt-row';
        row.onclick = () => mostrarDetalles(actividad.id, 'actividad');
        
        const progreso = calcularProgreso(actividad.id);
        const estado = determinarEstado(actividad);
        const posicion = calcularPosicionGantt(
            actividad.fecha_inicio, 
            actividad.fecha_fin, 
            fechaMin, 
            fechaMax
        );
        
        row.innerHTML = `
            <div class="gantt-info">
                <div style="font-weight: 600; margin-bottom: 4px;">${actividad.nombre}</div>
                <div style="font-size: 12px; opacity: 0.8;">
                    ${actividad.responsable || 'Sin responsable'} | 
                    ${actividad.fecha_inicio ? new Date(actividad.fecha_inicio).toLocaleDateString() : 'Sin fecha'}
                </div>
            </div>
            <div class="gantt-bar-container">
                <div class="gantt-bar ${estado}" style="
                    width: ${posicion.ancho}%;
                    left: ${posicion.inicio}%;
                ">
                    <div class="gantt-progreso" style="width: ${progreso}%"></div>
                </div>
            </div>
        `;
        
        container.appendChild(row);
    });
}

function renderizarTimelineGantt(container, fechaMin, fechaMax) {
    const dias = Math.ceil((fechaMax - fechaMin) / (1000 * 60 * 60 * 24));
    container.innerHTML = '';
    
    for (let i = 0; i <= dias; i += 7) { // Semanas
        const fecha = new Date(fechaMin);
        fecha.setDate(fecha.getDate() + i);
        
        const semana = document.createElement('div');
        semana.style.cssText = `
            flex: 0 0 ${100 / (dias / 7)}%;
            padding: 8px;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.1);
        `;
        
        semana.innerHTML = `
            <div style="font-size: 11px; opacity: 0.8;">Sem ${Math.floor(i/7) + 1}</div>
            <div style="font-weight: 600; font-size: 13px;">${fecha.getDate()}/${fecha.getMonth()+1}</div>
        `;
        
        container.appendChild(semana);
    }
}

function calcularPosicionGantt(inicio, fin, min, max) {
    if (!inicio || !fin) return { inicio: 0, ancho: 0 };
    
    const inicioMs = new Date(inicio).getTime();
    const finMs = new Date(fin).getTime();
    const minMs = min.getTime();
    const maxMs = max.getTime();
    const totalMs = maxMs - minMs;
    
    const posInicio = ((inicioMs - minMs) / totalMs) * 100;
    const posAncho = ((finMs - inicioMs) / totalMs) * 100;
    
    return {
        inicio: Math.max(0, posInicio),
        ancho: Math.min(100 - posInicio, Math.max(5, posAncho))
    };
}

// ===================================
// FUNCIONES AUXILIARES
// ===================================

function filtrarActividades() {
    let actividades = FLOW_SYSTEM.actividades;
    
    // Filtrar por responsable
    if (FLOW_SYSTEM.filtros.responsable !== 'todos') {
        actividades = actividades.filter(a => 
            a.responsable === FLOW_SYSTEM.filtros.responsable
        );
    }
    
    // Filtrar por estado
    if (FLOW_SYSTEM.filtros.estado !== 'todos') {
        actividades = actividades.filter(a => {
            const tareasActividad = FLOW_SYSTEM.tareas.filter(t => t.actividad_id == a.id);
            if (tareasActividad.length === 0) return FLOW_SYSTEM.filtros.estado === 'pendiente';
            return tareasActividad.some(t => t.estado === FLOW_SYSTEM.filtros.estado);
        });
    }
    
    // Filtrar por fecha
    if (FLOW_SYSTEM.filtros.fechaDesde) {
        actividades = actividades.filter(a => 
            !a.fecha_inicio || new Date(a.fecha_inicio) >= new Date(FLOW_SYSTEM.filtros.fechaDesde)
        );
    }
    
    if (FLOW_SYSTEM.filtros.fechaHasta) {
        actividades = actividades.filter(a => 
            !a.fecha_fin || new Date(a.fecha_fin) <= new Date(FLOW_SYSTEM.filtros.fechaHasta)
        );
    }
    
    return actividades;
}

function calcularProgreso(actividadId) {
    const tareas = FLOW_SYSTEM.tareas.filter(t => t.actividad_id == actividadId);
    if (tareas.length === 0) return 0;
    
    const completadas = tareas.filter(t => t.estado === 'completada').length;
    return Math.round((completadas / tareas.length) * 100);
}

function determinarEstado(actividad) {
    const progreso = calcularProgreso(actividad.id);
    
    if (progreso === 100) return 'estado-completado';
    if (progreso > 0) return 'estado-progreso';
    
    if (actividad.fecha_fin) {
        const fin = new Date(actividad.fecha_fin);
        if (fin < new Date()) return 'estado-atrasado';
    }
    
    return 'estado-pendiente';
}

function aplicarFiltros() {
    FLOW_SYSTEM.filtros.responsable = document.getElementById('filtroResponsable').value;
    FLOW_SYSTEM.filtros.estado = document.getElementById('filtroEstadoFlow').value;
    FLOW_SYSTEM.filtros.fechaDesde = document.getElementById('fechaDesde').value;
    FLOW_SYSTEM.filtros.fechaHasta = document.getElementById('fechaHasta').value;
    
    actualizarUI();
    renderizarVistaActiva();
}

// ===================================
// FUNCIONALIDADES BÁSICAS
// ===================================

function toggleFullscreenFlow() {
    const elem = document.documentElement;
    if (!document.fullscreenElement) {
        elem.requestFullscreen().catch(console.log);
    } else {
        document.exitFullscreen();
    }
}

function zoomGantt(direccion) {
    const container = document.getElementById('ganttContent');
    const scale = parseFloat(container.style.transform?.replace('scale(', '')?.replace(')', '')) || 1;
    const newScale = direccion === 'in' ? scale * 1.2 : scale * 0.8;
    container.style.transform = `scale(${Math.max(0.5, Math.min(3, newScale))})`;
}

function ajustarGantt() {
    document.getElementById('ganttContent').style.transform = 'scale(1)';
}

function exportarReporte() {
    const data = {
        fecha: new Date().toISOString(),
        actividades: FLOW_SYSTEM.actividades,
        tareas: FLOW_SYSTEM.tareas
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `reporte-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
}

function imprimirFlujo() {
    window.print();
}

function mostrarDetalles(id, tipo) {
    const panel = document.getElementById('detailsPanel');
    const contenido = document.getElementById('detallesContenido');
    
    if (tipo === 'actividad') {
        const actividad = FLOW_SYSTEM.actividades.find(a => a.id == id);
        if (actividad) {
            contenido.innerHTML = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 15px;">${actividad.nombre}</h3>
                    <div style="margin-bottom: 15px;">
                        <strong>Responsable:</strong> ${actividad.responsable || 'No asignado'}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Fechas:</strong> ${actividad.fecha_inicio || 'No definido'} - ${actividad.fecha_fin || 'No definido'}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Descripción:</strong> ${actividad.descripcion || 'Sin descripción'}
                    </div>
                </div>
            `;
        }
    }
    
    panel.classList.add('open');
}

function cerrarDetalles() {
    document.getElementById('detailsPanel').classList.remove('open');
}

function monitorearMemoria() {
    if (performance.memory) {
        const used = Math.round(performance.memory.usedJSHeapSize / 1048576);
        const total = Math.round(performance.memory.totalJSHeapSize / 1048576);
        document.getElementById('memoriaUsada').textContent = `${used}MB / ${total}MB`;
    }
}

// ===================================
// FUNCIONES DE LAS OTRAS VISTAS
// ===================================

function renderizarFlujo() {
    // Implementación básica del diagrama de flujo
    const container = document.getElementById('flowNodes');
    const svg = document.getElementById('flowConnections');
    
    if (!container || !svg) return;
    
    container.innerHTML = '';
    svg.innerHTML = '';
    
    const actividades = filtrarActividades();
    
    actividades.forEach((actividad, index) => {
        const node = document.createElement('div');
        node.className = 'flow-node';
        node.style.cssText = `
            left: ${50 + (index % 4) * 250}px;
            top: ${50 + Math.floor(index / 4) * 150}px;
        `;
        
        const estado = determinarEstado(actividad);
        const progreso = calcularProgreso(actividad.id);
        
        node.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 8px;">${actividad.nombre}</div>
            <div style="font-size: 12px; opacity: 0.9;">
                <div>${actividad.responsable || 'Sin responsable'}</div>
                <div>Progreso: ${progreso}%</div>
            </div>
        `;
        
        node.onclick = () => mostrarDetalles(actividad.id, 'actividad');
        container.appendChild(node);
    });
}

function renderizarResponsables() {
    const container = document.getElementById('responsablesContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    FLOW_SYSTEM.responsables.forEach(responsable => {
        const actividades = FLOW_SYSTEM.actividades.filter(a => a.responsable === responsable);
        const tareas = FLOW_SYSTEM.tareas.filter(t => t.responsable === responsable);
        
        const card = document.createElement('div');
        card.className = 'responsable-card';
        
        card.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; background: #4CAF50; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    ${responsable.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}
                </div>
                <div>
                    <div style="font-weight: 600;">${responsable}</div>
                    <div style="font-size: 12px; opacity: 0.8;">Responsable</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                <div>
                    <div style="font-size: 18px; font-weight: 700;">${actividades.length}</div>
                    <div style="font-size: 11px;">Actividades</div>
                </div>
                <div>
                    <div style="font-size: 18px; font-weight: 700;">${tareas.length}</div>
                    <div style="font-size: 11px;">Tareas</div>
                </div>
                <div>
                    <div style="font-size: 18px; font-weight: 700;">
                        ${tareas.length > 0 ? Math.round((tareas.filter(t => t.estado === 'completada').length / tareas.length) * 100) : 0}%
                    </div>
                    <div style="font-size: 11px;">Completado</div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

function renderizarTimeline() {
    const container = document.getElementById('timelineContainer');
    if (!container) return;
    
    // Combinar eventos de actividades y tareas
    const eventos = [];
    
    FLOW_SYSTEM.actividades.forEach(a => {
        if (a.fecha_inicio) {
            eventos.push({
                tipo: 'actividad',
                nombre: a.nombre,
                fecha: a.fecha_inicio,
                desc: 'Inicio de actividad'
            });
        }
        if (a.fecha_fin) {
            eventos.push({
                tipo: 'actividad',
                nombre: a.nombre,
                fecha: a.fecha_fin,
                desc: 'Fin de actividad'
            });
        }
    });
    
    FLOW_SYSTEM.tareas.forEach(t => {
        if (t.fecha_inicio) {
            eventos.push({
                tipo: 'tarea',
                nombre: t.nombre,
                fecha: t.fecha_inicio,
                desc: 'Inicio de tarea'
            });
        }
    });
    
    // Ordenar por fecha
    eventos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    
    container.innerHTML = '';
    
    eventos.forEach(evento => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'timeline-event';
        
        eventDiv.innerHTML = `
            <div style="font-size: 12px; color: #4fc3f7; margin-bottom: 4px;">
                ${new Date(evento.fecha).toLocaleDateString('es-ES')}
            </div>
            <div style="font-weight: 600; margin-bottom: 4px;">${evento.nombre}</div>
            <div style="font-size: 13px; opacity: 0.8;">${evento.desc}</div>
        `;
        
        container.appendChild(eventDiv);
    });
}

// Funciones placeholder para las otras funcionalidades
function autoOrganizarFlujo() { alert('Organizando diagrama...'); }
function descargarDiagrama() { alert('Descargando diagrama...'); }
function actualizarResponsables() { renderizarResponsables(); }
function expandirTimeline() { alert('Expandiendo timeline...'); }
</script>
{% endblock %}
