# Añade estas rutas después de las existentes

@app.route('/guardar_actividad_fodaext', methods=['POST'])
@login_required
def guardar_actividad_fodaext():
    try:
        data = request.get_json()
        actividad = data.get('actividad', '').strip()
        tipo = data.get('tipo', 'Positivo')
        aspecto = data.get('aspecto', 'ECONOMICO')
        fuente = data.get('fuente', '').strip()
        
        if not actividad:
            return jsonify({'success': False, 'error': 'La actividad es obligatoria'})
        
        # Crear nuevo registro
        nuevo_aspecto = AspectoAmbiental(
            actividad=actividad,
            tipo=tipo,
            aspecto=aspecto,
            fuente=fuente,
            created_by='fodaext'  # Siempre fodaext para esta página
        )
        
        db.session.add(nuevo_aspecto)
        db.session.commit()
        
        return jsonify({'success': True, 'id': nuevo_aspecto.id})
        
    except Exception as e:
        db.session.rollback()
        print(f"Error al guardar actividad fodaext: {e}")
        return jsonify({'success': False, 'error': str(e)})

@app.route('/fodaext', methods=['GET', 'POST'])
@login_required
def fodaext():
    if request.method == 'POST':
        # Manejo del formulario tradicional (si aún existe)
        actividad = request.form.get('actividad', '').strip()
        tipo = request.form.get('tipo', 'Positivo')
        aspecto = request.form.get('aspecto', 'ECONOMICO')
        fuente = request.form.get('fuente', '').strip()
        
        if actividad:
            nuevo_aspecto = AspectoAmbiental(
                actividad=actividad,
                tipo=tipo,
                aspecto=aspecto,
                fuente=fuente,
                created_by='fodaext'
            )
            db.session.add(nuevo_aspecto)
            db.session.commit()
        
        return redirect(url_for('fodaext'))
    
    # GET request - obtener datos para mostrar
    try:
        # Obtener historial de actividades (últimas 20)
        historial_actividades = AspectoAmbiental.query.filter_by(
            created_by='fodaext'
        ).order_by(
            AspectoAmbiental.created_at.desc()
        ).limit(20).all()
        
        # Obtener todas las actividades agrupadas por aspecto
        todas_actividades = AspectoAmbiental.query.filter_by(
            created_by='fodaext'
        ).order_by(
            AspectoAmbiental.aspecto,
            AspectoAmbiental.created_at.desc()
        ).all()
        
        # Organizar por aspecto en el orden especificado
        orden_aspectos = ['POLITICO', 'ECONOMICO', 'SOCIAL', 'TECNOLOGICO', 'ECOLOGICO', 'LEGAL']
        actividades_por_aspecto = {aspecto: [] for aspecto in orden_aspectos}
        
        for actividad in todas_actividades:
            if actividad.aspecto in actividades_por_aspecto:
                actividades_por_aspecto[actividad.aspecto].append(actividad)
        
        return render_template('fodaext.html', 
                             historial_actividades=historial_actividades,
                             actividades_por_aspecto=actividades_por_aspecto)
        
    except Exception as e:
        print(f"Error al cargar datos fodaext: {e}")
        return render_template('fodaext.html', 
                             historial_actividades=[],
                             actividades_por_aspecto={})
